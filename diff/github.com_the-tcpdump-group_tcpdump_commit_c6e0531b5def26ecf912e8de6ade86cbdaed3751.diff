From c6e0531b5def26ecf912e8de6ade86cbdaed3751 Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Feb 2017 15:52:24 -0800
Subject: [PATCH] CVE-2017-12899/DECnet: Fix bounds checking.

If we're skipping over padding before the *real* flags, check whether
the real flags are in the captured data before fetching it.  This fixes
a buffer over-read discovered by Kamil Frankowicz.

Note one place where we don't need to do bounds checking as it's already
been done.

Add a test using the capture file supplied by the reporter(s).
---
 print-decnet.c         |   2 ++
 tests/TESTLIST         |   1 +
 tests/decnet-oobr.out  |   4 ++++
 tests/decnet-oobr.pcap | Bin 0 -> 214 bytes
 4 files changed, 7 insertions(+)
 create mode 100644 tests/decnet-oobr.out
 create mode 100644 tests/decnet-oobr.pcap

diff --git a/print-decnet.c b/print-decnet.c
index 88aa9e3ef..de7de2758 100644
--- a/print-decnet.c
+++ b/print-decnet.c
@@ -542,6 +542,7 @@ decnet_print(netdissect_options *ndo,
 	    length -= padlen;
 	    caplen -= padlen;
 	    rhp = (const union routehdr *)&(ap[sizeof(short)]);
+	    ND_TCHECK(rhp->rh_short.sh_flags);
 	    mflags = EXTRACT_LE_8BITS(rhp->rh_short.sh_flags);
 	}
 
@@ -613,6 +614,7 @@ print_decnet_ctlmsg(netdissect_options *ndo,
                     register const union routehdr *rhp, u_int length,
                     u_int caplen)
 {
+	/* Our caller has already checked for mflags */
 	int mflags = EXTRACT_LE_8BITS(rhp->rh_short.sh_flags);
 	register const union controlmsg *cmp = (const union controlmsg *)rhp;
 	int src, dst, info, blksize, eco, ueco, hello, other, vers;
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 248c53973..5e3ea8d51 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -444,6 +444,7 @@ hoobr_safeputs		hoobr_safeputs.pcap		hoobr_safeputs.out
 isakmp-rfc3948-oobr	isakmp-rfc3948-oobr.pcap	isakmp-rfc3948-oobr.out
 isoclns-oobr		isoclns-oobr.pcap		isoclns-oobr.out
 nfs-attr-oobr		nfs-attr-oobr.pcap		nfs-attr-oobr.out
+decnet-oobr		decnet-oobr.pcap		decnet-oobr.out
 
 # bad packets from Wilfried Kirsch
 slip-bad-direction	slip-bad-direction.pcap		slip-bad-direction.out	-ve
diff --git a/tests/decnet-oobr.out b/tests/decnet-oobr.out
new file mode 100644
index 000000000..c296076e5
--- /dev/null
+++ b/tests/decnet-oobr.out
@@ -0,0 +1,4 @@
+30:30:30:30:30:30 > 30:30:30:30:30:30, ethertype Unknown (0x3030), length 808464432: 
+	0x0000:  3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
+	0x0010:  3030 3030                                0000
+MEDSA 16.6:48: [|decnet]
diff --git a/tests/decnet-oobr.pcap b/tests/decnet-oobr.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..7c09c1ea5e48642556645253c11db68fe9e33ffe
GIT binary patch
literal 214
wcmca|c+)~A1{MYbC{SWxU|?i`a}Dx<e3;w-&{%B0bqnH-1ZD$+E*wq*01KokGXMYp

literal 0
HcmV?d00001

