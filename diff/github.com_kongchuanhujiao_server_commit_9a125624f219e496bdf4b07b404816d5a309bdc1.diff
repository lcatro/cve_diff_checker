From 9a125624f219e496bdf4b07b404816d5a309bdc1 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E5=8D=83=E6=A9=98=20=E9=9B=AB=E9=9C=9E?=
 <i@qianjunakasumi.ren>
Date: Tue, 16 Mar 2021 19:18:48 +0800
Subject: [PATCH] =?UTF-8?q?=E9=87=8D=E6=9E=84=EF=BC=9A=E4=BC=98=E5=8C=96?=
 =?UTF-8?q?=E9=AA=8C=E8=AF=81=E7=A0=81=E7=94=9F=E6=88=90=E9=80=BB=E8=BE=91?=
 =?UTF-8?q?=EF=BC=8C=E6=9C=80=E5=B0=8F=E5=8C=96=E6=9D=83=E8=B4=A3?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 internal/app/datahub/pkg/account/memory.go    | 40 +++++++++++++++----
 internal/app/kongchuanhujiao/account/apis.go  |  2 +-
 internal/app/kongchuanhujiao/account/utils.go | 19 +--------
 3 files changed, 34 insertions(+), 27 deletions(-)

diff --git a/internal/app/datahub/pkg/account/memory.go b/internal/app/datahub/pkg/account/memory.go
index cca1457..1e89024 100644
--- a/internal/app/datahub/pkg/account/memory.go
+++ b/internal/app/datahub/pkg/account/memory.go
@@ -1,15 +1,39 @@
 package account
 
-import "github.com/kongchuanhujiao/server/internal/app/datahub/internal/memory"
+import (
+	"math/rand"
+	"strconv"
+	"time"
 
-func GetCode(id string) string {
-	return memory.Code[id]
-}
+	"github.com/kongchuanhujiao/server/internal/app/datahub/internal/memory"
+)
+
+// GenerateCode 写入验证码返回一个验证码
+func GenerateCode(id string) (c string) {
+
+	rand.Seed(time.Now().UnixNano())
+	c = strconv.FormatFloat(rand.Float64(), 'f', -1, 64)[2:6]
 
-func WriteCode(id string, code string) {
-	memory.Code[id] = code
+	memory.Code[id] = c
+
+	go func() {
+		timer := time.NewTimer(5 * time.Minute)
+		defer timer.Stop()
+		<-timer.C
+		deleteCode(id)
+	}()
+
+	return
 }
 
-func DeleteCode(id string) {
-	delete(memory.Code, id)
+// VerifyCode 验证验证码
+func VerifyCode(id string, code string) (ok bool) {
+	if code == memory.Code[id] {
+		ok = true
+		deleteCode(id)
+	}
+	return
 }
+
+// deleteCode 删除验证码
+func deleteCode(id string) { delete(memory.Code, id) }
diff --git a/internal/app/kongchuanhujiao/account/apis.go b/internal/app/kongchuanhujiao/account/apis.go
index c1e53d3..272b259 100644
--- a/internal/app/kongchuanhujiao/account/apis.go
+++ b/internal/app/kongchuanhujiao/account/apis.go
@@ -41,7 +41,7 @@ type PostLoginReq struct {
 // 调用方法：POST apis/accounts/login
 func (a *APIs) PostLogin(v *PostLoginReq) *kongchuanhujiao.Response {
 
-	if v.Code != account.GetCode(v.ID) || v.Code == "" { // FIXME datahub 鉴权
+	if account.VerifyCode(v.ID, v.Code) || v.Code == "" {
 		return kongchuanhujiao.GenerateErrResp(1, "验证码有误")
 	}
 
diff --git a/internal/app/kongchuanhujiao/account/utils.go b/internal/app/kongchuanhujiao/account/utils.go
index da6574c..364432e 100644
--- a/internal/app/kongchuanhujiao/account/utils.go
+++ b/internal/app/kongchuanhujiao/account/utils.go
@@ -2,10 +2,6 @@ package account
 
 import (
 	"errors"
-	"math/rand"
-	"strconv"
-	"time"
-
 	"github.com/kongchuanhujiao/server/internal/app/client"
 	"github.com/kongchuanhujiao/server/internal/app/client/message"
 	"github.com/kongchuanhujiao/server/internal/app/datahub/pkg/account"
@@ -22,27 +18,14 @@ func sendCode(id string) (err error) {
 		logger.Error("发送验证码失败", zap.Error(err))
 		return
 	}
-
 	if len(a) == 0 {
 		return errors.New("账号不存在")
 	}
 
-	rand.Seed(time.Now().UnixNano())
-	c := strconv.FormatFloat(rand.Float64(), 'f', -1, 64)[2:6]
-
 	client.GetClient().SendMessage(
-		message.NewTextMessage("您的验证码是：" + c + "，请勿泄露给他人。有效期5分钟").
+		message.NewTextMessage("您的验证码是：" + account.GenerateCode(id) + "，请勿泄露给他人。有效期5分钟").
 			SetTarget(&message.Target{ID: a[0].QQ}),
 	)
 
-	account.WriteCode(id, c)
-
-	go func() {
-		timer := time.NewTimer(5 * time.Minute)
-		defer timer.Stop()
-		<-timer.C
-		account.DeleteCode(id)
-	}()
-
 	return
 }
