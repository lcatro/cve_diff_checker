From 86326e880d31b328a151d45348c35220baa9a1ff Mon Sep 17 00:00:00 2001
From: Francois-Xavier Le Bail <devel.fx.lebail@orange.fr>
Date: Sun, 8 Oct 2017 13:38:50 +0200
Subject: [PATCH] (for 4.9.3) CVE-2018-14881/BGP: Fix BGP_CAPCODE_RESTART.

Add a bounds check and a comment to bgp_capabilities_print().

This fixes a buffer over-read discovered by Bhargava Shastry,
SecT/TU Berlin.

Add a test using the capture file supplied by the reporter(s).
---
 print-bgp.c                                  |   2 ++
 tests/TESTLIST                               |   1 +
 tests/bgp-bgp_capabilities_print-oobr-1.out  |  27 +++++++++++++++++++
 tests/bgp-bgp_capabilities_print-oobr-1.pcap | Bin 0 -> 274 bytes
 4 files changed, 30 insertions(+)
 create mode 100644 tests/bgp-bgp_capabilities_print-oobr-1.out
 create mode 100644 tests/bgp-bgp_capabilities_print-oobr-1.pcap

diff --git a/print-bgp.c b/print-bgp.c
index c82f1cc7d..1438915a4 100644
--- a/print-bgp.c
+++ b/print-bgp.c
@@ -2351,6 +2351,8 @@ bgp_capabilities_print(netdissect_options *ndo,
                            opt[i+5]));
                     break;
                 case BGP_CAPCODE_RESTART:
+                    /* Restart Flags (4 bits), Restart Time in seconds (12 bits) */
+                    ND_TCHECK_16BITS(opt + i + 2);
                     ND_PRINT((ndo, "\n\t\tRestart Flags: [%s], Restart Time %us",
                            ((opt[i+2])&0x80) ? "R" : "none",
                            EXTRACT_16BITS(opt+i+2)&0xfff));
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 8cc638ddb..b77c01c8f 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -557,6 +557,7 @@ icmp-icmp_print-oobr-1 icmp-icmp_print-oobr-1.pcap icmp-icmp_print-oobr-1.out -v
 icmp-icmp_print-oobr-2 icmp-icmp_print-oobr-2.pcap icmp-icmp_print-oobr-2.out -v -c3
 rsvp-rsvp_obj_print-oobr rsvp-rsvp_obj_print-oobr.pcap rsvp-rsvp_obj_print-oobr.out -v -c3
 vrrp-vrrp_print-oobr vrrp-vrrp_print-oobr.pcap vrrp-vrrp_print-oobr.out -v -c3
+bgp-bgp_capabilities_print-oobr-1 bgp-bgp_capabilities_print-oobr-1.pcap bgp-bgp_capabilities_print-oobr-1.out -v -c1
 # The .pcap file is truncated after the 1st packet.
 hncp_dhcpv6data-oobr	hncp_dhcpv6data-oobr.pcap	hncp_dhcpv6data-oobr.out -v -c1
 hncp_dhcpv4data-oobr	hncp_dhcpv4data-oobr.pcap	hncp_dhcpv4data-oobr.out -v -c1
diff --git a/tests/bgp-bgp_capabilities_print-oobr-1.out b/tests/bgp-bgp_capabilities_print-oobr-1.out
new file mode 100644
index 000000000..48cd19d66
--- /dev/null
+++ b/tests/bgp-bgp_capabilities_print-oobr-1.out
@@ -0,0 +1,27 @@
+IP (tos 0x1f,CE, ttl 254, id 38671, offset 0, flags [+, DF, rsvd], proto TCP (6), length 4135, bad cksum 200 (->1fdd)!)
+    226.219.0.0.179 > 16.233.34.0.100: Flags [SPUE], seq 347537408:347541483, win 511, urg 65535, options [eol], length 4075: BGP [|BGP]
+	Open Message (1), length: 59
+	  Version 255, my AS 65528, Holdtime 4324s, ID 144.8.32.4
+	  Optional parameters, length: 29
+	    Option Unknown (0), length: 0
+	      no decoder for option 0
+	    Option Capabilities Advertisement (2), length: 8
+	      Graceful Restart (64), length: 0
+		Restart Flags: [none], Restart Time 0s
+	      Unknown (0), length: 0
+		no decoder for Capability 0
+	      32-Bit AS Number (65), length: 4
+		 4 Byte AS 2
+	    Option Unknown (0), length: 2
+	      no decoder for option 0
+	    Option Capabilities Advertisement (2), length: 2
+	      Unknown (232), length: 3
+		no decoder for Capability 232
+		0x0000:  0207 04
+	    Option Capabilities Advertisement (2), length: 7
+	      Multiple Routes to a Destination (4), length: 0
+		no decoder for Capability 4
+	      Unknown (8), length: 0
+		no decoder for Capability 8
+	      Route Refresh (Cisco) (128), length: 0
+	      Graceful Restart (64), length: 0[|BGP]
diff --git a/tests/bgp-bgp_capabilities_print-oobr-1.pcap b/tests/bgp-bgp_capabilities_print-oobr-1.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..61a5351b2c25404ec5a720a417a37f419bb2ba7c
GIT binary patch
literal 274
zcmca|c+)~A1{MZMMg|6k28Vn1ffR_zJ1>!ef%`qv3m}`Hf$`LP|KFZXyBe59?rvSd
z!Qd({pgx`d0mDBwCWc4185jg!Dlsr@W=Ij)&cN`jm4SDC7UO>ghX4N=1pYIK|Nq~>
zz@YkHfE8@+wnWDNPyk~9tw6Eqo@bLA6Hrj#PXot$7Qz2aeE%7k8YEa?R?9%FP6aAq
zaM<t%=-@9v6B!I(=E7(OYoHB31fERbP+*Z|U|`~K0BUe#0TN6g@Pe6%orQsep@9J;
OF2x{l_kF@|21Wqbx?|}8

literal 0
HcmV?d00001

