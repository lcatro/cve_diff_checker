From 21d0da227f50ac102de469a13bc5a15d2cc0f895 Mon Sep 17 00:00:00 2001
From: Brock Allen <brockallen@gmail.com>
Date: Tue, 20 Mar 2018 09:01:26 -0400
Subject: [PATCH] encode redirect uri in authorize response

---
 src/Host/web.config                                      | 3 +--
 src/IdentityServer4/Endpoints/Results/AuthorizeResult.cs | 5 ++++-
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/src/Host/web.config b/src/Host/web.config
index 5ec510280..62ff6ec90 100644
--- a/src/Host/web.config
+++ b/src/Host/web.config
@@ -1,5 +1,4 @@
 ï»¿<?xml version="1.0" encoding="utf-8"?>
-
 <!--
 Copyright (c) Brock Allen & Dominick Baier. All rights reserved.
 Licensed under the Apache License, Version 2.0. See LICENSE in the project root for license information.
@@ -12,6 +11,6 @@ Licensed under the Apache License, Version 2.0. See LICENSE in the project root
     <handlers>
       <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModule" resourceType="Unspecified" />
     </handlers>
-    <aspNetCore processPath="%LAUNCHER_PATH%" arguments="%LAUNCHER_ARGS%" stdoutLogEnabled="false" stdoutLogFile=".\logs\stdout" forwardWindowsAuthToken="true" />
+    <aspNetCore processPath="%LAUNCHER_PATH%" arguments="%LAUNCHER_ARGS%" stdoutLogEnabled="false" stdoutLogFile=".\logs\stdout" forwardWindowsAuthToken="true" startupTimeLimit="3600" requestTimeout="23:00:00" />
   </system.webServer>
 </configuration>
\ No newline at end of file
diff --git a/src/IdentityServer4/Endpoints/Results/AuthorizeResult.cs b/src/IdentityServer4/Endpoints/Results/AuthorizeResult.cs
index a2bf1f221..a585aae0c 100644
--- a/src/IdentityServer4/Endpoints/Results/AuthorizeResult.cs
+++ b/src/IdentityServer4/Endpoints/Results/AuthorizeResult.cs
@@ -15,6 +15,7 @@
 using IdentityServer4.Stores;
 using IdentityServer4.ResponseHandling;
 using Microsoft.AspNetCore.Authentication;
+using System.Text.Encodings.Web;
 
 namespace IdentityServer4.Endpoints.Results
 {
@@ -175,7 +176,9 @@ private string GetFormPostHtml()
         {
             var html = FormPostHtml;
 
-            html = html.Replace("{uri}", Response.Request.RedirectUri);
+            var url = Response.Request.RedirectUri;
+            url = HtmlEncoder.Default.Encode(url);
+            html = html.Replace("{uri}", url);
             html = html.Replace("{body}", Response.ToNameValueCollection().ToFormPost());
 
             return html;
