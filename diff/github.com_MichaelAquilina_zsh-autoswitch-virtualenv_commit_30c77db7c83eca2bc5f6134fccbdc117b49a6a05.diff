From d475692ffc0ebe196afd2f1db7a0dfc9c4bfbaff Mon Sep 17 00:00:00 2001
From: Michael Aquilina <michaelaquilina@gmail.com>
Date: Tue, 7 Jan 2020 20:20:32 +0000
Subject: [PATCH 1/2] fix: insecure activation of virtualenvs

See Issue #122
---
 autoswitch_virtualenv.plugin.zsh | 18 +++++++++++++++++-
 tests/test_maybeworkon.zunit     | 12 ++++++++++++
 2 files changed, 29 insertions(+), 1 deletion(-)

diff --git a/autoswitch_virtualenv.plugin.zsh b/autoswitch_virtualenv.plugin.zsh
index d3ce1f5..042c789 100644
--- a/autoswitch_virtualenv.plugin.zsh
+++ b/autoswitch_virtualenv.plugin.zsh
@@ -8,6 +8,20 @@ BOLD="\e[1m"
 NORMAL="\e[0m"
 
 
+function _validated_source() {
+    local target_path="$1"
+
+    if [[ "$target_path" == *'..'* ]]; then
+        printf "AUTOSWITCH WARNING: "
+        printf "target virtualenv contains invalid characters\n"
+        printf "virtualenv activation cancelled\n"
+        return
+    else
+        source "$target_path"
+    fi
+}
+
+
 function _virtual_env_dir() {
     local venv_name="$1"
     local VIRTUAL_ENV_DIR="${AUTOSWITCH_VIRTUAL_ENV_DIR:-$HOME/.virtualenvs}"
@@ -93,7 +107,9 @@ function _maybeworkon() {
         fi
 
         # Much faster to source the activate file directly rather than use the `workon` command
-        source "$venv_dir/bin/activate"
+        local activate_script="$venv_dir/bin/activate"
+
+        _validated_source "$activate_script"
     fi
 }
 
diff --git a/tests/test_maybeworkon.zunit b/tests/test_maybeworkon.zunit
index d5fe659..49ae98d 100644
--- a/tests/test_maybeworkon.zunit
+++ b/tests/test_maybeworkon.zunit
@@ -23,6 +23,18 @@
     rm -rf "$TARGET"
 }
 
+@test '_maybeworkon - do not activate paths which are potentially inscure' {
+    VIRTUAL_ENV=""
+
+    run _maybeworkon "$TARGET/../../../" virtualenv
+
+    assert $state equals 0
+
+    # first line would be the "switching virtualenv: ...."
+    assert "${lines[2]}" same_as "AUTOSWITCH WARNING: target virtualenv contains invalid characters"
+    assert "${lines[3]}" same_as "virtualenv activation cancelled"
+}
+
 @test '_maybeworkon - error message if virtualenv can not be found' {
     VIRTUAL_ENV=""
 

From 05af733177de6411ede9f667462dce739ac29c8f Mon Sep 17 00:00:00 2001
From: Michael Aquilina <michaelaquilina@gmail.com>
Date: Tue, 7 Jan 2020 20:22:10 +0000
Subject: [PATCH 2/2] Bump version to 1.16.0

---
 CHANGELOG.rst                    | 4 ++++
 autoswitch_virtualenv.plugin.zsh | 2 +-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/CHANGELOG.rst b/CHANGELOG.rst
index f7b53af..975a8d5 100644
--- a/CHANGELOG.rst
+++ b/CHANGELOG.rst
@@ -1,6 +1,10 @@
 Changelog
 =========
 
+1.16.0
+------
+* Fix insecure activation of virtualenvs (#122)
+
 1.15.2
 ------
 * Use absolute path for ``/usr/bin/stat`` to prevent conflicts with other ``stat`` binaries. Fixes #110
diff --git a/autoswitch_virtualenv.plugin.zsh b/autoswitch_virtualenv.plugin.zsh
index 042c789..3b0ef5c 100644
--- a/autoswitch_virtualenv.plugin.zsh
+++ b/autoswitch_virtualenv.plugin.zsh
@@ -1,4 +1,4 @@
-export AUTOSWITCH_VERSION="1.15.2"
+export AUTOSWITCH_VERSION="1.16.0"
 export AUTOSWITCH_FILE=".venv"
 
 RED="\e[31m"
