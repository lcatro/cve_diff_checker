From a5f317817da4577d9ff457fea9c96482b3d1df23 Mon Sep 17 00:00:00 2001
From: lacrioque <markus.fluer@limesurvey.org>
Date: Thu, 19 Dec 2019 16:37:11 +0100
Subject: [PATCH] Fixed issue #15681: LimeSurvey 3.21.1 Cross Site Scripting
 Stored

---
 application/views/admin/quotas/_newanswer_equation.php      | 2 +-
 application/views/admin/quotas/newanswer_view.php           | 2 +-
 application/views/admin/quotas/viewquotas_quota_actions.php | 2 +-
 application/views/admin/quotas/viewquotas_quota_members.php | 2 +-
 third_party/vimeo/psalm                                     | 1 +
 5 files changed, 5 insertions(+), 4 deletions(-)
 create mode 160000 third_party/vimeo/psalm

diff --git a/application/views/admin/quotas/_newanswer_equation.php b/application/views/admin/quotas/_newanswer_equation.php
index d38ff3ad14..ad60a1d428 100644
--- a/application/views/admin/quotas/_newanswer_equation.php
+++ b/application/views/admin/quotas/_newanswer_equation.php
@@ -5,7 +5,7 @@
 ?>
 
 <div class='row'>
-    <h2><?php echo sprintf(gT("New answer for quota '%s'"), $oQuota->name);?></h2>
+    <h2><?php echo sprintf(gT("New answer for quota '%s'"), htmlentities($oQuota->name));?></h2>
     <p class="lead"><?php eT("Set equation value");?></p>
     <div class='form-group'>
         <div class='col-sm-5 col-sm-offset-4'>
diff --git a/application/views/admin/quotas/newanswer_view.php b/application/views/admin/quotas/newanswer_view.php
index 6db8304840..234a1ef199 100644
--- a/application/views/admin/quotas/newanswer_view.php
+++ b/application/views/admin/quotas/newanswer_view.php
@@ -13,7 +13,7 @@
 
             <div class="jumbotron message-box">
                 <div class='row'>
-                    <h2><?php echo sprintf(gT("New answer for quota '%s'"), $oQuota->name);?></h2>
+                    <h2><?php echo sprintf(gT("New answer for quota '%s'"), htmlentities($oQuota->name));?></h2>
                     <p class="lead">
                         <?php eT("Select question");?>:
                     </p>
diff --git a/application/views/admin/quotas/viewquotas_quota_actions.php b/application/views/admin/quotas/viewquotas_quota_actions.php
index 475ce517f7..414c79cd17 100644
--- a/application/views/admin/quotas/viewquotas_quota_actions.php
+++ b/application/views/admin/quotas/viewquotas_quota_actions.php
@@ -24,7 +24,7 @@
       data-remote-link="<?=App()->createUrl('admin/validate/', ["sa" => 'quota', 'sid'=>$oSurvey->getPrimaryKey(), 'quota'=>$oQuota->getPrimaryKey()])?>"
       class="btn btn-default selector__quota_open_validation"
       data-tooltip="true"
-      title="<?=sprintf(gT("Validation of quota %s"),$oQuota->name)?>"
+      title="<?=sprintf(gT("Validation of quota %s"),htmlentities($oQuota->name))?>"
       data-toggel="modal"
       data-target="quotaValidation"
     >
diff --git a/application/views/admin/quotas/viewquotas_quota_members.php b/application/views/admin/quotas/viewquotas_quota_members.php
index 78fa34aa0b..c27f6ec61d 100644
--- a/application/views/admin/quotas/viewquotas_quota_members.php
+++ b/application/views/admin/quotas/viewquotas_quota_members.php
@@ -25,7 +25,7 @@
                 <span><span class="fa fa-external-link"></span> <?php echo gT('Autoload URL:').' '.htmlentities($oQuota->mainLanguagesetting->quotals_url);?></span>
             <?php endif;?>
         </div>
-        <?php echo viewHelper::flatEllipsizeText($oQuota->name) ;?>
+        <?php //echo htmlentities(viewHelper::flatEllipsizeText($oQuota->name)) ;?>
     </div>
     <table class="table table-quota-items table-striped table-condensed" >
         <thead>
diff --git a/third_party/vimeo/psalm b/third_party/vimeo/psalm
new file mode 160000
index 0000000000..e551b24843
--- /dev/null
+++ b/third_party/vimeo/psalm
@@ -0,0 +1 @@
+Subproject commit e551b248436723439c863f70569f43cc479fb67e
