From 7d3aba9f06899d0128ef46e8a2fa143c6fad8f62 Mon Sep 17 00:00:00 2001
From: Francois-Xavier Le Bail <devel.fx.lebail@orange.fr>
Date: Wed, 22 Mar 2017 16:27:48 +0100
Subject: [PATCH] CVE-2017-13024/IPv6 mobility: Add a bounds check before
 fetching data

This fixes a buffer over-read discovered by Bhargava Shastry,
SecT/TU Berlin.

Add a test using the capture file supplied by the reporter(s), modified
so the capture file won't cause 'tcpdump: pcap_loop: truncated dump file'
---
 print-mobility.c               |   2 ++
 tests/TESTLIST                 |   1 +
 tests/mobility_opt_asan_2.out  |   1 +
 tests/mobility_opt_asan_2.pcap | Bin 0 -> 143 bytes
 4 files changed, 4 insertions(+)
 create mode 100644 tests/mobility_opt_asan_2.out
 create mode 100644 tests/mobility_opt_asan_2.pcap

diff --git a/print-mobility.c b/print-mobility.c
index 64497b36e..21a0fbade 100644
--- a/print-mobility.c
+++ b/print-mobility.c
@@ -166,6 +166,8 @@ mobility_opt_print(netdissect_options *ndo,
 				ND_PRINT((ndo, "(ni: trunc)"));
 				goto trunc;
 			}
+			ND_TCHECK_16BITS(&bp[i+2]);
+			ND_TCHECK_16BITS(&bp[i+4]);
 			ND_PRINT((ndo, "(ni: ho=0x%04x co=0x%04x)",
 				EXTRACT_16BITS(&bp[i+2]),
 				EXTRACT_16BITS(&bp[i+4])));
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 3e215960d..e0caaa34b 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -525,6 +525,7 @@ vtp_asan		vtp_asan.pcap			vtp_asan.out	-v
 icmp6_mobileprefix_asan	icmp6_mobileprefix_asan.pcap	icmp6_mobileprefix_asan.out	-v
 ip_printroute_asan	ip_printroute_asan.pcap		ip_printroute_asan.out	-v
 mobility_opt_asan	mobility_opt_asan.pcap		mobility_opt_asan.out	-v
+mobility_opt_asan_2	mobility_opt_asan_2.pcap	mobility_opt_asan_2.out	-v
 
 # RTP tests
 # fuzzed pcap
diff --git a/tests/mobility_opt_asan_2.out b/tests/mobility_opt_asan_2.out
new file mode 100644
index 000000000..403926e5b
--- /dev/null
+++ b/tests/mobility_opt_asan_2.out
@@ -0,0 +1 @@
+IP6 (class 0x50, flowlabel 0x0002c, hlim 0, next-header Mobile IP (old) (62) payload length: 7168) ff:7f0f:40:0:ee00:0:b658:5203 > 205:20:1:b00:0:2200:af01:e000: mobility: BRR(type-0x06: len=0)[|MOBILITY]
diff --git a/tests/mobility_opt_asan_2.pcap b/tests/mobility_opt_asan_2.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..7fadc580f52058a7939dec5f813f5ce109724a74
GIT binary patch
literal 143
zcmca|c+)~A1{MYwa0W6Mf!LwIn@fzD>3KSkZPviRaG*hX0Ruylg{Eh3blcrj1_m7&
z20I3Z|MmO~4h#(MfU34d1TizQGAJ-Gaszov4C@&mFtEL0U}WnP{l^BhK?EoY0g=2F
S0t`xTp*$lS1|~2Q<Ol$_h8M~J

literal 0
HcmV?d00001

