From cf1651f7ff76515593f4d8ca6e6e15d2247fe255 Mon Sep 17 00:00:00 2001
From: Tanner <tannernelson@gmail.com>
Date: Wed, 30 Sep 2020 19:28:20 -0400
Subject: [PATCH] fix relative percent decoding in file middleware (#2500)

---
 Sources/Vapor/Middleware/FileMiddleware.swift |  8 +++++---
 Tests/VaporTests/FileTests.swift              | 15 +++++++++++++++
 Tests/VaporTests/Utilities/foo.txt            |  1 +
 3 files changed, 21 insertions(+), 3 deletions(-)
 create mode 100644 Tests/VaporTests/Utilities/foo.txt

diff --git a/Sources/Vapor/Middleware/FileMiddleware.swift b/Sources/Vapor/Middleware/FileMiddleware.swift
index 0b3a20b866..3a9d0bfe6a 100644
--- a/Sources/Vapor/Middleware/FileMiddleware.swift
+++ b/Sources/Vapor/Middleware/FileMiddleware.swift
@@ -13,8 +13,10 @@ public final class FileMiddleware: Middleware {
 
     /// See `Middleware`.
     public func respond(to request: Request, chainingTo next: Responder) -> EventLoopFuture<Response> {
-        // make a copy of the path
-        var path = request.url.path
+        // make a copy of the percent-decoded path
+        guard var path = request.url.path.removingPercentEncoding else {
+            return request.eventLoop.makeFailedFuture(Abort(.badRequest))
+        }
 
         // path must be relative.
         while path.hasPrefix("/") {
@@ -27,7 +29,7 @@ public final class FileMiddleware: Middleware {
         }
 
         // create absolute file path
-        let filePath = self.publicDirectory + (path.removingPercentEncoding ?? path)
+        let filePath = self.publicDirectory + path
 
         // check if file exists and is not a directory
         var isDir: ObjCBool = false
diff --git a/Tests/VaporTests/FileTests.swift b/Tests/VaporTests/FileTests.swift
index be9a1a9bb5..a7cd43b8a9 100644
--- a/Tests/VaporTests/FileTests.swift
+++ b/Tests/VaporTests/FileTests.swift
@@ -61,4 +61,19 @@ final class FileTests: XCTestCase {
             XCTAssertEqual(res.body.string, "<h1>Hello</h1>\n")
         }
     }
+
+    func testPercentDecodedRelativePath() throws {
+        let app = Application(.testing)
+        defer { app.shutdown() }
+
+        let path = #file.split(separator: "/").dropLast().joined(separator: "/")
+        app.middleware.use(FileMiddleware(publicDirectory: "/" + path))
+
+        try app.test(.GET, "%2e%2e/VaporTests/Utilities/foo.txt") { res in
+            XCTAssertEqual(res.status, .forbidden)
+        }.test(.GET, "Utilities/foo.txt") { res in
+            XCTAssertEqual(res.status, .ok)
+            XCTAssertEqual(res.body.string, "bar\n")
+        }
+    }
 }
diff --git a/Tests/VaporTests/Utilities/foo.txt b/Tests/VaporTests/Utilities/foo.txt
new file mode 100644
index 0000000000..5716ca5987
--- /dev/null
+++ b/Tests/VaporTests/Utilities/foo.txt
@@ -0,0 +1 @@
+bar
