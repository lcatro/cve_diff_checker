From bbd6cb398c1740c68e9b1b78340c887c58c1fbda Mon Sep 17 00:00:00 2001
From: Tomas Mozes <hydrapolic@gmail.com>
Date: Mon, 25 Sep 2017 10:19:20 +0200
Subject: app-admin/logstash-bin: bump to 5.5.3/5.6.1

Package-Manager: Portage-2.3.10, Repoman-2.3.3

Signed-off-by: Michael Orlitzky <mjo@gentoo.org>
---
 app-admin/logstash-bin/Manifest                  |  2 +
 app-admin/logstash-bin/files/logstash.confd      |  6 +-
 app-admin/logstash-bin/files/logstash.initd      | 11 ++--
 app-admin/logstash-bin/logstash-bin-5.5.3.ebuild | 75 ++++++++++++++++++++++++
 app-admin/logstash-bin/logstash-bin-5.6.1.ebuild | 75 ++++++++++++++++++++++++
 5 files changed, 160 insertions(+), 9 deletions(-)
 create mode 100644 app-admin/logstash-bin/logstash-bin-5.5.3.ebuild
 create mode 100644 app-admin/logstash-bin/logstash-bin-5.6.1.ebuild

diff --git a/app-admin/logstash-bin/Manifest b/app-admin/logstash-bin/Manifest
index 88779e69bfe..5988e838aae 100644
--- a/app-admin/logstash-bin/Manifest
+++ b/app-admin/logstash-bin/Manifest
@@ -1,3 +1,5 @@
 DIST logstash-5.2.2.zip 100068713 SHA256 35bd0378f5b9001b4c3056b11496936ef47c09e3ddc469353bc8951e3b81e174 SHA512 923b35e8bcc97f6036cd4a484df546b2cc1341ec8fe5080bea8f979856086aaaae5f71fa0c3f7aee2207f7c3e71aec18af416278123362f89990c05ec9e2c92f WHIRLPOOL 4a67ed0ba3b532da5d488b2e45f53149b4e63b6b638b6fe1058a13eab904cb7ec24cd87306868a4770fe6aadfe13f7d76bfc9973e73104a8e4e9aee455321c32
 DIST logstash-5.3.2.zip 100247384 SHA256 b0dfe9295c86dc4efbc1b0884c8078fd414e2e96480c3b513b2a92dab47cb505 SHA512 c150a3076b035204677275081267ac781b34d7abd1e93214cf79d73c326afb58b24ebd91453dd6fb7ba3157cb28de9b319e077e07e4b0cb3db939b99174b130b WHIRLPOOL 83d8b347266e0846b2967b6c11c6615dd3a438d8eaf5dbe057caf7569a6f64ff39a352b56b9ef9127d045d7a37d484a5a09130961cbe190946d7f1b52a66251a
 DIST logstash-5.4.3.zip 100434357 SHA256 074f46832c823775c10e662ddbe8007ce19790591aeb617f351a998f9adc5c9a SHA512 036667b9209bdc7ddb3e1c979bfe059b2aa6021c1efb4db0a2eeef0b3adec6f6dd1c2a326da2447abd31f40fbeddda50d495cc936b0c23e0ad541a6e8ac40048 WHIRLPOOL ff691031d7e4083491d7448867defc10f3bbe0a10f47194df3444fcf71baa0b8f133d4b0791b0837673130be078b425f8722a7e7b177c07fdd5968c94adfddba
+DIST logstash-5.5.3.zip 99551442 SHA256 f81ff55feb21ff4edd4283938ac8362c2906d98f9427d8660dab8465e08f0da9 SHA512 a4328ad0b8192b7c5aaed155d608d9db6adeaefd640e461ef4467daa1a28a2ae25d6b2b1adcf47c5dd82b66fc1adbf8ba5f3eabcf7e69dd8719a5860795877aa WHIRLPOOL d3482df4a7729f6b34973816e39315c69254a641e9811131d7d5e12ede54003a326c5773e799ee471dda01a6113762919ea81ab56ede62d29221f63ed5a7f8c7
+DIST logstash-5.6.1.zip 107893345 SHA256 a484176009af9f9a526360a529e2777e18a8928b50a223bb0823bfa45da958c6 SHA512 d2ddc62e14013ed69e2666cb3831bec2cd22f5bcdb147ec431fe1effa64bcb4f8feb2ea77a1c0b43deefeec9a502effe1975a2061c632c57b58b36b5010cb17d WHIRLPOOL f430a452b815e44147bf22b6ed7ab1df01cfe27ec44f2f38007127899cb7408d626f2090efba2ebddd22fd95731ed8df971d3e7793c35b174681ecbb02914ba3
diff --git a/app-admin/logstash-bin/files/logstash.confd b/app-admin/logstash-bin/files/logstash.confd
index dd861d0633f..6dbbe627a5a 100644
--- a/app-admin/logstash-bin/files/logstash.confd
+++ b/app-admin/logstash-bin/files/logstash.confd
@@ -5,6 +5,9 @@
 # Set a home directory
 #LS_HOME=/var/lib/logstash
 
+# Set data directory
+#LS_DATA_DIR=${LS_HOME}/data
+
 # Arguments to pass to logstash agent
 #LS_OPTS=""
 
@@ -12,9 +15,6 @@
 #LS_HEAP_SIZE="500m"
 #LS_JAVA_OPTS="-Djava.io.tmpdir=$HOME"
 
-# pidfiles location
-#LS_PIDFILE=/run/logstash/logstash.pid
-
 # user id to be invoked as
 #LS_USER=logstash
 #LS_GROUP=logstash
diff --git a/app-admin/logstash-bin/files/logstash.initd b/app-admin/logstash-bin/files/logstash.initd
index 0a0f7ad11b8..2133421377d 100644
--- a/app-admin/logstash-bin/files/logstash.initd
+++ b/app-admin/logstash-bin/files/logstash.initd
@@ -7,6 +7,7 @@ LS_GROUP=${LS_GROUP:-$LS_USER}
 LS_LOG_DIR=${LS_LOG_DIR:-/var/log/logstash}
 LS_CONF_DIR=${LS_CONF_DIR:-/etc/logstash/conf.d}
 LS_HOME=${LS_HOME:-/var/lib/logstash}
+LS_DATA_DIR=${LS_DATA_DIR:-$LS_HOME/data}
 LS_HEAP_SIZE=${LS_HEAP_SIZE:-500m}
 LS_NICE=${LS_NICE:-19}
 LS_JAVA_OPTS=${LS_JAVA_OPTS:-"-Djava.io.tmpdir=${LS_HOME}"}
@@ -17,9 +18,9 @@ KILL_ON_STOP_TIMEOUT=${KILL_ON_STOP_TIMEOUT:-0}
 LS_INSTALL_DIR="/opt/logstash"
 
 command="${LS_INSTALL_DIR}/bin/logstash"
-command_args="--path.config ${LS_CONF_DIR} --path.logs ${LS_LOG_DIR} ${LS_OPTS}"
+command_args="--path.config ${LS_CONF_DIR} --path.logs ${LS_LOG_DIR} --path.data ${LS_DATA_DIR} ${LS_OPTS}"
 command_background="true"
-pidfile=${LS_PIDFILE:-"/run/logstash/logstash.pid"}
+pidfile="/run/${RC_SVCNAME}.pid"
 
 start_stop_daemon_args="--user ${LS_USER}:${LS_GROUP} \
 	--chdir ${LS_HOME}
@@ -38,7 +39,7 @@ checkconfig() {
 	fi
 
 	ebegin "Checking your configuration"
-	${command} ${command_args} --config.test_and_exit
+	${command} ${command_args} --path.logs "${LS_LOG_DIR}/configcheck" --config.test_and_exit
 	eend $? "Configuration error. Please fix your configuration files."
 }
 
@@ -55,11 +56,9 @@ start_pre() {
 	rc_ulimit="-n ${LS_OPEN_FILES}"
 
 	local d
-	for d in "${LS_INSTALL_DIR}/data" "$(dirname "${pidfile}")" "${LS_LOG_DIR}"; do
+	for d in "${LS_HOME}" "${LS_DATA_DIR}" "${LS_DATA_DIR}/queue" "${LS_DATA_DIR}/dead_letter_queue" "${LS_LOG_DIR}"; do
 		checkpath -d -o "${LS_USER}":"${LS_GROUP}" -m750 "$d"
-		chown -R "${LS_USER}":"${LS_GROUP}" "$d"
 	done
-
 }
 
 stop() {
diff --git a/app-admin/logstash-bin/logstash-bin-5.5.3.ebuild b/app-admin/logstash-bin/logstash-bin-5.5.3.ebuild
new file mode 100644
index 00000000000..0c945e55090
--- /dev/null
+++ b/app-admin/logstash-bin/logstash-bin-5.5.3.ebuild
@@ -0,0 +1,75 @@
+# Copyright 1999-2017 Gentoo Foundation
+# Distributed under the terms of the GNU General Public License v2
+
+EAPI=6
+
+inherit user
+
+MY_PN="${PN%-bin}"
+MY_P="${MY_PN}-${PV}"
+
+DESCRIPTION="Tool for managing events and logs"
+HOMEPAGE="https://www.elastic.co/products/logstash"
+SRC_URI="https://artifacts.elastic.co/downloads/${MY_PN}/${MY_P}.zip"
+
+# source: LICENSE.txt and NOTICE.txt
+LICENSE="Apache-2.0 MIT"
+SLOT="0"
+KEYWORDS="~amd64"
+
+RESTRICT="strip"
+QA_PREBUILT="opt/logstash/vendor/jruby/lib/jni/*/libjffi*.so"
+
+RDEPEND="virtual/jre:1.8"
+
+S="${WORKDIR}/${MY_P}"
+
+pkg_setup() {
+	enewgroup ${MY_PN}
+	enewuser ${MY_PN} -1 -1 /var/lib/${MY_PN} ${MY_PN}
+}
+
+src_install() {
+	keepdir /etc/"${MY_PN}"/{conf.d,patterns,plugins}
+	keepdir "/var/lib/${MY_PN}"
+	keepdir "/var/log/${MY_PN}"
+
+	insinto "/usr/share/${MY_PN}"
+	newins "${FILESDIR}/agent.conf.sample" agent.conf
+
+	insinto "/opt/${MY_PN}"
+	doins -r .
+	fperms 0755 "/opt/${MY_PN}/bin/${MY_PN}" "/opt/${MY_PN}/vendor/jruby/bin/jruby" "/opt/${MY_PN}/bin/logstash-plugin"
+
+	insinto /etc/logrotate.d
+	newins "${FILESDIR}/${MY_PN}.logrotate" "${MY_PN}"
+
+	newconfd "${FILESDIR}/${MY_PN}.confd" "${MY_PN}"
+	newinitd "${FILESDIR}/${MY_PN}.initd" "${MY_PN}"
+
+	insinto /usr/share/eselect/modules
+	doins "${FILESDIR}"/logstash-plugin.eselect
+}
+
+pkg_postinst() {
+	ewarn "The default pidfile directory has been changed from /run/logstash to /run."
+	ewarn "Please ensure any running logstash processes are shut down cleanly."
+	ewarn
+	ewarn "The default data directory has been moved from /opt/logstash/data to"
+	ewarn "/var/lib/logstash/data. Please check and move its contents as necessary."
+	ewarn
+	ewarn "Self installed plugins are removed during Logstash upgrades (Bug #622602)"
+	ewarn "Install the plugins via eselect module that will automatically re-install"
+	ewarn "all self installed plugins after Logstash upgrades."
+	einfo
+	einfo "Installing plugins:"
+	einfo "eselect logstash-plugin install logstash-output-gelf"
+	einfo
+
+	einfo "Reinstalling self installed plugins (installed via eselect module):"
+	eselect logstash-plugin reinstall
+
+	einfo
+	einfo "Sample configuration:"
+	einfo "${EROOT%/}/usr/share/${MY_PN}"
+}
diff --git a/app-admin/logstash-bin/logstash-bin-5.6.1.ebuild b/app-admin/logstash-bin/logstash-bin-5.6.1.ebuild
new file mode 100644
index 00000000000..0c945e55090
--- /dev/null
+++ b/app-admin/logstash-bin/logstash-bin-5.6.1.ebuild
@@ -0,0 +1,75 @@
+# Copyright 1999-2017 Gentoo Foundation
+# Distributed under the terms of the GNU General Public License v2
+
+EAPI=6
+
+inherit user
+
+MY_PN="${PN%-bin}"
+MY_P="${MY_PN}-${PV}"
+
+DESCRIPTION="Tool for managing events and logs"
+HOMEPAGE="https://www.elastic.co/products/logstash"
+SRC_URI="https://artifacts.elastic.co/downloads/${MY_PN}/${MY_P}.zip"
+
+# source: LICENSE.txt and NOTICE.txt
+LICENSE="Apache-2.0 MIT"
+SLOT="0"
+KEYWORDS="~amd64"
+
+RESTRICT="strip"
+QA_PREBUILT="opt/logstash/vendor/jruby/lib/jni/*/libjffi*.so"
+
+RDEPEND="virtual/jre:1.8"
+
+S="${WORKDIR}/${MY_P}"
+
+pkg_setup() {
+	enewgroup ${MY_PN}
+	enewuser ${MY_PN} -1 -1 /var/lib/${MY_PN} ${MY_PN}
+}
+
+src_install() {
+	keepdir /etc/"${MY_PN}"/{conf.d,patterns,plugins}
+	keepdir "/var/lib/${MY_PN}"
+	keepdir "/var/log/${MY_PN}"
+
+	insinto "/usr/share/${MY_PN}"
+	newins "${FILESDIR}/agent.conf.sample" agent.conf
+
+	insinto "/opt/${MY_PN}"
+	doins -r .
+	fperms 0755 "/opt/${MY_PN}/bin/${MY_PN}" "/opt/${MY_PN}/vendor/jruby/bin/jruby" "/opt/${MY_PN}/bin/logstash-plugin"
+
+	insinto /etc/logrotate.d
+	newins "${FILESDIR}/${MY_PN}.logrotate" "${MY_PN}"
+
+	newconfd "${FILESDIR}/${MY_PN}.confd" "${MY_PN}"
+	newinitd "${FILESDIR}/${MY_PN}.initd" "${MY_PN}"
+
+	insinto /usr/share/eselect/modules
+	doins "${FILESDIR}"/logstash-plugin.eselect
+}
+
+pkg_postinst() {
+	ewarn "The default pidfile directory has been changed from /run/logstash to /run."
+	ewarn "Please ensure any running logstash processes are shut down cleanly."
+	ewarn
+	ewarn "The default data directory has been moved from /opt/logstash/data to"
+	ewarn "/var/lib/logstash/data. Please check and move its contents as necessary."
+	ewarn
+	ewarn "Self installed plugins are removed during Logstash upgrades (Bug #622602)"
+	ewarn "Install the plugins via eselect module that will automatically re-install"
+	ewarn "all self installed plugins after Logstash upgrades."
+	einfo
+	einfo "Installing plugins:"
+	einfo "eselect logstash-plugin install logstash-output-gelf"
+	einfo
+
+	einfo "Reinstalling self installed plugins (installed via eselect module):"
+	eselect logstash-plugin reinstall
+
+	einfo
+	einfo "Sample configuration:"
+	einfo "${EROOT%/}/usr/share/${MY_PN}"
+}
-- 
cgit v1.2.3-18-g5258

