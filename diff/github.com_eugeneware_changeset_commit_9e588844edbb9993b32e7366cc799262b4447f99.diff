From 9e588844edbb9993b32e7366cc799262b4447f99 Mon Sep 17 00:00:00 2001
From: Eugene Ware <eugene@noblesamurai.com>
Date: Fri, 5 Mar 2021 15:54:18 +1100
Subject: [PATCH] Fix against prototype pollution

---
 index.js      | 6 +++---
 test/index.js | 9 +++++++++
 2 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/index.js b/index.js
index ce55325..96b49f0 100644
--- a/index.js
+++ b/index.js
@@ -75,9 +75,9 @@ function apply(changes, target, modify) {
               ptr[prop] = {};
             }
 
-            if (i < len - 1) {
+            if (i < len - 1 && ptr.hasOwnProperty(prop)) {
               ptr = ptr[prop];
-            } else {
+            } else if (prop !== '__proto__') {
               ptr[prop] = ch.value;
             }
           });
@@ -101,7 +101,7 @@ function apply(changes, target, modify) {
             } else {
               if (Array.isArray(ptr)) {
                 ptr.splice(parseInt(prop, 10), 1);
-              } else {
+              } else if (ptr.hasOwnProperty(prop)) {
                 delete ptr[prop];
               }
             }
diff --git a/test/index.js b/test/index.js
index df6dc9e..0bd8585 100644
--- a/test/index.js
+++ b/test/index.js
@@ -243,4 +243,13 @@ describe('changeset', function () {
     ]);
     done();
   });
+
+  it('should not allow prototype pollution', function(done) {
+    var changeset = [
+      { type: 'put', key: ['__proto__','polluted'], value: 'Yes! Its Polluted'}
+    ];
+    diff.apply(changeset, {}, true);
+    expect({}.polluted).to.not.equal('Yes! Its Polluted');
+    done();
+  })
 });
