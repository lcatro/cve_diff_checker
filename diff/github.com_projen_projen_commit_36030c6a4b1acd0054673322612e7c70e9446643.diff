From 36030c6a4b1acd0054673322612e7c70e9446643 Mon Sep 17 00:00:00 2001
From: Elad Ben-Israel <benisrae@amazon.com>
Date: Tue, 9 Mar 2021 11:02:36 +0200
Subject: [PATCH] fix(node): security vulnerability in rebuild-bot (#602)

To address a security issue, the `@projen rebuild` workflow will no longer be triggered by a comment on the pull request. This commit removes the `issue_comment` trigger from rebuild-bot workflow so that this workflow can only be executed manually by administrators.

Additional details will be provided at a future date.
---
 .github/workflows/rebuild-bot.yml              |  3 ---
 src/__tests__/__snapshots__/integ.test.ts.snap |  6 ------
 src/node-project.ts                            | 17 ++++++++++++++---
 3 files changed, 14 insertions(+), 12 deletions(-)

diff --git a/.github/workflows/rebuild-bot.yml b/.github/workflows/rebuild-bot.yml
index 7fb999058..87714728b 100644
--- a/.github/workflows/rebuild-bot.yml
+++ b/.github/workflows/rebuild-bot.yml
@@ -2,9 +2,6 @@
 
 name: rebuild-bot
 on:
-  issue_comment:
-    types:
-      - created
   workflow_dispatch: {}
 jobs:
   build:
diff --git a/src/__tests__/__snapshots__/integ.test.ts.snap b/src/__tests__/__snapshots__/integ.test.ts.snap
index 6add32782..d9927f104 100644
--- a/src/__tests__/__snapshots__/integ.test.ts.snap
+++ b/src/__tests__/__snapshots__/integ.test.ts.snap
@@ -317,9 +317,6 @@ jobs:
 
 name: rebuild-bot
 on:
-  issue_comment:
-    types:
-      - created
   workflow_dispatch: {}
 jobs:
   build:
@@ -4206,9 +4203,6 @@ jobs:
 
 name: rebuild-bot
 on:
-  issue_comment:
-    types:
-      - created
   workflow_dispatch: {}
 jobs:
   build:
diff --git a/src/node-project.ts b/src/node-project.ts
index d8a5759e3..48be41c73 100644
--- a/src/node-project.ts
+++ b/src/node-project.ts
@@ -881,7 +881,13 @@ export class NodeProject extends Project {
 
     const workflow = github.addWorkflow(name);
 
-    workflow.on(options.trigger);
+    if (options.trigger) {
+      if (options.trigger.issue_comment) {
+        throw new Error('"issue_comment" should not be used as a trigger due to a security issue');
+      }
+
+      workflow.on(options.trigger);
+    }
 
     workflow.on({
       workflow_dispatch: {}, // allow manual triggering
@@ -1041,7 +1047,7 @@ export class NodeProject extends Project {
     });
 
     this.createBuildWorkflow('rebuild-bot', {
-      trigger: { issue_comment: { types: ['created'] } },
+      // trigger: { issue_comment: { types: ['created'] } }, // <--- disabled due to a security issue
       condition: `\${{ github.event.issue.pull_request && contains(github.event.comment.body, '@projen ${command}') }}`,
       antitamperDisabled: true, // definitely do not want that
 
@@ -1107,7 +1113,12 @@ interface NodeBuildWorkflowOptions {
    */
   readonly artifactDirectory?: string;
 
-  readonly trigger: { [event: string]: any };
+  /**
+   * What should trigger the workflow?
+   *
+   * @default - by default workflows can only be triggered by manually.
+   */
+  readonly trigger?: { [event: string]: any };
 
   /**
    * Bump a new version for this build.
