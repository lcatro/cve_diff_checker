From 5f81b0c48a817d4337d8b0e99ea0b4744ecd720b Mon Sep 17 00:00:00 2001
From: brad <brad@brad-little-laptop>
Date: Sat, 26 Sep 2015 10:04:35 +1200
Subject: [PATCH] patch XXE vulnerability

---
 .../http/webdav/DefaultPropFindRequestFieldParser.java     | 7 +++++--
 .../java/io/milton/http/webdav/DefaultPropPatchParser.java | 4 ++++
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/milton-server-ce/src/main/java/io/milton/http/webdav/DefaultPropFindRequestFieldParser.java b/milton-server-ce/src/main/java/io/milton/http/webdav/DefaultPropFindRequestFieldParser.java
index bb37ad32..5ad7ba84 100644
--- a/milton-server-ce/src/main/java/io/milton/http/webdav/DefaultPropFindRequestFieldParser.java
+++ b/milton-server-ce/src/main/java/io/milton/http/webdav/DefaultPropFindRequestFieldParser.java
@@ -53,7 +53,7 @@ public DefaultPropFindRequestFieldParser() {
 	@Override
     public PropertiesRequest getRequestedFields( InputStream in ) {
 		final Set<QName> set = new LinkedHashSet<QName>();
-        try {            
+        try {
             ByteArrayOutputStream bout = new ByteArrayOutputStream();
             StreamUtils.readTo( in, bout, false, true );
             byte[] arr = bout.toByteArray();
@@ -61,6 +61,9 @@ public PropertiesRequest getRequestedFields( InputStream in ) {
                 ByteArrayInputStream bin = new ByteArrayInputStream( arr );
                 XMLReader reader = XMLReaderFactory.createXMLReader();
 				reader.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
+				// https://www.owasp.org/index.php/XML_External_Entity_%28XXE%29_Processing
+				reader.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
+				reader.setFeature("http://xml.org/sax/features/external-general-entities", false);
                 PropFindSaxHandler handler = new PropFindSaxHandler();
                 reader.setContentHandler( handler );
                 try {
@@ -77,7 +80,7 @@ public PropertiesRequest getRequestedFields( InputStream in ) {
                     log.warn( "exception parsing request body", e );
                     // ignore
                 }
-            }            
+            }
         } catch( Exception ex ) {
 			// There's a report of an exception being thrown here by IT Hit Webdav client
 			// Perhaps we can just log the error and return an empty set. Usually this
diff --git a/milton-server-ce/src/main/java/io/milton/http/webdav/DefaultPropPatchParser.java b/milton-server-ce/src/main/java/io/milton/http/webdav/DefaultPropPatchParser.java
index 18b7c951..c3462002 100644
--- a/milton-server-ce/src/main/java/io/milton/http/webdav/DefaultPropPatchParser.java
+++ b/milton-server-ce/src/main/java/io/milton/http/webdav/DefaultPropPatchParser.java
@@ -69,6 +69,10 @@ private PropPatchParseResult parseContent( byte[] arr ) throws IOException, SAXE
             ByteArrayInputStream bin = new ByteArrayInputStream( arr );
             XMLReader reader = XMLReaderFactory.createXMLReader();
 			reader.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
+			// https://www.owasp.org/index.php/XML_External_Entity_%28XXE%29_Processing
+			reader.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
+			reader.setFeature("http://xml.org/sax/features/external-general-entities", false);
+
             PropPatchSaxHandler handler = new PropPatchSaxHandler();
             reader.setContentHandler( handler );
             reader.parse( new InputSource( bin ) );
