From c073a7712d82476b5fbee74856c46b88af9c3175 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Thu, 5 Jan 2017 12:07:59 -0500
Subject: [PATCH] 
 https://www.imagemagick.org/discourse-server/viewtopic.php?f=3&t=31161

---
 ChangeLog     | 4 ++++
 coders/tiff.c | 5 +++--
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 1420f98d64..c7013e26e7 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,7 @@
+2017-01-04  6.9.7-3 Cristy  <quetzlzacatenango@image...>
+  * Increase memory allocation for TIFF pixels (reference
+    https://www.imagemagick.org/discourse-server/viewtopic.php?f=3&t=31161).
+
 2017-01-03  6.9.7-2 Cristy  <quetzlzacatenango@image...>
   * Release ImageMagick version 6.9.7-2, GIT revision 11274:2faf8d7:20170103.
 
diff --git a/coders/tiff.c b/coders/tiff.c
index 55a6683f71..6304b397fe 100644
--- a/coders/tiff.c
+++ b/coders/tiff.c
@@ -1606,8 +1606,9 @@ RestoreMSCWarning
       method=ReadTileMethod;
     quantum_info->endian=LSBEndian;
     quantum_type=RGBQuantum;
-    tiff_pixels=(unsigned char *) AcquireMagickMemory(TIFFScanlineSize(tiff)+
-      sizeof(uint32));
+    tiff_pixels=(unsigned char *) AcquireMagickMemory(MagickMax(
+      TIFFScanlineSize(tiff),(size_t) (image->columns*samples_per_pixel*
+      pow(2.0,ceil(log(bits_per_sample)/log(2.0))))));
     if (tiff_pixels == (unsigned char *) NULL)
       {
         TIFFClose(tiff);
