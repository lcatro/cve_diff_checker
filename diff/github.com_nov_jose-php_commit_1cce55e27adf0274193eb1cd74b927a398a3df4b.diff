From 1cce55e27adf0274193eb1cd74b927a398a3df4b Mon Sep 17 00:00:00 2001
From: nov <nobukazu.matake@optim.co.jp>
Date: Tue, 30 Aug 2016 10:37:36 +0900
Subject: [PATCH] explicit alg check & secure hash comparison

---
 src/JOSE/JWS.php | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/src/JOSE/JWS.php b/src/JOSE/JWS.php
index 950d6b4..60c1cbb 100644
--- a/src/JOSE/JWS.php
+++ b/src/JOSE/JWS.php
@@ -122,14 +122,20 @@ private function _verify($public_key_or_secret, $expected_alg = null) {
         $segments = explode('.', $this->raw);
         $signature_base_string = implode('.', array($segments[0], $segments[1]));
         if (!$expected_alg) {
-            # NOTE: might better to warn here
             $expected_alg = $this->header['alg'];
+            $using_autodetected_alg = true;
         }
         switch ($expected_alg) {
             case 'HS256':
             case 'HS384':
             case 'HS512':
-                return $this->signature === hash_hmac($this->digest(), $signature_base_string, $public_key_or_secret, true);
+                if ($using_autodetected_alg) {
+                    throw new JOSE_Exception_UnexpectedAlgorithm(
+                        'HMAC algs MUST be explicitly specified as $expected_alg'
+                    );
+                }
+                $hmac_hash = hash_hmac($this->digest(), $signature_base_string, $public_key_or_secret, true);
+                return hash_equals($this->signature, $hmac_hash);
             case 'RS256':
             case 'RS384':
             case 'RS512':
