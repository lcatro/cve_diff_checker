From 66244f9ad4b2f39bdef57dfde62c20df1d48881a Mon Sep 17 00:00:00 2001
From: "madhu.sharma" <madhu.sharma@auth0.com>
Date: Thu, 15 Oct 2020 15:37:32 -0500
Subject: [PATCH 1/8] add CSRF protection in profile mapper settings post api

---
 admin/public/site.js  |  1 +
 admin/server.js       |  9 ++++---
 admin/views/index.ejs |  1 +
 package-lock.json     | 63 +++++++++++++++++++++++++++++++++++++++++++
 package.json          |  1 +
 5 files changed, 72 insertions(+), 3 deletions(-)

diff --git a/admin/public/site.js b/admin/public/site.js
index 3710798..cb081f4 100644
--- a/admin/public/site.js
+++ b/admin/public/site.js
@@ -86,6 +86,7 @@
 		$('#profile-mapper-alerts').html('');
 
 		$.post('/profile-mapper', {
+			_csrf: document.getElementById('csrf').value,
 			code: code.getValue()
 		}).always(function() {
 			btn.button('reset');
diff --git a/admin/server.js b/admin/server.js
index a22915a..e113156 100644
--- a/admin/server.js
+++ b/admin/server.js
@@ -5,6 +5,7 @@ var unzipper = require('unzipper');
 var path = require('path');
 var archiver = require('archiver');
 var cas = require('../lib/add_certs');
+var csrf = require('csurf');
 var os = require('os');
 var fs = require('fs');
 var http = require('http');
@@ -31,7 +32,7 @@ app.use(cookieParser());
 app.use(session({
   secret: 'sojo sut ed oterces le'
 }));
-
+var csrfProtection = csrf({ cookie: true });
 var detected_settings = {};
 
 if (process.platform === 'win32') {
@@ -113,13 +114,15 @@ function run(cmd, args, callback) {
   });
 }
 
-app.get('/', set_current_config, function(req, res) {
+app.get('/', set_current_config, csrfProtection, function(req, res) {
   console.log(req.session.LDAP_RESULTS);
   res.render('index', xtend(req.current_config, {
     SUCCESS: req.query && req.query.s === '1',
     LDAP_RESULTS: req.session.LDAP_RESULTS
   }, {
     detected: detected_settings
+  }, {
+    csrfToken: req.csrfToken()
   }));
   delete req.session.LDAP_RESULTS;
 });
@@ -349,7 +352,7 @@ app.get('/profile-mapper', function(req, res) {
   });
 });
 
-app.post('/profile-mapper', function(req, res) {
+app.post('/profile-mapper', csrfProtection, function(req, res) {
   fs.writeFile(__dirname + '/../lib/profileMapper.js', req.body.code, function(err) {
     if (err) {
       res.status(500);
diff --git a/admin/views/index.ejs b/admin/views/index.ejs
index 006c32f..8a071b1 100644
--- a/admin/views/index.ejs
+++ b/admin/views/index.ejs
@@ -20,6 +20,7 @@
   <div class="wrapper">
     <div id="tmp-dialogs"></div>
     <div id="content" style="margin-left: 0;">
+      <input type="hidden" id="csrf" name="_csrf" value="<%= locals.csrfToken %>">
       <section id="configuration-section" class="content-page current">
         <div id="content-header">
         <h1>AD LDAP Connector <span id="connector-version"></span> Configuration</h1>
diff --git a/package-lock.json b/package-lock.json
index f93b3b3..80dcb9b 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -1772,6 +1772,59 @@
       "integrity": "sha512-v1plID3y9r/lPhviJ1wrXpLeyUIGAZ2SHNYTEapm7/8A9nLPoyvVp3RK/EPFqn5kEznyWgYZNsRtYYIWbuG8KA==",
       "dev": true
     },
+    "csrf": {
+      "version": "3.0.6",
+      "resolved": "https://a0us.jfrog.io/a0us/api/npm/npm/csrf/-/csrf-3.0.6.tgz",
+      "integrity": "sha1-thEg3c7q/JHnbtUxO7XAsmZ7cQo=",
+      "requires": {
+        "rndm": "1.2.0",
+        "tsscmp": "1.0.5",
+        "uid-safe": "2.1.4"
+      },
+      "dependencies": {
+        "uid-safe": {
+          "version": "2.1.4",
+          "resolved": "https://a0us.jfrog.io/a0us/api/npm/npm/uid-safe/-/uid-safe-2.1.4.tgz",
+          "integrity": "sha1-Otbzg2jG1MjHXsF2I/t5qh0HHYE=",
+          "requires": {
+            "random-bytes": "~1.0.0"
+          }
+        }
+      }
+    },
+    "csurf": {
+      "version": "1.9.0",
+      "resolved": "https://a0us.jfrog.io/a0us/api/npm/npm/csurf/-/csurf-1.9.0.tgz",
+      "integrity": "sha1-SdLGkl/87Ht95VlZfBU/pTM2QTM=",
+      "requires": {
+        "cookie": "0.3.1",
+        "cookie-signature": "1.0.6",
+        "csrf": "~3.0.3",
+        "http-errors": "~1.5.0"
+      },
+      "dependencies": {
+        "http-errors": {
+          "version": "1.5.1",
+          "resolved": "https://a0us.jfrog.io/a0us/api/npm/npm/http-errors/-/http-errors-1.5.1.tgz",
+          "integrity": "sha1-eIwNLB3iyBuebowBhDtrl+uSB1A=",
+          "requires": {
+            "inherits": "2.0.3",
+            "setprototypeof": "1.0.2",
+            "statuses": ">= 1.3.1 < 2"
+          }
+        },
+        "inherits": {
+          "version": "2.0.3",
+          "resolved": "https://a0us.jfrog.io/a0us/api/npm/npm/inherits/-/inherits-2.0.3.tgz",
+          "integrity": "sha1-Yzwsg+PaQqUC9SRmAiSA9CCCYd4="
+        },
+        "setprototypeof": {
+          "version": "1.0.2",
+          "resolved": "https://a0us.jfrog.io/a0us/api/npm/npm/setprototypeof/-/setprototypeof-1.0.2.tgz",
+          "integrity": "sha1-gaVSFB7BBLiOic44MQOtXGZWTQg="
+        }
+      }
+    },
     "cycle": {
       "version": "1.0.3",
       "resolved": "https://registry.npmjs.org/cycle/-/cycle-1.0.3.tgz",
@@ -4920,6 +4973,11 @@
         "glob": "^7.0.5"
       }
     },
+    "rndm": {
+      "version": "1.2.0",
+      "resolved": "https://a0us.jfrog.io/a0us/api/npm/npm/rndm/-/rndm-1.2.0.tgz",
+      "integrity": "sha1-8z/pz7Urv9UgqhgyO8ZdsRCht2w="
+    },
     "run-async": {
       "version": "2.4.1",
       "resolved": "https://registry.npmjs.org/run-async/-/run-async-2.4.1.tgz",
@@ -6651,6 +6709,11 @@
       "integrity": "sha512-i/6DQjL8Xf3be4K/E6Wgpekn5Qasl1usyw++dAA35Ue5orEn65VIxOA+YvNNl9HV3qv70T7CNwjODHZrLwvd1Q==",
       "dev": true
     },
+    "tsscmp": {
+      "version": "1.0.5",
+      "resolved": "https://a0us.jfrog.io/a0us/api/npm/npm/tsscmp/-/tsscmp-1.0.5.tgz",
+      "integrity": "sha1-fcSjOvcVgatDN9qR2FylQn69mpc="
+    },
     "tunnel": {
       "version": "0.0.6",
       "resolved": "https://registry.npmjs.org/tunnel/-/tunnel-0.0.6.tgz",
diff --git a/package.json b/package.json
index e30a56f..fa44516 100644
--- a/package.json
+++ b/package.json
@@ -32,6 +32,7 @@
     "connect-multiparty": "^2.2.0",
     "cookie-parser": "^1.4.3",
     "cookie-sessions": "github:auth0/cookie-sessions#53a8aae",
+    "csurf": "1.9.0",
     "ejs": "^2.5.5",
     "express": "^4.16.4",
     "express-passport-logout": "~0.1.0",

From 57441facad9edb49f80a57acd74f39d4657add98 Mon Sep 17 00:00:00 2001
From: "madhu.sharma" <madhu.sharma@auth0.com>
Date: Thu, 15 Oct 2020 15:54:29 -0500
Subject: [PATCH 2/8] csrf protecttion in /ldap api

---
 admin/server.js      | 2 +-
 admin/views/form.ejs | 1 +
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/admin/server.js b/admin/server.js
index e113156..06f2dc9 100644
--- a/admin/server.js
+++ b/admin/server.js
@@ -127,7 +127,7 @@ app.get('/', set_current_config, csrfProtection, function(req, res) {
   delete req.session.LDAP_RESULTS;
 });
 
-app.post('/ldap', set_current_config, function(req, res, next) {
+app.post('/ldap', set_current_config, csrfProtection, function(req, res, next) {
   // Convert ENABLE_WRITE_BACK and ENABLE_ACTIVE_DIRECTORY_UNICODE_PASSWORD to boolean.
   req.body.ENABLE_WRITE_BACK = !!(req.body.ENABLE_WRITE_BACK && req.body.ENABLE_WRITE_BACK === 'on');
   req.body.ENABLE_ACTIVE_DIRECTORY_UNICODE_PASSWORD = !!(req.body.ENABLE_ACTIVE_DIRECTORY_UNICODE_PASSWORD && req.body.ENABLE_ACTIVE_DIRECTORY_UNICODE_PASSWORD === 'on');
diff --git a/admin/views/form.ejs b/admin/views/form.ejs
index f2d6248..8116e80 100644
--- a/admin/views/form.ejs
+++ b/admin/views/form.ejs
@@ -1,4 +1,5 @@
 <form class="form-horizontal ldap" method="post" action="/ldap">
+  <input type="hidden" id="csrf" name="_csrf" value="<%= locals.csrfToken %>">
   <p>
     Please enter the settings to connect to your LDAP.
     This will be saved locally and never send exposed.

From 1de30d873cbccb0c7ee2d024d050ef08a1dc60e0 Mon Sep 17 00:00:00 2001
From: "madhu.sharma" <madhu.sharma@auth0.com>
Date: Thu, 15 Oct 2020 16:07:56 -0500
Subject: [PATCH 3/8] add csrf protection in config import

---
 admin/server.js             | 2 +-
 admin/views/form_import.ejs | 6 +++---
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/admin/server.js b/admin/server.js
index 06f2dc9..69a024a 100644
--- a/admin/server.js
+++ b/admin/server.js
@@ -260,7 +260,7 @@ app.get('/export', set_current_config, function(req, res) {
   archive.finalize();
 });
 
-app.post('/import', set_current_config, multipart(), function(req, res, next) {
+app.post('/import', set_current_config, csrfProtection, multipart(), function(req, res, next) {
   console.log('Importing configuration.');
 
   if (!req.files || !req.files.IMPORT_FILE || req.files.IMPORT_FILE.size === 0) {
diff --git a/admin/views/form_import.ejs b/admin/views/form_import.ejs
index c224f1d..ffe5a57 100644
--- a/admin/views/form_import.ejs
+++ b/admin/views/form_import.ejs
@@ -1,6 +1,6 @@
-<form method="post" action="/import" enctype="multipart/form-data">
+<form method="post" action="/import?_csrf=<%= locals.csrfToken %>" enctype="multipart/form-data">
   <p>
-    Import a previous configuration to the connector. 
+    Import a previous configuration to the connector.
   </p>
 
   <div class="control-group" style="border-top:0px;">
@@ -17,4 +17,4 @@
       <button type="submit" class="btn btn-primary">Upload</button>
     </div>
   </div>
-</form>
\ No newline at end of file
+</form>

From 1e2bfcb5b2b901af6dfae8aea3ac1fa1961016ab Mon Sep 17 00:00:00 2001
From: "madhu.sharma" <madhu.sharma@auth0.com>
Date: Thu, 15 Oct 2020 16:28:50 -0500
Subject: [PATCH 4/8] csrf protection added in logs clear api

---
 admin/public/site.js | 4 +++-
 admin/server.js      | 2 +-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/admin/public/site.js b/admin/public/site.js
index cb081f4..a694b98 100644
--- a/admin/public/site.js
+++ b/admin/public/site.js
@@ -132,7 +132,9 @@
 	$("#logs-clear").click(function(e) {
 		e.preventDefault();
 
-		$.post('/logs/clear');
+		$.post('/logs/clear', {
+			_csrf: document.getElementById('csrf').value
+		});
 		$('#logs').text('');
 	});
 
diff --git a/admin/server.js b/admin/server.js
index 69a024a..62ce043 100644
--- a/admin/server.js
+++ b/admin/server.js
@@ -315,7 +315,7 @@ app.get('/logs', function(req, res) {
   });
 });
 
-app.post('/logs/clear', function(req, res) {
+app.post('/logs/clear', csrfProtection, function(req, res) {
   fs.writeFile(__dirname + '/../logs.log', '', function(err) {
     if (err) {
       res.status(500);

From e935582cf9d900efd1e960fa5f1589da0974caa6 Mon Sep 17 00:00:00 2001
From: "madhu.sharma" <madhu.sharma@auth0.com>
Date: Thu, 15 Oct 2020 16:43:10 -0500
Subject: [PATCH 5/8] add csrf protection in /updater/run

---
 admin/public/site.js | 4 +++-
 admin/server.js      | 2 +-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/admin/public/site.js b/admin/public/site.js
index a694b98..a669a38 100644
--- a/admin/public/site.js
+++ b/admin/public/site.js
@@ -241,7 +241,9 @@
 	$("#update-run-form").submit(function(e) {
 		e.preventDefault();
 
-		$.post('/updater/run');
+		$.post('/updater/run', {
+			_csrf: document.getElementById('csrf').value,
+		});
 
 		update = 'Started';
 		$('#update-logs').text('');
diff --git a/admin/server.js b/admin/server.js
index 62ce043..e0c5573 100644
--- a/admin/server.js
+++ b/admin/server.js
@@ -443,7 +443,7 @@ app.get('/troubleshooter/export', set_current_config,
     archive.finalize();
   });
 
-app.post('/updater/run', set_current_config, function(req, res) {
+app.post('/updater/run', csrfProtection, set_current_config, function(req, res) {
   run(__dirname + '/../update-connector.cmd', [], function(data) {
     res.writeHead(200, {
       "Content-Type": "text/plain"

From c52ae3ecf633616ebe378d36df0e5a87d341f9ad Mon Sep 17 00:00:00 2001
From: "madhu.sharma" <madhu.sharma@auth0.com>
Date: Thu, 15 Oct 2020 16:46:12 -0500
Subject: [PATCH 6/8] add csrf protection in /ticket endpoint

---
 admin/server.js             | 2 +-
 admin/views/form_ticket.ejs | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/admin/server.js b/admin/server.js
index e0c5573..8f84533 100644
--- a/admin/server.js
+++ b/admin/server.js
@@ -168,7 +168,7 @@ app.post('/server', multipart(), set_current_config, function(req, res, next) {
   });
 }, merge_config);
 
-app.post('/ticket', set_current_config, function(req, res, next) {
+app.post('/ticket', set_current_config, csrfProtection, function(req, res, next) {
   if (!req.body.PROVISIONING_TICKET) {
     return res.render('index', xtend(req.current_config, {
       ERROR: 'The ticket url ' + req.body.PROVISIONING_TICKET + ' is not vaild.'
diff --git a/admin/views/form_ticket.ejs b/admin/views/form_ticket.ejs
index 02ba002..a5d59d6 100644
--- a/admin/views/form_ticket.ejs
+++ b/admin/views/form_ticket.ejs
@@ -1,4 +1,5 @@
 <form class="form-horizontal" method="post" action="/ticket">
+  <input type="hidden" id="csrf" name="_csrf" value="<%= locals.csrfToken %>">
   <p>
     Please enter the ticket url as shown in the instructions provided in the documentation
   </p>
@@ -23,4 +24,4 @@
       <button type="submit" class="btn btn-success">Continue</button>
     </div>
   </div>
-</form>
\ No newline at end of file
+</form>

From f8d3236659d00714ae7f56572df24365ea42d4af Mon Sep 17 00:00:00 2001
From: "madhu.sharma" <madhu.sharma@auth0.com>
Date: Thu, 15 Oct 2020 16:49:45 -0500
Subject: [PATCH 7/8] added csrf protection in /server endpoint

---
 admin/server.js             | 2 +-
 admin/views/form_server.ejs | 5 +++--
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/admin/server.js b/admin/server.js
index 8f84533..1a82431 100644
--- a/admin/server.js
+++ b/admin/server.js
@@ -152,7 +152,7 @@ app.post('/ldap', set_current_config, csrfProtection, function(req, res, next) {
   });
 }, merge_config);
 
-app.post('/server', multipart(), set_current_config, function(req, res, next) {
+app.post('/server', multipart(), set_current_config, csrfProtection, function(req, res, next) {
   if (req.body.PORT || req.current_config.PORT) return next();
   freeport(function(er, port) {
     req.body.PORT = port;
diff --git a/admin/views/form_server.ejs b/admin/views/form_server.ejs
index fd9e2bd..f9925fb 100644
--- a/admin/views/form_server.ejs
+++ b/admin/views/form_server.ejs
@@ -1,4 +1,5 @@
 <form class="form-horizontal" method="post" action="/server" enctype="multipart/form-data">
+  <input type="hidden" id="csrf" name="_csrf" value="<%= locals.csrfToken %>">
   <div class="control-group">
     <label class="control-label" for="SERVER_URL">Front Facing URL:</label>
     <div class="controls">
@@ -61,7 +62,7 @@
       <span class="help-block">A string of passphrase for the pfx</span>
     </div>
   </div>
-  
+
   <div class="control-group">
     <label class="control-label" for="CA_CERT">CA Certificate(s):</label>
     <div class="controls">
@@ -84,4 +85,4 @@ CA #2...
       <button type="submit" class="btn btn-primary">Save</button>
     </div>
   </div>
-</form>
\ No newline at end of file
+</form>

From 6eb26aeea1653a8c2ae1e7369d7379f841eedbce Mon Sep 17 00:00:00 2001
From: "madhu.sharma" <madhu.sharma@auth0.com>
Date: Fri, 16 Oct 2020 12:59:01 -0500
Subject: [PATCH 8/8] update version to 5.0.13

---
 package-lock.json | 2 +-
 package.json      | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/package-lock.json b/package-lock.json
index 80dcb9b..1a39d3f 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -1,6 +1,6 @@
 {
   "name": "ad-ldap-connector",
-  "version": "5.0.12",
+  "version": "5.0.13",
   "lockfileVersion": 1,
   "requires": true,
   "dependencies": {
diff --git a/package.json b/package.json
index fa44516..d7f3fb8 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "ad-ldap-connector",
-  "version": "5.0.12",
+  "version": "5.0.13",
   "description": "ADLDAP Federation Connector",
   "main": "server.js",
   "scripts": {
