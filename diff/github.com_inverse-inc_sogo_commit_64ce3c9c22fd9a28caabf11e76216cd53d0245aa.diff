From 64ce3c9c22fd9a28caabf11e76216cd53d0245aa Mon Sep 17 00:00:00 2001
From: Francis Lachapelle <flachapelle@inverse.ca>
Date: Wed, 8 Jun 2016 16:06:58 -0400
Subject: [PATCH] Escape HTML in raw source of events and tasks

Fixes #3718
---
 NEWS                                                 |  1 +
 UI/Scheduler/UIxComponentEditor.m                    |  2 +-
 .../js/Scheduler/ComponentController.js              | 12 ++++++------
 3 files changed, 8 insertions(+), 7 deletions(-)

diff --git a/NEWS b/NEWS
index fa0b73f9db..029c86ece1 100644
--- a/NEWS
+++ b/NEWS
@@ -4,6 +4,7 @@
 Bug fixes
  - [web] fixed generic avatar in lists (#3719)
  - [web] fixed validation in Sieve filter editor
+ - [web] properly encode events and tasks rawsource to avoid XSS issues (#3718)
 
 3.1.2 (2016-06-06)
 ------------------
diff --git a/UI/Scheduler/UIxComponentEditor.m b/UI/Scheduler/UIxComponentEditor.m
index 4f6072ac83..b0f901a3d6 100644
--- a/UI/Scheduler/UIxComponentEditor.m
+++ b/UI/Scheduler/UIxComponentEditor.m
@@ -875,7 +875,7 @@ - (WOResponse *) rawAction
   [content appendFormat: @"%@", [[self clientObject] contentAsString]];
   [response setHeader: @"text/plain; charset=utf-8" 
             forKey: @"content-type"];
-  [response appendContentString: content];
+  [response appendContentString: [content stringByEscapingHTMLString]];
 
   return response;
 }
diff --git a/UI/WebServerResources/js/Scheduler/ComponentController.js b/UI/WebServerResources/js/Scheduler/ComponentController.js
index 6f28c18d85..81be3c7fd7 100644
--- a/UI/WebServerResources/js/Scheduler/ComponentController.js
+++ b/UI/WebServerResources/js/Scheduler/ComponentController.js
@@ -167,23 +167,23 @@
           template: [
             '<md-dialog flex="40" flex-sm="80" flex-xs="100" aria-label="' + l('View Raw Source') + '">',
             '  <md-dialog-content class="md-dialog-content">',
-            '    <pre>',
-            data,
-            '    </pre>',
+            '    <pre ng-bind-html="data"></pre>',
             '  </md-dialog-content>',
             '  <md-dialog-actions>',
             '    <md-button ng-click="close()">' + l('Close') + '</md-button>',
             '  </md-dialog-actions>',
             '</md-dialog>'
           ].join(''),
-          controller: ComponentRawSourceDialogController
+          controller: ComponentRawSourceDialogController,
+          locals: { data: data }
         });
 
         /**
          * @ngInject
          */
-        ComponentRawSourceDialogController.$inject = ['scope', '$mdDialog'];
-        function ComponentRawSourceDialogController(scope, $mdDialog) {
+        ComponentRawSourceDialogController.$inject = ['scope', '$mdDialog', 'data'];
+        function ComponentRawSourceDialogController(scope, $mdDialog, data) {
+          scope.data = data;
           scope.close = function() {
             $mdDialog.hide();
           };
