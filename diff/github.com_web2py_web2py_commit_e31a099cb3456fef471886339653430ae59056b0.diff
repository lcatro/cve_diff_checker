From c5a9d2c4562344d23814228b179653514f99b7a2 Mon Sep 17 00:00:00 2001
From: pallav_fdsi <techi_000@pallav-fdsi.fdsi-private.fielddiagnostics.com>
Date: Thu, 6 Nov 2014 10:35:49 -0500
Subject: [PATCH 1/2] Ignore the contents of the site-packages directory

---
 .gitignore | 1 +
 1 file changed, 1 insertion(+)

diff --git a/.gitignore b/.gitignore
index 4aa1d556b..165971773 100644
--- a/.gitignore
+++ b/.gitignore
@@ -58,3 +58,4 @@ HOWTO-web2py-devel
 *.sublime-project
 *.sublime-workspace
 .idea/*
+site-packages/

From f9cd7e4ef47b36b24646e060186d3941d75c46b7 Mon Sep 17 00:00:00 2001
From: pallav_fdsi <Pallav Negi@pallav-fdsi.fdsi-private.fielddiagnostics.com>
Date: Wed, 1 Jul 2015 18:38:43 -0400
Subject: [PATCH 2/2] Open redirect attacks should be caught for all functions
 that use the _next variable (for example: logout()) instead of just for the
 login() function.

---
 gluon/tools.py | 10 ++++++----
 1 file changed, 6 insertions(+), 4 deletions(-)

diff --git a/gluon/tools.py b/gluon/tools.py
index 746c9ddb0..f2b044614 100644
--- a/gluon/tools.py
+++ b/gluon/tools.py
@@ -1541,6 +1541,12 @@ def get_vars_next(self):
         next = current.request.vars._next
         if isinstance(next, (list, tuple)):
             next = next[0]
+        if next and self.settings.prevent_open_redirect_attacks:
+            # Prevent an attacker from adding an arbitrary url after the
+            # _next variable in the request.
+            items = next.split('/')
+            if '//' in next and items[2] != current.request.env.http_host:
+                next = None            
         return next
 
     def _get_user_id(self):
@@ -2513,10 +2519,6 @@ def login(self,
 
         ### use session for federated login
         snext = self.get_vars_next()
-        if snext and self.settings.prevent_open_redirect_attacks:
-            items = snext.split('/')
-            if '//' in snext and items[2] != request.env.http_host:
-                snext = None
 
         if snext:
             session._auth_next = snext
