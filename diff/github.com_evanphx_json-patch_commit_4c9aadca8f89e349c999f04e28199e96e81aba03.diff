From 4c9aadca8f89e349c999f04e28199e96e81aba03 Mon Sep 17 00:00:00 2001
From: Guoliang Wang <iamwgliang@gmail.com>
Date: Fri, 25 May 2018 17:49:20 +0800
Subject: [PATCH] fix check idx index

---
 patch.go      | 4 +++-
 patch_test.go | 4 ++++
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/patch.go b/patch.go
index 755d8ba..1a3aa38 100644
--- a/patch.go
+++ b/patch.go
@@ -397,7 +397,9 @@ func (d *partialArray) add(key string, val *lazyNode) error {
 		}
 		idx = len(ary) - idx
 	}
-
+	if idx < 0 || idx >= len(ary) || idx > len(cur) {
+		return fmt.Errorf("Unable to access invalid index: %d", idx)
+	}
 	copy(ary[0:idx], cur[0:idx])
 	ary[idx] = val
 	copy(ary[idx+1:], cur[idx:])
diff --git a/patch_test.go b/patch_test.go
index c5e69c6..b6b39f7 100644
--- a/patch_test.go
+++ b/patch_test.go
@@ -227,6 +227,10 @@ var BadCases = []BadCase{
 		`{ "name":{ "foo": "bat", "qux": "bum"}}`,
 		`[ { "op": "replace", "path": "/foo/bar", "value":"baz"}]`,
 	},
+	{
+		`{ "foo": ["bar"]}`,
+		`[ {"op": "add", "path": "/foo/2", "value": "bum"}]`,
+	},
 }
 
 func TestAllCases(t *testing.T) {
