From 99798bd9a41bd3d03fdc1e949810a38967f20ed3 Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Mon, 6 Feb 2017 11:24:42 -0800
Subject: [PATCH] CVE-2017-12987/IEEE 802.11: Fix processing of TIM IE.

The arguments to memcpy() were completely wrong.

This fixes a buffer over-read discovered by Kamil Frankowicz.

Add a test using the capture file supplied by Brian 'geeknik' Carpenter.
---
 print-802_11.c                    |   3 +--
 tests/TESTLIST                    |   1 +
 tests/ieee802.11_tim_ie_oobr.out  |   4 ++++
 tests/ieee802.11_tim_ie_oobr.pcap | Bin 0 -> 385 bytes
 4 files changed, 6 insertions(+), 2 deletions(-)
 create mode 100644 tests/ieee802.11_tim_ie_oobr.out
 create mode 100644 tests/ieee802.11_tim_ie_oobr.pcap

diff --git a/print-802_11.c b/print-802_11.c
index 1bbe47ace..17c1f70cb 100644
--- a/print-802_11.c
+++ b/print-802_11.c
@@ -1189,8 +1189,7 @@ parse_elements(netdissect_options *ndo,
 			offset += 3;
 			length -= 3;
 
-			memcpy(tim.bitmap, p + (tim.length - 3),
-			    (tim.length - 3));
+			memcpy(tim.bitmap, p + offset + 3, tim.length - 3);
 			offset += tim.length - 3;
 			length -= tim.length - 3;
 			/*
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 0829e90d2..bfd58991d 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -435,6 +435,7 @@ atm-heapoverflow	atm-heapoverflow.pcap		atm-heapoverflow.out		-c1 -e
 ipv6-next-header-oobr-1	ipv6-next-header-oobr-1.pcap	ipv6-next-header-oobr-1.out
 ipv6-next-header-oobr-2	ipv6-next-header-oobr-2.pcap	ipv6-next-header-oobr-2.out
 ipv6-rthdr-oobr		ipv6-rthdr-oobr.pcap		ipv6-rthdr-oobr.out
+ieee802.11_tim_ie_oobr	ieee802.11_tim_ie_oobr.pcap	ieee802.11_tim_ie_oobr.out
 
 # bad packets from Kamil Frankowicz
 snmp-heapoverflow-1	snmp-heapoverflow-1.pcap	snmp-heapoverflow-1.out
diff --git a/tests/ieee802.11_tim_ie_oobr.out b/tests/ieee802.11_tim_ie_oobr.out
new file mode 100644
index 000000000..526868371
--- /dev/null
+++ b/tests/ieee802.11_tim_ie_oobr.out
@@ -0,0 +1,4 @@
+ReAssoc Response AID(3030) : PRIVACY : n/a[|802.11]
+ReAssoc Response AID(3030) : PRIVACY : n/a[|802.11]
+[|802.11]
+ReAssoc Response AID(3030) : PRIVACY : n/a[|802.11]
diff --git a/tests/ieee802.11_tim_ie_oobr.pcap b/tests/ieee802.11_tim_ie_oobr.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..bb05c81f75efd9cd1f1073dcc015113cfad655cc
GIT binary patch
literal 385
zcmca|c+)~A1{MYbD9B@AV8~>Ea}C0Pe3%^VXiai$;linL0ZtiYZ?GbB280a&7|TZ{

literal 0
HcmV?d00001

