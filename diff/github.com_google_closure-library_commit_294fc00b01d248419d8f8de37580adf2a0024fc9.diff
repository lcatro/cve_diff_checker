From 294fc00b01d248419d8f8de37580adf2a0024fc9 Mon Sep 17 00:00:00 2001
From: James Wright <jameswr@google.com>
Date: Fri, 13 Mar 2020 13:23:57 -0700
Subject: [PATCH] Fix authority parsing in Closure URI parser. RELNOTES: Fix
 authority parsing in Closure URI parser.

PiperOrigin-RevId: 300815722
---
 closure/goog/uri/utils.js      | 18 ++++++++++++------
 closure/goog/uri/utils_test.js | 13 +++++++++++++
 2 files changed, 25 insertions(+), 6 deletions(-)

diff --git a/closure/goog/uri/utils.js b/closure/goog/uri/utils.js
index c89d80362a..48e42c2b6f 100644
--- a/closure/goog/uri/utils.js
+++ b/closure/goog/uri/utils.js
@@ -173,25 +173,31 @@ goog.uri.utils.buildFromEncodedParts = function(
  *    $6 = <undefined>       query without ?
  *    $7 = Related           fragment without #
  * </pre>
+ *
+ * TODO(user): separate out the authority terminating characters once this
+ * file is moved to ES6.
  * @type {!RegExp}
  * @private
  */
 goog.uri.utils.splitRe_ = new RegExp(
-    '^' +
+    '^' +  // Anchor against the entire string.
     '(?:' +
     '([^:/?#.]+)' +  // scheme - ignore special characters
                      // used by other URL parts such as :,
                      // ?, /, #, and .
     ':)?' +
     '(?://' +
-    '(?:([^/?#]*)@)?' +  // userInfo
-    '([^/#?]*?)' +       // domain
-    '(?::([0-9]+))?' +   // port
-    '(?=[/\\\\#?]|$)' +  // authority-terminating character
+    '(?:([^\\\\/?#]*)@)?' +  // userInfo
+    '([^\\\\/?#]*?)' +       // domain
+    '(?::([0-9]+))?' +       // port
+    '(?=[\\\\/?#]|$)' +      // authority-terminating character.
     ')?' +
     '([^?#]+)?' +          // path
     '(?:\\?([^#]*))?' +    // query
-    '(?:#([\\s\\S]*))?' +  // fragment
+    '(?:#([\\s\\S]*))?' +  // fragment. Can't use '.*' with 's' flag as Firefox
+                           // doesn't support the flag, and can't use an
+                           // "everything set" ([^]) as IE10 doesn't match any
+                           // characters with it.
     '$');
 
 
diff --git a/closure/goog/uri/utils_test.js b/closure/goog/uri/utils_test.js
index 6ebefa0009..fbc1fb143a 100644
--- a/closure/goog/uri/utils_test.js
+++ b/closure/goog/uri/utils_test.js
@@ -111,6 +111,19 @@ testSuite({
     assertNull(utils.getFragment(uri));
   },
 
+  testSplitMaliciousUriUsername() {
+    const uri = 'https://malicious.com\\@test.google.com';
+    assertEquals('https', utils.getScheme(uri));
+    assertEquals('malicious.com', utils.getDomain(uri));
+    assertEquals('malicious.com', utils.getDomainEncoded(uri));
+    assertNull(utils.getPort(uri));
+    assertEquals('\\@test.google.com', utils.getPathEncoded(uri));
+    assertEquals('\\@test.google.com', utils.getPath(uri));
+    assertNull(utils.getQueryData(uri));
+    assertNull(utils.getFragmentEncoded(uri));
+    assertNull(utils.getFragment(uri));
+  },
+
   testSplitBadAuthority() {
     // This URL has a syntax error per the RFC (port number must be digits, and
     // host cannot contain a colon except in [...]). This test is solely to
