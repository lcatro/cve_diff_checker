From 950d9e0e4ee46efa41e791eac6cd55d2f558c3c9 Mon Sep 17 00:00:00 2001
From: Robert Wetzlmayr <r.wetzlmayr@gmail.com>
Date: Fri, 16 Oct 2015 16:46:58 +0200
Subject: [PATCH] Do not allow unprivileged authors to modify an existing
 article's markup setting.

Refs #558.
---
 textpattern/include/txp_article.php | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/textpattern/include/txp_article.php b/textpattern/include/txp_article.php
index ff88604e88..a1de6a6ddb 100644
--- a/textpattern/include/txp_article.php
+++ b/textpattern/include/txp_article.php
@@ -327,7 +327,7 @@ function article_save()
 
     $incoming = array_map('assert_string', psa($vars));
 
-    $oldArticle = safe_row('Status, url_title, Title, '.
+    $oldArticle = safe_row('Status, url_title, Title, textile_body, textile_excerpt, '.
         'unix_timestamp(LastMod) as sLastMod, LastModID, '.
         'unix_timestamp(Posted) as sPosted, '.
         'unix_timestamp(Expires) as sExpires',
@@ -351,7 +351,8 @@ function article_save()
     }
 
     if (!has_privs('article.set_markup')) {
-        $incoming['textile_body'] = $incoming['textile_excerpt'] = $use_textile;
+        $incoming['textile_body'] = $oldArticle['textile_body'];
+        $incoming['textile_excerpt'] = $oldArticle['textile_excerpt'];
     }
 
     $incoming = textile_main_fields($incoming);
@@ -749,6 +750,12 @@ function article_edit($message = '', $concurrent = false, $refresh_partials = fa
             if ($concurrent) {
                 $store_out['sLastMod'] = safe_field('unix_timestamp(LastMod) as sLastMod', 'textpattern', 'ID='.$ID);
             }
+
+            if (!has_privs('article.set_markup')) {
+                $oldArticle = safe_row('textile_body, textile_excerpt', 'textpattern', 'ID = '.$ID);
+                $store_out['textile_body'] = $oldArticle['textile_body'];
+                $store_out['textile_excerpt'] = $oldArticle['textile_excerpt'];
+            }
         }
 
         // Use preferred Textfilter as default and fallback.
