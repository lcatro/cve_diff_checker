From a1f17693904ed6fecc8902c747fc50a8f20e6af8 Mon Sep 17 00:00:00 2001
From: Michal Vasko <mvasko@cesnet.cz>
Date: Fri, 29 Mar 2019 14:41:11 +0100
Subject: [PATCH] yang parser BUGFIX allocate more patterns than currently
 needed

Fixes #740
---
 src/parser_yang_bis.c | 3 +++
 src/yang.y.in         | 3 +++
 2 files changed, 6 insertions(+)

diff --git a/src/parser_yang_bis.c b/src/parser_yang_bis.c
index 42f285821..495917aee 100644
--- a/src/parser_yang_bis.c
+++ b/src/parser_yang_bis.c
@@ -4623,6 +4623,9 @@ YYLTYPE yylloc = yyloc_default;
                                                                             !(data_node && data_node->nodetype != LYS_GROUPING && lys_ingrouping(data_node))) {
                                                                           unsigned int c = 2 * (((struct yang_type *)(yyvsp[-2].backup_token).actual)->type->info.str.pat_count - 1);
                                                                           YANG_ADDELEM(((struct yang_type *)(yyvsp[-2].backup_token).actual)->type->info.str.patterns_pcre, c, "patterns");
+                                                                          ++c;
+                                                                          YANG_ADDELEM(((struct yang_type *)(yyvsp[-2].backup_token).actual)->type->info.str.patterns_pcre, c, "patterns");
+                                                                          actual = &(((struct yang_type *)(yyvsp[-2].backup_token).actual)->type->info.str.patterns_pcre)[2 * (((struct yang_type *)(yyvsp[-2].backup_token).actual)->type->info.str.pat_count - 1)];
                                                                         }
 #endif
                                                                         if (yang_read_pattern(trg->ctx, pattern, actual, (yyvsp[-1].str), (yyvsp[0].ch))) {
diff --git a/src/yang.y.in b/src/yang.y.in
index 25879f6dd..1b88d2340 100644
--- a/src/yang.y.in
+++ b/src/yang.y.in
@@ -1517,6 +1517,9 @@ pattern_stmt: PATTERN_KEYWORD pattern_sep pattern_arg_str pattern_end  {struct l
                                                                             !(data_node && data_node->nodetype != LYS_GROUPING && lys_ingrouping(data_node))) {
                                                                           unsigned int c = 2 * (((struct yang_type *)$2.actual)->type->info.str.pat_count - 1);
                                                                           YANG_ADDELEM(((struct yang_type *)$2.actual)->type->info.str.patterns_pcre, c, "patterns");
+                                                                          ++c;
+                                                                          YANG_ADDELEM(((struct yang_type *)$2.actual)->type->info.str.patterns_pcre, c, "patterns");
+                                                                          actual = &(((struct yang_type *)$2.actual)->type->info.str.patterns_pcre)[2 * (((struct yang_type *)$2.actual)->type->info.str.pat_count - 1)];
                                                                         }
 #endif
                                                                         if (yang_read_pattern(trg->ctx, pattern, actual, $3, $4)) {
