From cb95b05cdb2609052207af07b4b8dfe3a23c11dc Mon Sep 17 00:00:00 2001
From: Sam Pohlenz <sam@sampohlenz.com>
Date: Mon, 12 Apr 2021 19:42:49 +0930
Subject: [PATCH] Ensure CSRF protection is prepended before authentication
 before_actions

---
 lib/trestle/auth/controller/authentication.rb | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/lib/trestle/auth/controller/authentication.rb b/lib/trestle/auth/controller/authentication.rb
index d37fc9b..0b0462b 100644
--- a/lib/trestle/auth/controller/authentication.rb
+++ b/lib/trestle/auth/controller/authentication.rb
@@ -9,6 +9,9 @@ module Authentication
 
           prepend_before_action :require_authenticated_user
           prepend_before_action :authenticate_user
+
+          # Ensure that CSRF protection happens before authentication
+          protect_from_forgery prepend: true
         end
 
       protected
