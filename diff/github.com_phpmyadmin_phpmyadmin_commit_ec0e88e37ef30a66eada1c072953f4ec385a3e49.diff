From ec0e88e37ef30a66eada1c072953f4ec385a3e49 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Mon, 18 Jan 2016 09:49:15 +0100
Subject: [PATCH] Use hash_equals for comparing token
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 libraries/common.inc.php | 2 +-
 libraries/core.lib.php   | 9 +++++++++
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/libraries/common.inc.php b/libraries/common.inc.php
index 97675849ccc..2675b8998d3 100644
--- a/libraries/common.inc.php
+++ b/libraries/common.inc.php
@@ -474,7 +474,7 @@
 $token_provided = false;
 if (PMA_isValid($_REQUEST['token'])) {
     $token_provided = true;
-    $token_mismatch = ($_SESSION[' PMA_token '] != $_REQUEST['token']);
+    $token_mismatch = ! hash_equals($_SESSION[' PMA_token '], $_REQUEST['token']);
 }
 
 if ($token_mismatch) {
diff --git a/libraries/core.lib.php b/libraries/core.lib.php
index 3877548c345..bb8b116b498 100644
--- a/libraries/core.lib.php
+++ b/libraries/core.lib.php
@@ -998,3 +998,12 @@ function PMA_setGlobalDbOrTable($param)
         $GLOBALS['url_params'][$param] = $GLOBALS[$param];
     }
 }
+
+/* Compatibility with PHP < 5.6 */
+if(! function_exists('hash_equals')) {
+    function hash_equals($a, $b) {
+        $ret = strlen($a) ^ strlen($b);
+        $ret |= array_sum(unpack("C*", $a ^ $b));
+        return ! $ret;
+    }
+}
