From b82be896b00a787ed46a77bd4700e8fccfe2e5ba Mon Sep 17 00:00:00 2001
From: Thomas Gerbet <thomas.gerbet@enalean.com>
Date: Tue, 7 Dec 2021 16:05:44 +0100
Subject: [PATCH] request #24202: SQL injection via the user settings of the
 CVS commits browser

Change-Id: I9dff1d45d703de5c9a55182d673a70c21ea53d89
---
 src/www/cvs/commit_utils.php | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/src/www/cvs/commit_utils.php b/src/www/cvs/commit_utils.php
index bd62c35476b..29881fb99b5 100644
--- a/src/www/cvs/commit_utils.php
+++ b/src/www/cvs/commit_utils.php
@@ -713,12 +713,12 @@ function cvs_get_revisions($project, $offset, $chunksz, $_tag = 100, $_branch =
     $query          = "SELECT id from cvs_repositories where cvs_repositories.repository='$cvs_repository' ";
     $rs             = db_query($query);
     $repo_id        = db_result($rs, 0, 0);
-    $repo_id        = $repo_id ? $repo_id : -1;
+    $repo_id        = db_ei($repo_id ? $repo_id : -1);
 
     $select = 'SELECT distinct cvs_checkins.commitid as id, cvs_checkins.commitid as revision, cvs_descs.id as did, cvs_descs.description, cvs_commits.comm_when as c_when, cvs_commits.comm_when as date, cvs_commits.comm_when as f_when, user.user_name as who ';
     $from   = "FROM cvs_descs, cvs_checkins, user, cvs_commits ";
     $where  = "WHERE cvs_checkins.descid=cvs_descs.id " .
-    "AND " . (check_cvs_access(user_getname(), $project->getUnixName(false), '') ? 1 : 0) . " " .
+    "AND " . db_ei(check_cvs_access(user_getname(), $project->getUnixName(false), '') ? 1 : 0) . " " .
         "AND cvs_checkins.commitid=cvs_commits.id " .
         "AND user.user_id=cvs_checkins.whoid " .
             "AND cvs_checkins.repositoryid=" . $repo_id . " " .
@@ -729,7 +729,7 @@ function cvs_get_revisions($project, $offset, $chunksz, $_tag = 100, $_branch =
 
     $limit = '';
     if (! $pv) {
-        $limit = " LIMIT $offset,$chunksz";
+        $limit = " LIMIT " . db_ei($offset) . ',' . db_ei($chunksz);
     }
 
     if (empty($order_by)) {
