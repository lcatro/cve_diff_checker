From 8f3bdd9f7d0708466e011253064a867ca2b271a5 Mon Sep 17 00:00:00 2001
From: Johan Cwiklinski <johan@x-tnd.be>
Date: Fri, 26 Mar 2021 15:20:43 +0100
Subject: [PATCH] Fix stored XSS on dynamic fields configuration

---
 galette/lib/Galette/DynamicFields/DynamicField.php     |  2 +-
 galette/lib/Galette/Entity/TranslatableTrait.php       |  4 ++--
 galette/templates/default/configurer_fiche_content.tpl | 10 +++++-----
 3 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/galette/lib/Galette/DynamicFields/DynamicField.php b/galette/lib/Galette/DynamicFields/DynamicField.php
index b825df3cf..cb58df00b 100644
--- a/galette/lib/Galette/DynamicFields/DynamicField.php
+++ b/galette/lib/Galette/DynamicFields/DynamicField.php
@@ -698,7 +698,7 @@ public function store($values)
 
         try {
             $values = array(
-                'field_name'        => $this->name,
+                'field_name'        => strip_tags($this->name),
                 'field_perm'        => $this->perm,
                 'field_required'    => $this->required,
                 'field_width'       => ($this->width === null ? new Expression('NULL') : $this->width),
diff --git a/galette/lib/Galette/Entity/TranslatableTrait.php b/galette/lib/Galette/Entity/TranslatableTrait.php
index 0194792ab..3007a0539 100644
--- a/galette/lib/Galette/Entity/TranslatableTrait.php
+++ b/galette/lib/Galette/Entity/TranslatableTrait.php
@@ -66,9 +66,9 @@ trait TranslatableTrait
     public function getName($translated = true)
     {
         if ($translated === true) {
-            return _T($this->name);
+            return _T(strip_tags($this->name));
         } else {
-            return $this->name;
+            return strip_tags($this->name);
         }
     }
 }
diff --git a/galette/templates/default/configurer_fiche_content.tpl b/galette/templates/default/configurer_fiche_content.tpl
index 477d78681..dc14d9075 100644
--- a/galette/templates/default/configurer_fiche_content.tpl
+++ b/galette/templates/default/configurer_fiche_content.tpl
@@ -27,21 +27,21 @@
                             class="tooltip action"
                         >
                             <i class="fas fa-user-edit fa-fw" aria-hidden="true"></i>
-                            <span class="sr-only">{_T string="Edit '%s' field" pattern="/%s/" replace=$field->getName()}</span>
+                            <span class="sr-only">{_T string="Edit '%s' field" pattern="/%s/" replace=$field->getName()|escape}</span>
                         </a>
                         <a
                             href="{path_for name="dynamicTranslations" data=["text_orig" => {$field->getName(false)|escape}]}"
                             class="tooltip"
                         >
                             <i class="fas fa-language fa-fw" aria-hidden="true"></i>
-                            <span class="sr-only">{_T string="Translate '%s' field" pattern="/%s/" replace=$field->getName()}</span>
+                            <span class="sr-only">{_T string="Translate '%s' field" pattern="/%s/" replace=$field->getName()|escape}</span>
                         </a>
                         <a
                             href="{path_for name="removeDynamicField" data=["form_name" => $form_name, "id" => $field->getId()]}"
                             class="delete tooltip"
                         >
                             <i class="fas fa-trash" aria-hidden="true"></i>
-                            <span class="sr-only">{_T string="Delete '%s' field" pattern="/%s/" replace=$field->getName()}</span>
+                            <span class="sr-only">{_T string="Delete '%s' field" pattern="/%s/" replace=$field->getName()|escape}</span>
                         </a>
     {if $field->getIndex() eq 1}
                         <i class="fas fa-fw">&nbsp;</i>
@@ -51,7 +51,7 @@
                             class="tooltip action"
                         >
                             <i class="fas fa-caret-up fa-fw"></i>
-                            <span class="sr-only">{_T string="Move up '%s' field" pattern="/%s/" replace=$field->getName()}</span>
+                            <span class="sr-only">{_T string="Move up '%s' field" pattern="/%s/" replace=$field->getName()|escape}</span>
                         </a>
     {/if}
     {if $field->getIndex() eq $fields_list|@count}
@@ -62,7 +62,7 @@
                             class="tooltip"
                         >
                             <i class="fas fa-caret-down fa-fw"></i>
-                            <span class="sr-only">{_T string="Move down '%s' field" pattern="/%s/" replace=$field->getName()}</span>
+                            <span class="sr-only">{_T string="Move down '%s' field" pattern="/%s/" replace=$field->getName()|escape}</span>
                         </a>
     {/if}
                     </td>
