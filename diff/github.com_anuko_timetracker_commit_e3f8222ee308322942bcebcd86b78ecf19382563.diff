From e3f8222ee308322942bcebcd86b78ecf19382563 Mon Sep 17 00:00:00 2001
From: Nik Okuntseff <support@anuko.com>
Date: Mon, 12 Apr 2021 17:14:30 +0000
Subject: [PATCH] Tested CSRF fix for custom ports - it's working, also removed
 unnecessary logging.

---
 WEB-INF/config.php.dist    | 2 +-
 WEB-INF/lib/common.lib.php | 5 +----
 initialize.php             | 2 +-
 3 files changed, 3 insertions(+), 6 deletions(-)

diff --git a/WEB-INF/config.php.dist b/WEB-INF/config.php.dist
index 1b7b32b0..3787cbc9 100644
--- a/WEB-INF/config.php.dist
+++ b/WEB-INF/config.php.dist
@@ -165,7 +165,7 @@ define('AUTH_MODULE', 'db');
 
 // HTTP_TARGET - defines http target for cross site request forgery protection.
 // It can be used when you access the application via a proxy.
-// define('HTTP_TARGET', 'localhost');
+// define('HTTP_TARGET', 'localhost:8080');
 
 
 // Group managers can set monthly work hour quota for years between the following  values.
diff --git a/WEB-INF/lib/common.lib.php b/WEB-INF/lib/common.lib.php
index 52589c6e..d5b43f57 100644
--- a/WEB-INF/lib/common.lib.php
+++ b/WEB-INF/lib/common.lib.php
@@ -414,15 +414,12 @@ function ttMitigateCSRF() {
       $origin = substr($origin, 0, $pos); // Leave host only.
     }
   }
-  error_log("origin: ".$origin);
   $target = defined('HTTP_TARGET') ? HTTP_TARGET : $_SERVER['HTTP_HOST'];
-  error_log("target: ".$target);
   if (strcmp($origin, $target)) {
     error_log("Potential cross site request forgery. Origin: '$origin' does not match target: '$target'.");
-    return false; // Origin and target do not match,
+    return false; // Origin and target do not match.
   }
 
-  // TODO: review and improve this function for custom ports.
   return true;
 }
 
diff --git a/initialize.php b/initialize.php
index aadc0bb0..e8588857 100644
--- a/initialize.php
+++ b/initialize.php
@@ -13,7 +13,7 @@
 ini_set('display_errors', 'Off');
 
 // require_once('init_auth.php');
-define("APP_VERSION", "1.19.27.5431");
+define("APP_VERSION", "1.19.27.5432");
 define("APP_DIR", dirname(__FILE__));
 define("LIBRARY_DIR", APP_DIR."/WEB-INF/lib");
 define("TEMPLATE_DIR", APP_DIR."/WEB-INF/templates");
