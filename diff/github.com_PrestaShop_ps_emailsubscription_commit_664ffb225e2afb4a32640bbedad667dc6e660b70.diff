From 3cd31c628dc3abf69ef1bf87f393a194268a09df Mon Sep 17 00:00:00 2001
From: Thomas BACCELLI <tbaccelli@gmail.com>
Date: Thu, 25 Feb 2021 18:37:58 +0100
Subject: [PATCH 1/2] Revert "Accept html tag using a nofilter on conditions in
 emailsubscription module"

This reverts commit 8b31dfb5881e6767671372e2fc412bb42276aab2.
---
 views/templates/front/subscription_execution.tpl     | 2 +-
 views/templates/hook/ps_emailsubscription-column.tpl | 2 +-
 views/templates/hook/ps_emailsubscription.tpl        | 2 +-
 3 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/views/templates/front/subscription_execution.tpl b/views/templates/front/subscription_execution.tpl
index 20434c6..af6a7d7 100644
--- a/views/templates/front/subscription_execution.tpl
+++ b/views/templates/front/subscription_execution.tpl
@@ -32,7 +32,7 @@
   </p>
 
   {if $variables.conditions}
-    <p>{$variables.conditions nofilter}</p>
+    <p>{$variables.conditions}</p>
   {/if}
 
 {/block}
diff --git a/views/templates/hook/ps_emailsubscription-column.tpl b/views/templates/hook/ps_emailsubscription-column.tpl
index 7da8ca0..58a66ce 100644
--- a/views/templates/hook/ps_emailsubscription-column.tpl
+++ b/views/templates/hook/ps_emailsubscription-column.tpl
@@ -31,7 +31,7 @@
   <form action="{$urls.current_url}#blockEmailSubscription_{$hookName}" method="post">
     <input type="email" name="email" value="{$value}" placeholder="{l s='Your e-mail' d='Modules.Emailsubscription.Shop'}" required />
     {if $conditions}
-      <p>{$conditions nofilter}</p>
+      <p>{$conditions}</p>
     {/if}
     {hook h='displayNewsletterRegistration'}
     <input type="hidden" name="blockHookName" value="{$hookName}" />
diff --git a/views/templates/hook/ps_emailsubscription.tpl b/views/templates/hook/ps_emailsubscription.tpl
index d14063b..a0c4d88 100644
--- a/views/templates/hook/ps_emailsubscription.tpl
+++ b/views/templates/hook/ps_emailsubscription.tpl
@@ -31,7 +31,7 @@
   <form action="{$urls.current_url}#blockEmailSubscription_{$hookName}" method="post">
     <input type="email" name="email" value="{$value}" placeholder="{l s='Your e-mail' d='Modules.Emailsubscription.Shop'}" required />
     {if $conditions}
-      <p>{$conditions nofilter}</p>
+      <p>{$conditions}</p>
     {/if}
     {hook h='displayNewsletterRegistration'}
     <input type="hidden" value="{$hookName}" name="blockHookName" />

From 99bd9091d32a8258e8acb10a871f1232346c3ddf Mon Sep 17 00:00:00 2001
From: Thomas BACCELLI <tbaccelli@gmail.com>
Date: Thu, 25 Feb 2021 18:44:29 +0100
Subject: [PATCH 2/2] Escape newsletter conditions

---
 ps_emailsubscription.php | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/ps_emailsubscription.php b/ps_emailsubscription.php
index f8b1066..a62b317 100644
--- a/ps_emailsubscription.php
+++ b/ps_emailsubscription.php
@@ -977,7 +977,9 @@ public function hookAdditionalCustomerFormFields($params)
             array(
                 '[1]' => '<br>',
                 '[2]' => '<em>',
-                '%conditions%' => Configuration::get('NW_CONDITIONS', $this->context->language->id),
+                '%conditions%' => Tools::htmlentitiesUTF8(
+                    Configuration::get('NW_CONDITIONS', $this->context->language->id)
+                ),
                 '[/2]' => '</em>',
             ),
             'Modules.Emailsubscription.Shop'
