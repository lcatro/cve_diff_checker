From 1e440208a8d8bfd71ad7802e6369a136e8bba3dd Mon Sep 17 00:00:00 2001
From: LouisGac <louis.gac@limesurvey.org>
Date: Wed, 24 Jan 2018 15:26:04 +0100
Subject: [PATCH] Fixed issue: no CRSF check for uninstall theme, reported by
 MUSTAFA HASAN

---
 application/controllers/admin/themeoptions.php | 7 ++++---
 application/models/TemplateConfiguration.php   | 6 ++++--
 2 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/application/controllers/admin/themeoptions.php b/application/controllers/admin/themeoptions.php
index a7a9f36528..62941895d9 100644
--- a/application/controllers/admin/themeoptions.php
+++ b/application/controllers/admin/themeoptions.php
@@ -233,8 +233,9 @@ public function importManifest($templatename)
 
     }
 
-    public function uninstall($templatename)
+    public function uninstall()
     {
+        $templatename = Yii::app()->request->getPost('templatename');
         if (Permission::model()->hasGlobalPermission('templates', 'update')) {
             if (!Template::hasInheritance($templatename)) {
                 TemplateConfiguration::uninstall($templatename);
@@ -262,12 +263,12 @@ protected function performAjaxValidation($model)
 
     public function getPreviewTag()
     {
-        $templatename = Yii::app()->request->getPost('templatename');        
+        $templatename = Yii::app()->request->getPost('templatename');
         $oTemplate = TemplateConfiguration::getInstanceFromTemplateName($templatename);
         $previewTag = $oTemplate->getPreview();
         return Yii::app()->getController()->renderPartial(
             '/admin/super/_renderJson',
-            ['data' => ['image' =>  $previewTag]], 
+            ['data' => ['image' =>  $previewTag]],
             false,
             false
         );
diff --git a/application/models/TemplateConfiguration.php b/application/models/TemplateConfiguration.php
index 23b0864d07..dd270338d5 100755
--- a/application/models/TemplateConfiguration.php
+++ b/application/models/TemplateConfiguration.php
@@ -511,7 +511,7 @@ public function getButtons()
             $sOptionUrl    = Yii::app()->getController()->createUrl('admin/themeoptions/sa/update', array("id"=>$this->id));
         }
 
-        $sUninstallUrl = Yii::app()->getController()->createUrl('admin/themeoptions/sa/uninstall/', array("templatename"=>$this->template_name));
+        $sUninstallUrl = Yii::app()->getController()->createUrl('admin/themeoptions/sa/uninstall/');
 
         $sEditorLink = "<a
             id='template_editor_link_".$this->template_name."'
@@ -538,7 +538,9 @@ class='btn btn-default btn-block'>
 
         $sUninstallLink = '<a
             id="remove_fromdb_link_'.$this->template_name.'"
-            data-href="'.$sUninstallUrl.'"
+            data-ajax-url="'.$sUninstallUrl.'"
+            data-post=\'{ "templatename": "'.$this->template_name.'" }\'
+            data-gridid = "yw0"
             data-target="#confirmation-modal"
             data-toggle="modal"
             data-message="'.gT('This will delete all the specific configurations of this theme.').'<br>'.gT('Do you want to continue?').'"
