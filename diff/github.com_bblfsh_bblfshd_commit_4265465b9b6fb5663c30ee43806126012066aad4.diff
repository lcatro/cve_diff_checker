From 4265465b9b6fb5663c30ee43806126012066aad4 Mon Sep 17 00:00:00 2001
From: David ALEXANDRE <david.alexandre@w6d.io>
Date: Wed, 11 Aug 2021 16:54:42 +0200
Subject: [PATCH] untar: add check on link

---
 .gitignore        |  3 +++
 runtime/unpack.go | 15 +++++++++++++++
 2 files changed, 18 insertions(+)

diff --git a/.gitignore b/.gitignore
index 492276e..dcbe550 100644
--- a/.gitignore
+++ b/.gitignore
@@ -1,3 +1,6 @@
+.idea/
+
+
 build
 coverage.txt
 /ostree
diff --git a/runtime/unpack.go b/runtime/unpack.go
index e4d94ee..8f48c51 100644
--- a/runtime/unpack.go
+++ b/runtime/unpack.go
@@ -136,6 +136,14 @@ loop:
 		case tar.TypeLink:
 			target := filepath.Join(dest, hdr.Linkname)
 
+			trueTarget, err := filepath.EvalSymlinks(target)
+			if err != nil {
+				return err
+			}
+			if !strings.HasPrefix(trueTarget, dest) {
+				return fmt.Errorf("hardlink %q -> %q outside destination", target, hdr.Linkname)
+			}
+
 			if !strings.HasPrefix(target, dest) {
 				return fmt.Errorf("invalid hardlink %q -> %q", target, hdr.Linkname)
 			}
@@ -147,6 +155,13 @@ loop:
 		case tar.TypeSymlink:
 			target := filepath.Join(filepath.Dir(path), hdr.Linkname)
 
+			trueTarget, err := filepath.EvalSymlinks(target)
+			if err != nil {
+				return err
+			}
+			if !strings.HasPrefix(trueTarget, dest) {
+				return fmt.Errorf("hardlink %q -> %q outside destination", target, hdr.Linkname)
+			}
 			if !strings.HasPrefix(target, dest) {
 				return fmt.Errorf("invalid symlink %q -> %q", path, hdr.Linkname)
 			}
