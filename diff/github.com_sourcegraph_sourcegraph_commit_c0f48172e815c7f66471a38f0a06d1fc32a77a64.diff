From c0f48172e815c7f66471a38f0a06d1fc32a77a64 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E1=B4=9C=C9=B4=E1=B4=8B=C9=B4=E1=B4=A1=E1=B4=8F=C9=B4?=
 <joe@sourcegraph.com>
Date: Fri, 24 Apr 2020 18:06:39 +0800
Subject: [PATCH] auth: ensure the redirect URL always starts with a single
 slash (#10167)

Co-Authored-By: Keegan Carruthers-Smith <keegan.csmith@gmail.com>
---
 cmd/frontend/auth/redirect.go      |  4 ++++
 cmd/frontend/auth/redirect_test.go | 19 ++++++++++---------
 2 files changed, 14 insertions(+), 9 deletions(-)

diff --git a/cmd/frontend/auth/redirect.go b/cmd/frontend/auth/redirect.go
index eab8345456cf..262cecd66f90 100644
--- a/cmd/frontend/auth/redirect.go
+++ b/cmd/frontend/auth/redirect.go
@@ -2,6 +2,7 @@ package auth
 
 import (
 	"net/url"
+	"path"
 	"strings"
 )
 
@@ -15,6 +16,9 @@ func SafeRedirectURL(urlStr string) string {
 		return "/"
 	}
 
+	// Make sure u.Path always starts with a single slash.
+	u.Path = path.Clean(u.Path)
+
 	// Only take certain known-safe fields.
 	u = &url.URL{Path: u.Path, RawQuery: u.RawQuery}
 	return u.String()
diff --git a/cmd/frontend/auth/redirect_test.go b/cmd/frontend/auth/redirect_test.go
index f7dcb9c64ba5..2229d7870e99 100644
--- a/cmd/frontend/auth/redirect_test.go
+++ b/cmd/frontend/auth/redirect_test.go
@@ -4,15 +4,16 @@ import "testing"
 
 func TestSafeRedirectURL(t *testing.T) {
 	tests := map[string]string{
-		"":               "/",
-		"/":              "/",
-		"a@b.com:c":      "/",
-		"a@b.com/c":      "/",
-		"//a":            "/",
-		"http://a.com/b": "/b",
-		"//a.com/b":      "/b",
-		"//a@b.com/c":    "/c",
-		"/a?b":           "/a?b",
+		"":                   "/",
+		"/":                  "/",
+		"a@b.com:c":          "/",
+		"a@b.com/c":          "/",
+		"//a":                "/",
+		"http://a.com/b":     "/b",
+		"//a.com/b":          "/b",
+		"//a@b.com/c":        "/c",
+		"/a?b":               "/a?b",
+		"//foo//example.com": "/example.com",
 	}
 	for input, want := range tests {
 		got := SafeRedirectURL(input)
