From 5db6a377e0da8dd3884e19d49474c04b1604d36e Mon Sep 17 00:00:00 2001
From: Andrew Welch <andrew@keluli.local>
Date: Thu, 19 Mar 2020 08:47:35 -0400
Subject: [PATCH 1/8] Aliases will now auto-suggest in the Site URL Override
 settings field

---
 src/templates/settings/plugin/_includes/general.twig | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/templates/settings/plugin/_includes/general.twig b/src/templates/settings/plugin/_includes/general.twig
index 3037b145..ebdf046c 100644
--- a/src/templates/settings/plugin/_includes/general.twig
+++ b/src/templates/settings/plugin/_includes/general.twig
@@ -119,6 +119,7 @@
                 label: "Site URL Override"|t("seomatic"),
                 instructions: "SEOmatic uses the Craft `siteUrl` to generate the external URLs.  If you are using it in a non-standard environment, such as a headless GraphQL or ElementAPI server, you can override what it uses for the `siteUrl` below."|t("seomatic"),
                 suggestEnvVars: true,
+                suggestAliases: true,
                 id: "siteUrlOverride",
                 name: "siteUrlOverride",
                 value: settings.siteUrlOverride,

From 933e24772c3d48ab0aec10579bf0fe5ca0f44d61 Mon Sep 17 00:00:00 2001
From: Andrew Welch <andrew@keluli.local>
Date: Thu, 19 Mar 2020 08:53:42 -0400
Subject: [PATCH 2/8] The Site URL Override is now parsed for both aliases and
 environment variables

---
 src/helpers/UrlHelper.php | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/helpers/UrlHelper.php b/src/helpers/UrlHelper.php
index 3cfa711d..3216e29a 100644
--- a/src/helpers/UrlHelper.php
+++ b/src/helpers/UrlHelper.php
@@ -39,6 +39,7 @@ public static function siteUrl(string $path = '', $params = null, string $scheme
     {
         $siteUrl = Seomatic::$settings->siteUrlOverride;
         if (!empty($siteUrl)) {
+            $siteUrl = MetaValue::parseString($siteUrl);
             return rtrim($siteUrl, '/').'/'.ltrim($path, '/');
         }
 

From aba6e86005440e6f3490777630db7dd233376106 Mon Sep 17 00:00:00 2001
From: Andrew Welch <andrew@keluli.local>
Date: Thu, 19 Mar 2020 08:53:48 -0400
Subject: [PATCH 3/8] Version 3.2.49

---
 CHANGELOG.md  | 7 +++++++
 composer.json | 2 +-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/CHANGELOG.md b/CHANGELOG.md
index 13f5c59a..460e136d 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,5 +1,12 @@
 # SEOmatic Changelog
 
+## 3.2.49 - 2020.03.19
+### Added
+* Aliases will now auto-suggest in the Site URL Override settings field
+
+### Fixed
+* The Site URL Override is now parsed for both aliases and environment variables
+
 ## 3.2.48 - 2020.03.18
 ### Added
 * Added batching to sitemap generation so that the memory used is fixed, and no longer dependent on how many sitemap entries are being processed
diff --git a/composer.json b/composer.json
index 9dde5f57..844959c0 100644
--- a/composer.json
+++ b/composer.json
@@ -2,7 +2,7 @@
     "name": "nystudio107/craft-seomatic",
     "description": "SEOmatic facilitates modern SEO best practices & implementation for Craft CMS 3. It is a turnkey SEO system that is comprehensive, powerful, and flexible.",
     "type": "craft-plugin",
-    "version": "3.2.48",
+    "version": "3.2.49",
     "keywords": [
         "craft",
         "cms",

From 759af0dc97678d2152917e3afec01065f3a04aef Mon Sep 17 00:00:00 2001
From: Andrew Welch <andrew@keluli.local>
Date: Tue, 24 Mar 2020 17:29:10 -0400
Subject: [PATCH 4/8] Ensure that URLs are `urldecode`d before attempting to
 use a RegEx to strip tags from them

---
 src/helpers/DynamicMeta.php | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/helpers/DynamicMeta.php b/src/helpers/DynamicMeta.php
index 04cd3668..f9e39ccb 100644
--- a/src/helpers/DynamicMeta.php
+++ b/src/helpers/DynamicMeta.php
@@ -80,6 +80,7 @@ public static function sanitizeUrl(string $url, bool $checkStatus = true): strin
         $url = UrlHelper::stripQueryString($url);
         // HTML decode the entities, then strip out any tags
         $url = html_entity_decode($url, ENT_NOQUOTES, 'UTF-8');
+        $url = urldecode($url);
         $url = strip_tags($url);
 
         // If this is a >= 400 status code, set the canonical URL to nothing

From c63fc79f5e6a032d4113547240f6987b3dfa809e Mon Sep 17 00:00:00 2001
From: Andrew Welch <andrew@keluli.local>
Date: Tue, 24 Mar 2020 17:29:19 -0400
Subject: [PATCH 5/8] Version 3.2.49

---
 CHANGELOG.md | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/CHANGELOG.md b/CHANGELOG.md
index 460e136d..e266bdfe 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -7,6 +7,9 @@
 ### Fixed
 * The Site URL Override is now parsed for both aliases and environment variables
 
+### Security
+* Ensure that URLs are `urldecode`d before attempting to use a RegEx to strip tags from them
+
 ## 3.2.48 - 2020.03.18
 ### Added
 * Added batching to sitemap generation so that the memory used is fixed, and no longer dependent on how many sitemap entries are being processed

From 6ae3f3ab2acef1ba4bd2f910240a119cab30fe57 Mon Sep 17 00:00:00 2001
From: Andrew Welch <andrew@keluli.local>
Date: Tue, 24 Mar 2020 17:33:15 -0400
Subject: [PATCH 6/8] Sanitize the localized URLs too

---
 src/helpers/DynamicMeta.php | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/helpers/DynamicMeta.php b/src/helpers/DynamicMeta.php
index f9e39ccb..a8e377c2 100644
--- a/src/helpers/DynamicMeta.php
+++ b/src/helpers/DynamicMeta.php
@@ -648,6 +648,7 @@ public static function getLocalizedUrls(string $uri = null, int $siteId = null):
             $url = UrlHelper::absoluteUrlWithProtocol($url);
 
             $url = $url ?? '';
+            $url = self::sanitizeUrl($url);
             $language = $site->language;
             $ogLanguage = LocalizationHelper::normalizeOgLocaleLanguage($language);
             $hreflangLanguage = $language;

From 88de8d6361c2357eedeae164f6005edce8f8594b Mon Sep 17 00:00:00 2001
From: Andrew Welch <andrew@keluli.local>
Date: Tue, 24 Mar 2020 17:55:54 -0400
Subject: [PATCH 7/8] SEOmatic now will replace any stripped HTML tags with a
 space, so that the text is more readable

---
 src/helpers/Text.php | 19 +++++++++++++++++--
 1 file changed, 17 insertions(+), 2 deletions(-)

diff --git a/src/helpers/Text.php b/src/helpers/Text.php
index d77aece5..26e7c085 100644
--- a/src/helpers/Text.php
+++ b/src/helpers/Text.php
@@ -128,15 +128,30 @@ public static function extractTextFromField($field): string
             $result = self::extractTextFromTags($field);
         } else {
             if (\is_array($field)) {
-                $result = strip_tags((string)$field[0]);
+                $result = self::smartStripTags((string)$field[0]);
             } else {
-                $result = strip_tags((string)$field);
+                $result = self::smartStripTags((string)$field);
             }
         }
 
         return $result;
     }
 
+    /**
+     * Strip HTML tags, but replace them with a space rather than just eliminating them
+     *
+     * @param $str
+     * @return string
+     */
+    public static function smartStripTags($str)
+    {
+        $str = str_replace('<', ' <', $str);
+        $str = strip_tags($str);
+        $str = str_replace('  ', ' ', $str);
+
+        return $str;
+    }
+
     /**
      * Extract concatenated text from all of the tags in the $tagElement and
      * return as a comma-delimited string

From 863ca55cffb336c92bcabf1a514fcd55b695c9cf Mon Sep 17 00:00:00 2001
From: Andrew Welch <andrew@keluli.local>
Date: Tue, 24 Mar 2020 17:56:08 -0400
Subject: [PATCH 8/8] Version 3.2.49

---
 CHANGELOG.md | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/CHANGELOG.md b/CHANGELOG.md
index e266bdfe..d3438905 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,8 +1,9 @@
 # SEOmatic Changelog
 
-## 3.2.49 - 2020.03.19
+## 3.2.49 - 2020.03.24
 ### Added
 * Aliases will now auto-suggest in the Site URL Override settings field
+* SEOmatic now will replace any stripped HTML tags with a space, so that the text is more readable
 
 ### Fixed
 * The Site URL Override is now parsed for both aliases and environment variables
