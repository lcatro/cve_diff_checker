From 93c385235e824f4b336eab249b2f6598d2fa9ba1 Mon Sep 17 00:00:00 2001
From: Alexander Schranz <alexander@sulu.io>
Date: Wed, 8 Dec 2021 12:10:55 +0100
Subject: [PATCH 1/5] Fix sql injection over property name with semicolon in it

---
 .../DoctrineDBAL/Query/QOMWalker.php          | 30 ++++----
 .../Transport/DoctrineDBAL/ClientTest.php     | 70 ++++++++++++++++++-
 2 files changed, 83 insertions(+), 17 deletions(-)

diff --git a/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php b/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php
index f3d945c7..eb2e9902 100644
--- a/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php
+++ b/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php
@@ -723,10 +723,10 @@ public function walkNumComparisonConstraint(QOM\PropertyValueInterface $property
 
         if ($this->platform instanceof MySQLPlatform && '=' === $operator) {
             return sprintf(
-                '0 != FIND_IN_SET("%s", REPLACE(EXTRACTVALUE(%s.props, \'//sv:property[@sv:name="%s"]/sv:value\'), " ", ","))',
+                '0 != FIND_IN_SET("%s", REPLACE(EXTRACTVALUE(%s.props, \'//sv:property[@sv:name=%s]/sv:value\'), " ", ","))',
                 $literalOperand->getLiteralValue(),
                 $alias,
-                $property
+                Xpath::escape($property)
             );
         }
 
@@ -920,15 +920,15 @@ private function getLiteralValue(QOM\LiteralInterface $operand)
     private function sqlXpathValueExists($alias, $property)
     {
         if ($this->platform instanceof MySQLPlatform) {
-            return "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=\"" . $property . "\"]/sv:value[1])') = 1";
+            return "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1])') = 1";
         }
 
         if ($this->platform instanceof PostgreSQL94Platform || $this->platform instanceof PostgreSqlPlatform) {
-            return "xpath_exists('//sv:property[@sv:name=\"" . $property . "\"]/sv:value[1]', CAST($alias.props AS xml), ".$this->sqlXpathPostgreSQLNamespaces().") = 't'";
+            return "xpath_exists('//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1]', CAST($alias.props AS xml), ".$this->sqlXpathPostgreSQLNamespaces().") = 't'";
         }
 
         if ($this->platform instanceof SqlitePlatform) {
-            return "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=\"" . $property . "\"]/sv:value[1])') = 1";
+            return "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1])') = 1";
         }
 
         throw new NotImplementedException("Xpath evaluations cannot be executed with '" . $this->platform->getName() . "' yet.");
@@ -945,15 +945,15 @@ private function sqlXpathValueExists($alias, $property)
     private function sqlXpathExtractValue($alias, $property, $column = 'props')
     {
         if ($this->platform instanceof MySQLPlatform) {
-            return "EXTRACTVALUE($alias.$column, '//sv:property[@sv:name=\"" . $property . "\"]/sv:value[1]')";
+            return "EXTRACTVALUE($alias.$column, '//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1]')";
         }
 
         if ($this->platform instanceof PostgreSQL94Platform || $this->platform instanceof PostgreSqlPlatform) {
-            return "(xpath('//sv:property[@sv:name=\"" . $property . "\"]/sv:value[1]/text()', CAST($alias.$column AS xml), ".$this->sqlXpathPostgreSQLNamespaces()."))[1]::text";
+            return "(xpath('//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1]/text()', CAST($alias.$column AS xml), ".$this->sqlXpathPostgreSQLNamespaces()."))[1]::text";
         }
 
         if ($this->platform instanceof SqlitePlatform) {
-            return "EXTRACTVALUE($alias.$column, '//sv:property[@sv:name=\"" . $property . "\"]/sv:value[1]')";
+            return "EXTRACTVALUE($alias.$column, '//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1]')";
         }
 
         throw new NotImplementedException("Xpath evaluations cannot be executed with '" . $this->platform->getName() . "' yet.");
@@ -962,7 +962,7 @@ private function sqlXpathExtractValue($alias, $property, $column = 'props')
     private function sqlXpathExtractNumValue($alias, $property)
     {
         if ($this->platform instanceof PostgreSQL94Platform || $this->platform instanceof PostgreSqlPlatform) {
-            return "(xpath('//sv:property[@sv:name=\"" . $property . "\"]/sv:value[1]/text()', CAST($alias.props AS xml), ".$this->sqlXpathPostgreSQLNamespaces()."))[1]::text::int";
+            return "(xpath('//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1]/text()', CAST($alias.props AS xml), ".$this->sqlXpathPostgreSQLNamespaces()."))[1]::text::int";
         }
 
         return 'CAST(' . $this->sqlXpathExtractValue($alias, $property) . ' AS DECIMAL)';
@@ -971,15 +971,15 @@ private function sqlXpathExtractNumValue($alias, $property)
     private function sqlXpathExtractValueAttribute($alias, $property, $attribute, $valueIndex = 1)
     {
         if ($this->platform instanceof MySQLPlatform) {
-            return sprintf("EXTRACTVALUE(%s.props, '//sv:property[@sv:name=\"%s\"]/sv:value[%d]/@%s')", $alias, $property, $valueIndex, $attribute);
+            return sprintf("EXTRACTVALUE(%s.props, '//sv:property[@sv:name=%s]/sv:value[%d]/@%s')", $alias, Xpath::escape($property), $valueIndex, $attribute);
         }
 
         if ($this->platform instanceof PostgreSQL94Platform || $this->platform instanceof PostgreSqlPlatform) {
-            return sprintf("CAST((xpath('//sv:property[@sv:name=\"%s\"]/sv:value[%d]/@%s', CAST(%s.props AS xml), %s))[1]::text AS bigint)", $property, $valueIndex, $attribute, $alias, $this->sqlXpathPostgreSQLNamespaces());
+            return sprintf("CAST((xpath('//sv:property[@sv:name=%s]/sv:value[%d]/@%s', CAST(%s.props AS xml), %s))[1]::text AS bigint)", Xpath::escape($property), $valueIndex, $attribute, $alias, $this->sqlXpathPostgreSQLNamespaces());
         }
 
         if ($this->platform instanceof SqlitePlatform) {
-            return sprintf("EXTRACTVALUE(%s.props, '//sv:property[@sv:name=\"%s\"]/sv:value[%d]/@%s')", $alias, $property, $valueIndex, $attribute);
+            return sprintf("EXTRACTVALUE(%s.props, '//sv:property[@sv:name=%s]/sv:value[%d]/@%s')", $alias, Xpath::escape($property), $valueIndex, $attribute);
         }
 
         throw new NotImplementedException("Xpath evaluations cannot be executed with '" . $this->platform->getName() . "' yet.");
@@ -1001,13 +1001,13 @@ private function sqlXpathComparePropertyValue($alias, $property, $value, $operat
         $expression = null;
 
         if ($this->platform instanceof MySQLPlatform) {
-            $expression = "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=\"" . $property . "\"]/sv:value[text()%s%s]) > 0')";
+            $expression = "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[text()%s%s]) > 0')";
             // mysql does not escape the backslashes for us, while postgres and sqlite do
             $value = Xpath::escapeBackslashes($value);
         } elseif ($this->platform instanceof PostgreSQL94Platform || $this->platform instanceof PostgreSqlPlatform) {
-            $expression = "xpath_exists('//sv:property[@sv:name=\"" . $property . "\"]/sv:value[text()%s%s]', CAST($alias.props AS xml), ".$this->sqlXpathPostgreSQLNamespaces().") = 't'";
+            $expression = "xpath_exists('//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[text()%s%s]', CAST($alias.props AS xml), ".$this->sqlXpathPostgreSQLNamespaces().") = 't'";
         } elseif ($this->platform instanceof SqlitePlatform) {
-            $expression = "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=\"" . $property . "\"]/sv:value[text()%s%s]) > 0')";
+            $expression = "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[text()%s%s]) > 0')";
         } else {
             throw new NotImplementedException("Xpath evaluations cannot be executed with '" . $this->platform->getName() . "' yet.");
         }
diff --git a/tests/Jackalope/Transport/DoctrineDBAL/ClientTest.php b/tests/Jackalope/Transport/DoctrineDBAL/ClientTest.php
index f5b2f6b2..7a909b9b 100644
--- a/tests/Jackalope/Transport/DoctrineDBAL/ClientTest.php
+++ b/tests/Jackalope/Transport/DoctrineDBAL/ClientTest.php
@@ -9,9 +9,11 @@
 use Jackalope\Test\FunctionalTestCase;
 use PDO;
 use PHPCR\PropertyType;
+use PHPCR\Query\QOM\QueryObjectModelConstantsInterface;
 use PHPCR\Query\QueryInterface;
 use PHPCR\Util\NodeHelper;
 use PHPCR\Util\PathHelper;
+use PHPCR\Util\QOM\QueryBuilder;
 use PHPCR\ValueFormatException;
 use ReflectionClass;
 
@@ -435,6 +437,7 @@ public function provideOrder()
                         'value' => 'CCC',
                     ],
                 ],
+                'value',
                 'value DESC',
                 ['three', 'two', 'one'],
             ],
@@ -453,6 +456,7 @@ public function provideOrder()
                     ],
                 ],
                 'value',
+                'value',
                 ['three', 'two', 'one'],
             ],
 
@@ -470,6 +474,7 @@ public function provideOrder()
                     ],
                 ],
                 'value',
+                'value',
                 ['one', 'three', 'two'],
             ],
 
@@ -487,6 +492,7 @@ public function provideOrder()
                     ],
                 ],
                 'value',
+                'value',
                 ['two', 'three', 'one'],
             ],
 
@@ -510,16 +516,53 @@ public function provideOrder()
                         'value' => 5.05,
                     ],
                 ],
+                'value',
                 'title, value ASC',
                 ['two', 'one', 'four', 'three'],
             ],
+
+            // property with double quotes
+            [
+                [
+                    'one' => [
+                        'val"ue' => 'AAA',
+                    ],
+                    'two' => [
+                        'val"ue' => 'BBB',
+                    ],
+                    'three' => [
+                        'val"ue' => 'CCC',
+                    ],
+                ],
+                'val"ue',
+                'val"ue DESC',
+                ['three', 'two', 'one'],
+            ],
+
+            // property with single quotes
+            [
+                [
+                    'one' => [
+                        'val\'ue' => 'AAA',
+                    ],
+                    'two' => [
+                        'val\'ue' => 'BBB',
+                    ],
+                    'three' => [
+                        'val\'ue' => 'CCC',
+                    ],
+                ],
+                'val\'ue',
+                'val\'ue DESC',
+                ['three', 'two', 'one'],
+            ],
         ];
     }
 
     /**
      * @dataProvider provideOrder
      */
-    public function testOrder($nodes, $orderBy, $expectedOrder)
+    public function testOrder($nodes, $propertyName, $orderBy, $expectedOrder)
     {
         $rootNode = $this->session->getNode('/');
 
@@ -533,7 +576,30 @@ public function testOrder($nodes, $orderBy, $expectedOrder)
         $this->session->save();
 
         $qm = $this->session->getWorkspace()->getQueryManager();
-        $query = $qm->createQuery('SELECT * FROM [nt:unstructured] WHERE value IS NOT NULL ORDER BY ' . $orderBy, QueryInterface::JCR_SQL2);
+        $qf = $qm->getQOMFactory();
+        $qb = new QueryBuilder($qf);
+        $qb->from(
+            $qb->qomf()->selector('a', 'nt:unstructured')
+        );
+        $qb->where($qf->comparison(
+            $qf->propertyValue('a', $propertyName),
+            QueryObjectModelConstantsInterface::JCR_OPERATOR_NOT_EQUAL_TO,
+            $qf->literal('NULL')
+        ));
+
+        $orderBys = explode(',', $orderBy);
+        foreach ($orderBys as $orderByItem) {
+            $orderByParts = explode(' ', trim($orderByItem));
+            $propertyName = $orderByParts[0];
+            $order = isset($orderByParts[1]) ? $orderByParts[1] : 'ASC';
+
+            $qb->addOrderBy(
+                $qb->qomf()->propertyValue('a', $propertyName),
+                $order
+            );
+        }
+
+        $query = $qb->getQuery();
         $result = $query->execute();
 
         $rows = $result->getRows();

From 7356f4ca529592aa0e447cda65462662733576f3 Mon Sep 17 00:00:00 2001
From: Alexander Schranz <alexander@sulu.io>
Date: Mon, 13 Dec 2021 11:07:20 +0100
Subject: [PATCH 2/5] Use sprintf for every query

---
 .../Command/InitDoctrineDbalCommand.php       |   4 +-
 .../DoctrineDBAL/Query/QOMWalker.php          | 129 ++++++++++++------
 2 files changed, 86 insertions(+), 47 deletions(-)

diff --git a/src/Jackalope/Tools/Console/Command/InitDoctrineDbalCommand.php b/src/Jackalope/Tools/Console/Command/InitDoctrineDbalCommand.php
index 2d7db081..46802c17 100644
--- a/src/Jackalope/Tools/Console/Command/InitDoctrineDbalCommand.php
+++ b/src/Jackalope/Tools/Console/Command/InitDoctrineDbalCommand.php
@@ -98,7 +98,7 @@ protected function execute(InputInterface $input, OutputInterface $output)
                 try {
                     foreach ($schema->toDropSql($connection->getDatabasePlatform()) as $sql) {
                         if (true === $input->getOption('dump-sql')) {
-                            $output->writeln($sql);
+                            $output->writeln($sql ?: '');
                         } else {
                             $connection->executeStatement($sql);
                         }
@@ -112,7 +112,7 @@ protected function execute(InputInterface $input, OutputInterface $output)
 
             foreach ($schema->toSql($connection->getDatabasePlatform()) as $sql) {
                 if (true === $input->getOption('dump-sql')) {
-                    $output->writeln($sql);
+                    $output->writeln($sql ?: '');
                 } else {
                     $connection->executeStatement($sql);
                 }
diff --git a/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php b/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php
index eb2e9902..56992a71 100644
--- a/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php
+++ b/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php
@@ -385,28 +385,28 @@ public function walkJoinSource(QOM\JoinInterface $source, $root = true)
 
         switch ($source->getJoinType()) {
             case QOM\QueryObjectModelConstantsInterface::JCR_JOIN_TYPE_INNER:
-                $sql .= "INNER JOIN phpcr_nodes $rightAlias ";
+                $sql .= sprintf("INNER JOIN phpcr_nodes %s ", $rightAlias);
                 break;
             case QOM\QueryObjectModelConstantsInterface::JCR_JOIN_TYPE_LEFT_OUTER:
-                $sql .= "LEFT JOIN phpcr_nodes $rightAlias ";
+                $sql .= sprintf("LEFT JOIN phpcr_nodes %s ", $rightAlias);
                 break;
             case QOM\QueryObjectModelConstantsInterface::JCR_JOIN_TYPE_RIGHT_OUTER:
-                $sql .= "RIGHT JOIN phpcr_nodes $rightAlias ";
+                $sql .= sprintf("RIGHT JOIN phpcr_nodes %s ", $rightAlias);
                 break;
         }
 
-        $sql .= "ON ( $leftAlias.workspace_name = $rightAlias.workspace_name AND $nodeTypeClause ";
+        $sql .= sprintf("ON ( %s.workspace_name = %s.workspace_name AND %s ", $leftAlias, $rightAlias, $nodeTypeClause);
         $sql .= 'AND ' . $this->walkJoinCondition($source->getLeft(), $source->getRight(), $source->getJoinCondition()) . ' ';
         $sql .= ') '; // close on-clause
 
 
         if ($root) { // The method call is not recursed when $root is true, so we can add a WHERE clause
             // TODO: revise this part for alternatives
-            $sql .= "WHERE $leftAlias.workspace_name = ? AND $leftAlias.type IN ('" . $left->getNodeTypeName() . "'";
+            $sql .= sprintf("WHERE %s.workspace_name = ? AND %s.type IN ('%s'", $leftAlias, $leftAlias, $left->getNodeTypeName());
             $subTypes = $this->nodeTypeManager->getSubtypes($left->getNodeTypeName());
             foreach ($subTypes as $subType) {
                 /* @var $subType NodeTypeInterface */
-                $sql .= ", '" . $subType->getName() . "'";
+                $sql .= sprintf(", '%s'", $subType->getName());
             }
             $sql .= ')';
         }
@@ -455,7 +455,7 @@ public function walkChildNodeJoinCondition(QOM\ChildNodeJoinConditionInterface $
         $leftAlias = $this->getTableAlias($condition->getParentSelectorName());
         $concatExpression = $this->platform->getConcatExpression("$leftAlias.path", "'/%'");
 
-        return "($rightAlias.path LIKE " . $concatExpression . " AND $rightAlias.depth = $leftAlias.depth + 1) ";
+        return sprintf("(%s.path LIKE %s AND %s.depth = %s.depth + 1) ", $rightAlias, $concatExpression, $rightAlias, $leftAlias);
     }
 
     /**
@@ -469,7 +469,7 @@ public function walkDescendantNodeJoinCondition(QOM\DescendantNodeJoinConditionI
         $leftAlias = $this->getTableAlias($condition->getAncestorSelectorName());
         $concatExpression = $this->platform->getConcatExpression("$leftAlias.path", "'/%'");
 
-        return "$rightAlias.path LIKE " . $concatExpression . " ";
+        return sprintf("%s.path LIKE %s ", $rightAlias, $concatExpression);
     }
 
     /**
@@ -521,7 +521,7 @@ public function walkConstraint(QOM\ConstraintInterface $constraint)
             return $this->walkFullTextSearchConstraint($constraint);
         }
 
-        throw new InvalidQueryException("Constraint " . get_class($constraint) . " not yet supported.");
+        throw new InvalidQueryException(sprintf("Constraint %s not yet supported.", get_class($constraint)));
     }
 
     /**
@@ -531,7 +531,11 @@ public function walkConstraint(QOM\ConstraintInterface $constraint)
      */
     public function walkSameNodeConstraint(QOM\SameNodeInterface $constraint)
     {
-        return $this->getTableAlias($constraint->getSelectorName()) . ".path = '" . $constraint->getPath() . "'";
+        return sprintf(
+            "%s.path = '%s'",
+            $this->getTableAlias($constraint->getSelectorName()),
+            $constraint->getPath()
+        );
     }
 
     /**
@@ -541,7 +545,10 @@ public function walkSameNodeConstraint(QOM\SameNodeInterface $constraint)
      */
     public function walkFullTextSearchConstraint(QOM\FullTextSearchInterface $constraint)
     {
-        return $this->sqlXpathExtractValue($this->getTableAlias($constraint->getSelectorName()), $constraint->getPropertyName()).' LIKE '. $this->conn->quote('%'.$constraint->getFullTextSearchExpression().'%');
+        return sprintf('%s LIKE %s',
+            $this->sqlXpathExtractValue($this->getTableAlias($constraint->getSelectorName()), $constraint->getPropertyName()),
+            $this->conn->quote('%'.$constraint->getFullTextSearchExpression().'%')
+        );
     }
 
     /**
@@ -568,7 +575,11 @@ public function walkDescendantNodeConstraint(QOM\DescendantNodeInterface $constr
             throw new InvalidQueryException("Trailing slash in $ancestorPath");
         }
 
-        return $this->getTableAlias($constraint->getSelectorName()) . ".path LIKE '" . $ancestorPath . "/%'";
+        return sprintf(
+            "%s.path LIKE '%s/%%'",
+            $this->getTableAlias($constraint->getSelectorName()),
+            $ancestorPath
+        );
     }
 
     /**
@@ -578,7 +589,11 @@ public function walkDescendantNodeConstraint(QOM\DescendantNodeInterface $constr
      */
     public function walkChildNodeConstraint(QOM\ChildNodeInterface $constraint)
     {
-        return $this->getTableAlias($constraint->getSelectorName()) . ".parent = '" . $constraint->getParentPath() . "'";
+        return sprintf(
+            "%s.parent = '%s'",
+            $this->getTableAlias($constraint->getSelectorName()),
+            $constraint->getParentPath()
+        );
     }
 
     /**
@@ -588,7 +603,11 @@ public function walkChildNodeConstraint(QOM\ChildNodeInterface $constraint)
      */
     public function walkAndConstraint(QOM\AndInterface $constraint)
     {
-        return "(" . $this->walkConstraint($constraint->getConstraint1()) . " AND " . $this->walkConstraint($constraint->getConstraint2()) . ")";
+        return sprintf(
+            "(%s AND %s)",
+            $this->walkConstraint($constraint->getConstraint1()),
+            $this->walkConstraint($constraint->getConstraint2())
+        );
     }
 
     /**
@@ -598,7 +617,11 @@ public function walkAndConstraint(QOM\AndInterface $constraint)
      */
     public function walkOrConstraint(QOM\OrInterface $constraint)
     {
-        return "(" . $this->walkConstraint($constraint->getConstraint1()) . " OR " . $this->walkConstraint($constraint->getConstraint2()) . ")";
+        return sprintf(
+            "(%s OR %s)",
+            $this->walkConstraint($constraint->getConstraint1()),
+            $this->walkConstraint($constraint->getConstraint2())
+        );
     }
 
     /**
@@ -608,7 +631,10 @@ public function walkOrConstraint(QOM\OrInterface $constraint)
      */
     public function walkNotConstraint(QOM\NotInterface $constraint)
     {
-        return "NOT (" . $this->walkConstraint($constraint->getConstraint()) . ")";
+        return sprintf(
+            "NOT (%s)",
+            $this->walkConstraint($constraint->getConstraint())
+        );
     }
 
     /**
@@ -670,9 +696,16 @@ public function walkComparisonConstraint(QOM\ComparisonInterface $constraint)
                     $literal = implode(':', $parts);
                 }
 
-                return $this->platform->getConcatExpression("$alias.namespace", "(CASE $alias.namespace WHEN '' THEN '' ELSE ':' END)", "$alias.local_name") . " " .
-                    $operator . " " .
-                    $this->conn->quote($literal);
+                return sprintf(
+                    '%s %s %s',
+                    $this->platform->getConcatExpression(
+                        sprintf("%s.namespace", $alias),
+                        sprintf("(CASE %s.namespace WHEN '' THEN '' ELSE ':' END)", $alias),
+                        sprintf("%s.local_name", $alias)
+                    ),
+                    $operator,
+                    $this->conn->quote($literal)
+                ) ;
             }
 
             if ('jcr:path' !== $operand->getPropertyName() && 'jcr:uuid' !== $operand->getPropertyName()) {
@@ -687,10 +720,12 @@ public function walkComparisonConstraint(QOM\ComparisonInterface $constraint)
             }
         }
 
-        return
-            $this->walkOperand($operator1) . ' ' .
-            $operator . ' ' .
-            $this->walkOperand($operator2);
+        return sprintf(
+            '%s %s %s',
+            $this->walkOperand($operator1),
+            $operator,
+            $this->walkOperand($operator2)
+        );
     }
 
     /**
@@ -787,14 +822,18 @@ public function walkOperand(QOM\OperandInterface $operand)
             $selectorName = $operand->getSelectorName();
             $alias = $this->getTableAlias($selectorName);
 
-            return $this->platform->getConcatExpression("$alias.namespace", "(CASE $alias.namespace WHEN '' THEN '' ELSE ':' END)", "$alias.local_name");
+            return $this->platform->getConcatExpression(
+                sprintf("%s.namespace", $alias),
+                sprintf("(CASE %s.namespace WHEN '' THEN '' ELSE ':' END)", $alias),
+                sprintf("%s.local_name", $alias)
+            );
         }
 
         if ($operand instanceof QOM\NodeLocalNameInterface) {
             $selectorName = $operand->getSelectorName();
             $alias = $this->getTableAlias($selectorName);
 
-            return "$alias.local_name";
+            return sprintf("%s.local_name", $alias);
         }
 
         if ($operand instanceof QOM\LowerCaseInterface) {
@@ -813,10 +852,10 @@ public function walkOperand(QOM\OperandInterface $operand)
             $alias = $this->getTableAlias($operand->getSelectorName() . '.' . $operand->getPropertyName());
             $property = $operand->getPropertyName();
             if ($property === 'jcr:path') {
-                return "$alias.path";
+                return sprintf("%s.path", $alias);
             }
             if ($property === "jcr:uuid") {
-                return "$alias.identifier";
+                return sprintf("%s.identifier", $alias);
             }
 
             return $this->sqlXpathExtractValue($alias, $property);
@@ -829,7 +868,7 @@ public function walkOperand(QOM\OperandInterface $operand)
             return $this->sqlXpathExtractValueAttribute($alias, $property, 'length');
         }
 
-        throw new InvalidQueryException("Dynamic operand " . get_class($operand) . " not yet supported.");
+        throw new InvalidQueryException(sprintf("Dynamic operand %s not yet supported.", get_class($operand)));
     }
 
     /**
@@ -920,18 +959,18 @@ private function getLiteralValue(QOM\LiteralInterface $operand)
     private function sqlXpathValueExists($alias, $property)
     {
         if ($this->platform instanceof MySQLPlatform) {
-            return "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1])') = 1";
+            return sprintf("EXTRACTVALUE(%s.props, 'count(//sv:property[@sv:name=%s]/sv:value[1])') = 1", $alias, Xpath::escape($property));
         }
 
         if ($this->platform instanceof PostgreSQL94Platform || $this->platform instanceof PostgreSqlPlatform) {
-            return "xpath_exists('//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1]', CAST($alias.props AS xml), ".$this->sqlXpathPostgreSQLNamespaces().") = 't'";
+            return sprintf("xpath_exists('//sv:property[@sv:name=%s]/sv:value[1]', CAST(%s.props AS xml), ".$this->sqlXpathPostgreSQLNamespaces().") = 't'", Xpath::escape($property), $alias);
         }
 
         if ($this->platform instanceof SqlitePlatform) {
-            return "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1])') = 1";
+            return sprintf("EXTRACTVALUE(%s.props, 'count(//sv:property[@sv:name=%s]/sv:value[1])') = 1", $alias, Xpath::escape($property));
         }
 
-        throw new NotImplementedException("Xpath evaluations cannot be executed with '" . $this->platform->getName() . "' yet.");
+        throw new NotImplementedException(sprintf("Xpath evaluations cannot be executed with '%s' yet.", $this->platform->getName()));
     }
 
     /**
@@ -945,27 +984,27 @@ private function sqlXpathValueExists($alias, $property)
     private function sqlXpathExtractValue($alias, $property, $column = 'props')
     {
         if ($this->platform instanceof MySQLPlatform) {
-            return "EXTRACTVALUE($alias.$column, '//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1]')";
+            return sprintf("EXTRACTVALUE(%s.%s, '//sv:property[@sv:name=%s]/sv:value[1]')", $alias, $column, Xpath::escape($property));
         }
 
         if ($this->platform instanceof PostgreSQL94Platform || $this->platform instanceof PostgreSqlPlatform) {
-            return "(xpath('//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1]/text()', CAST($alias.$column AS xml), ".$this->sqlXpathPostgreSQLNamespaces()."))[1]::text";
+            return sprintf("(xpath('//sv:property[@sv:name=%s]/sv:value[1]/text()', CAST(%s.%s AS xml), %s))[1]::text", Xpath::escape($property), $alias, $column, $this->sqlXpathPostgreSQLNamespaces());
         }
 
         if ($this->platform instanceof SqlitePlatform) {
-            return "EXTRACTVALUE($alias.$column, '//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1]')";
+            return sprintf("EXTRACTVALUE(%s.%s, '//sv:property[@sv:name=%s]/sv:value[1]')", $alias, $column, Xpath::escape($property));
         }
 
-        throw new NotImplementedException("Xpath evaluations cannot be executed with '" . $this->platform->getName() . "' yet.");
+        throw new NotImplementedException(sprintf("Xpath evaluations cannot be executed with '%s' yet.", $this->platform->getName()));
     }
 
     private function sqlXpathExtractNumValue($alias, $property)
     {
         if ($this->platform instanceof PostgreSQL94Platform || $this->platform instanceof PostgreSqlPlatform) {
-            return "(xpath('//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[1]/text()', CAST($alias.props AS xml), ".$this->sqlXpathPostgreSQLNamespaces()."))[1]::text::int";
+            return sprintf("(xpath('//sv:property[@sv:name=%s]/sv:value[1]/text()', CAST(%s.props AS xml), %s))[1]::text::int", Xpath::escape($property), $alias, $this->sqlXpathPostgreSQLNamespaces());
         }
 
-        return 'CAST(' . $this->sqlXpathExtractValue($alias, $property) . ' AS DECIMAL)';
+        return sprintf('CAST(%s AS DECIMAL)', $this->sqlXpathExtractValue($alias, $property));
     }
 
     private function sqlXpathExtractValueAttribute($alias, $property, $attribute, $valueIndex = 1)
@@ -982,7 +1021,7 @@ private function sqlXpathExtractValueAttribute($alias, $property, $attribute, $v
             return sprintf("EXTRACTVALUE(%s.props, '//sv:property[@sv:name=%s]/sv:value[%d]/@%s')", $alias, Xpath::escape($property), $valueIndex, $attribute);
         }
 
-        throw new NotImplementedException("Xpath evaluations cannot be executed with '" . $this->platform->getName() . "' yet.");
+        throw new NotImplementedException(sprintf("Xpath evaluations cannot be executed with '%s' yet.", $this->platform->getName()));
     }
 
     /**
@@ -1001,15 +1040,15 @@ private function sqlXpathComparePropertyValue($alias, $property, $value, $operat
         $expression = null;
 
         if ($this->platform instanceof MySQLPlatform) {
-            $expression = "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[text()%s%s]) > 0')";
+            $expression = sprintf("EXTRACTVALUE(%s.props, 'count(//sv:property[@sv:name=%s]/sv:value[text()%%s%%s]) > 0')", $alias, Xpath::escape($property));
             // mysql does not escape the backslashes for us, while postgres and sqlite do
             $value = Xpath::escapeBackslashes($value);
         } elseif ($this->platform instanceof PostgreSQL94Platform || $this->platform instanceof PostgreSqlPlatform) {
-            $expression = "xpath_exists('//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[text()%s%s]', CAST($alias.props AS xml), ".$this->sqlXpathPostgreSQLNamespaces().") = 't'";
+            $expression = sprintf("xpath_exists('//sv:property[@sv:name=%s]/sv:value[text()%s%s]', CAST(%%s.props AS xml), %%s) = 't'", Xpath::escape($property), $alias, $this->sqlXpathPostgreSQLNamespaces());
         } elseif ($this->platform instanceof SqlitePlatform) {
-            $expression = "EXTRACTVALUE($alias.props, 'count(//sv:property[@sv:name=" . Xpath::escape($property) . "]/sv:value[text()%s%s]) > 0')";
+            $expression = sprintf("EXTRACTVALUE(%s.props, 'count(//sv:property[@sv:name=%s]/sv:value[text()%%s%%s]) > 0')", $alias, Xpath::escape($property));
         } else {
-            throw new NotImplementedException("Xpath evaluations cannot be executed with '" . $this->platform->getName() . "' yet.");
+            throw new NotImplementedException(sprintf("Xpath evaluations cannot be executed with '%s' yet.", $this->platform->getName()));
         }
 
         return sprintf($expression, $this->walkOperator($operator), Xpath::escape($value));
@@ -1031,12 +1070,12 @@ private function sqlXpathPostgreSQLNamespaces()
      */
     private function sqlNodeTypeClause($alias, QOM\SelectorInterface $source)
     {
-        $sql = "$alias.type IN ('" . $source->getNodeTypeName() ."'";
+        $sql = sprintf("%s.type IN ('%s'", $alias, $source->getNodeTypeName());
 
         $subTypes = $this->nodeTypeManager->getSubtypes($source->getNodeTypeName());
         foreach ($subTypes as $subType) {
             /* @var $subType NodeTypeInterface */
-            $sql .= ", '" . $subType->getName() . "'";
+            $sql .= sprintf(", '%s'", $subType->getName());
         }
         $sql .= ')';
 

From 3153b3d15d84fa2902392444b9eb300abce6251b Mon Sep 17 00:00:00 2001
From: Alexander Schranz <alexander@sulu.io>
Date: Mon, 13 Dec 2021 11:09:23 +0100
Subject: [PATCH 3/5] Add test with semicolon

---
 .../Transport/DoctrineDBAL/ClientTest.php      | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/tests/Jackalope/Transport/DoctrineDBAL/ClientTest.php b/tests/Jackalope/Transport/DoctrineDBAL/ClientTest.php
index 7a909b9b..5c57b422 100644
--- a/tests/Jackalope/Transport/DoctrineDBAL/ClientTest.php
+++ b/tests/Jackalope/Transport/DoctrineDBAL/ClientTest.php
@@ -556,6 +556,24 @@ public function provideOrder()
                 'val\'ue DESC',
                 ['three', 'two', 'one'],
             ],
+
+            // property with semicolon quotes
+            [
+                [
+                    'one' => [
+                        'val;ue' => 'AAA',
+                    ],
+                    'two' => [
+                        'val;ue' => 'BBB',
+                    ],
+                    'three' => [
+                        'val;ue' => 'CCC',
+                    ],
+                ],
+                'val;ue',
+                'val;ue DESC',
+                ['three', 'two', 'one'],
+            ],
         ];
     }
 

From 72f9ea93dc186bbd25da150ae464f3bc97a7539f Mon Sep 17 00:00:00 2001
From: Alexander Schranz <alexander@sulu.io>
Date: Mon, 13 Dec 2021 14:47:34 +0100
Subject: [PATCH 4/5] Reverse init doctrine dbal command changes

---
 .../Tools/Console/Command/InitDoctrineDbalCommand.php         | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/Jackalope/Tools/Console/Command/InitDoctrineDbalCommand.php b/src/Jackalope/Tools/Console/Command/InitDoctrineDbalCommand.php
index 46802c17..2d7db081 100644
--- a/src/Jackalope/Tools/Console/Command/InitDoctrineDbalCommand.php
+++ b/src/Jackalope/Tools/Console/Command/InitDoctrineDbalCommand.php
@@ -98,7 +98,7 @@ protected function execute(InputInterface $input, OutputInterface $output)
                 try {
                     foreach ($schema->toDropSql($connection->getDatabasePlatform()) as $sql) {
                         if (true === $input->getOption('dump-sql')) {
-                            $output->writeln($sql ?: '');
+                            $output->writeln($sql);
                         } else {
                             $connection->executeStatement($sql);
                         }
@@ -112,7 +112,7 @@ protected function execute(InputInterface $input, OutputInterface $output)
 
             foreach ($schema->toSql($connection->getDatabasePlatform()) as $sql) {
                 if (true === $input->getOption('dump-sql')) {
-                    $output->writeln($sql ?: '');
+                    $output->writeln($sql);
                 } else {
                     $connection->executeStatement($sql);
                 }

From 681827e1814de0ae2d61a34e3249bdf6933a09e1 Mon Sep 17 00:00:00 2001
From: Alexander Schranz <alexander@sulu.io>
Date: Mon, 13 Dec 2021 16:13:57 +0100
Subject: [PATCH 5/5] Escape for parent path like statement

---
 src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php b/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php
index 56992a71..70e630fd 100644
--- a/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php
+++ b/src/Jackalope/Transport/DoctrineDBAL/Query/QOMWalker.php
@@ -578,7 +578,7 @@ public function walkDescendantNodeConstraint(QOM\DescendantNodeInterface $constr
         return sprintf(
             "%s.path LIKE '%s/%%'",
             $this->getTableAlias($constraint->getSelectorName()),
-            $ancestorPath
+            addcslashes($ancestorPath, "'")
         );
     }
 
@@ -592,7 +592,7 @@ public function walkChildNodeConstraint(QOM\ChildNodeInterface $constraint)
         return sprintf(
             "%s.parent = '%s'",
             $this->getTableAlias($constraint->getSelectorName()),
-            $constraint->getParentPath()
+            addcslashes($constraint->getParentPath(), "'")
         );
     }
 
