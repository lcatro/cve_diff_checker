From 7fdc7debeb8a37faa77b53d9f9a1b4bbcff445ce Mon Sep 17 00:00:00 2001
From: Oscar Rodriguez <orsalido@minsait.com>
Date: Wed, 14 Oct 2020 18:46:39 +0200
Subject: [PATCH] chore: fix execution delay

---
 .../radarcovid/features/worker/FakeInfectionReportWorker.kt  | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/app/src/main/java/es/gob/radarcovid/features/worker/FakeInfectionReportWorker.kt b/app/src/main/java/es/gob/radarcovid/features/worker/FakeInfectionReportWorker.kt
index 0d254108..fe4d0e82 100644
--- a/app/src/main/java/es/gob/radarcovid/features/worker/FakeInfectionReportWorker.kt
+++ b/app/src/main/java/es/gob/radarcovid/features/worker/FakeInfectionReportWorker.kt
@@ -61,8 +61,6 @@ class FakeInfectionReportWorker(context: Context, workerParams: WorkerParameters
 
             val now = clock.currentTimeMillis()
             val executionDelay = 0L.coerceAtLeast(tDummy - now)
-            val executionDelayDays =
-                executionDelay / FACTOR_DAY_MILLIS
 
             val constraints = Constraints.Builder()
                 .setRequiredNetworkType(NetworkType.CONNECTED)
@@ -70,7 +68,7 @@ class FakeInfectionReportWorker(context: Context, workerParams: WorkerParameters
             val work =
                 OneTimeWorkRequest
                     .Builder(FakeInfectionReportWorker::class.java)
-                    .setInitialDelay(executionDelayDays, TimeUnit.MILLISECONDS)
+                    .setInitialDelay(executionDelay, TimeUnit.MILLISECONDS)
                     .setConstraints(constraints)
                     .setInputData(Data.Builder().putLong(KEY_T_DUMMY, tDummy).build())
                     .build()
@@ -90,6 +88,7 @@ class FakeInfectionReportWorker(context: Context, workerParams: WorkerParameters
         val now = clock.currentTimeMillis()
         var tDummy = inputData.getLong(KEY_T_DUMMY, now)
         while (tDummy < now) {
+            // only do request if it was planned to do in the last 48h
             if (tDummy >= now - FACTOR_HOUR_MILLIS * MAX_DELAY_HOURS) {
                 if (BuildConfig.DEBUG)
                     DP3T.addWorkerStartedToHistory(applicationContext, TAG)
