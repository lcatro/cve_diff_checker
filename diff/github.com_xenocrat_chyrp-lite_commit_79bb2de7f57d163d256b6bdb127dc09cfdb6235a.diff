From 79bb2de7f57d163d256b6bdb127dc09cfdb6235a Mon Sep 17 00:00:00 2001
From: Daniel Pimley <dan@pimley.net>
Date: Fri, 6 Jan 2017 22:32:03 +0000
Subject: [PATCH] MainController, Blog Themes: protect against CSRF

My thanks to @fleetcaptain for the report.
---
 includes/controller/Main.php            | 3 +++
 themes/blossom/forms/user/controls.twig | 1 +
 themes/sparrow/forms/user/controls.twig | 1 +
 themes/topaz/forms/user/controls.twig   | 1 +
 themes/umbra/forms/user/controls.twig   | 1 +
 5 files changed, 7 insertions(+)

diff --git a/includes/controller/Main.php b/includes/controller/Main.php
index fbc8994ef..8dc7f8c42 100755
--- a/includes/controller/Main.php
+++ b/includes/controller/Main.php
@@ -620,6 +620,9 @@ public function controls() {
             if (!empty($_POST)) {
                 $visitor = Visitor::current();
 
+                if (!isset($_POST['hash']) or $_POST['hash'] != token($_SERVER["REMOTE_ADDR"]))
+                    Flash::warning(__("Invalid security key."));
+
                 if (!empty($_POST['new_password1']))
                     if (empty($_POST['new_password2']) or $_POST['new_password1'] != $_POST['new_password2'])
                         Flash::warning(__("Passwords do not match."));
diff --git a/themes/blossom/forms/user/controls.twig b/themes/blossom/forms/user/controls.twig
index 10070fed9..50425549f 100644
--- a/themes/blossom/forms/user/controls.twig
+++ b/themes/blossom/forms/user/controls.twig
@@ -18,6 +18,7 @@
 <div class="doaction">
 <button name="submit" type="submit" id="submit" tabindex="4">{{ "Update" | translate }}</button>
 </div>
+<input type="hidden" name="hash" value="{{ ip | token }}" id="hash">
 </form>
 </div>
 {% endblock %}
diff --git a/themes/sparrow/forms/user/controls.twig b/themes/sparrow/forms/user/controls.twig
index 10070fed9..50425549f 100644
--- a/themes/sparrow/forms/user/controls.twig
+++ b/themes/sparrow/forms/user/controls.twig
@@ -18,6 +18,7 @@
 <div class="doaction">
 <button name="submit" type="submit" id="submit" tabindex="4">{{ "Update" | translate }}</button>
 </div>
+<input type="hidden" name="hash" value="{{ ip | token }}" id="hash">
 </form>
 </div>
 {% endblock %}
diff --git a/themes/topaz/forms/user/controls.twig b/themes/topaz/forms/user/controls.twig
index 10070fed9..50425549f 100644
--- a/themes/topaz/forms/user/controls.twig
+++ b/themes/topaz/forms/user/controls.twig
@@ -18,6 +18,7 @@
 <div class="doaction">
 <button name="submit" type="submit" id="submit" tabindex="4">{{ "Update" | translate }}</button>
 </div>
+<input type="hidden" name="hash" value="{{ ip | token }}" id="hash">
 </form>
 </div>
 {% endblock %}
diff --git a/themes/umbra/forms/user/controls.twig b/themes/umbra/forms/user/controls.twig
index 10070fed9..50425549f 100644
--- a/themes/umbra/forms/user/controls.twig
+++ b/themes/umbra/forms/user/controls.twig
@@ -18,6 +18,7 @@
 <div class="doaction">
 <button name="submit" type="submit" id="submit" tabindex="4">{{ "Update" | translate }}</button>
 </div>
+<input type="hidden" name="hash" value="{{ ip | token }}" id="hash">
 </form>
 </div>
 {% endblock %}
