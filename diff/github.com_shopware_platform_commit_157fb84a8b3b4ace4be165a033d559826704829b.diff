From 157fb84a8b3b4ace4be165a033d559826704829b Mon Sep 17 00:00:00 2001
From: OliverSkroblin <o.skroblin@shopware.com>
Date: Thu, 4 Feb 2021 09:35:32 +0100
Subject: [PATCH] NEXT-13371 - Fix set flags for api protection flag

---
 .../2021-01-25-expire-sales-channel-contexts.md            | 0
 .../Framework/DataAbstractionLayer/EntityDefinition.php    | 2 +-
 src/Core/Framework/DataAbstractionLayer/Field/Field.php    | 3 +++
 .../Field/TestDefinition/AssociationExtension.php          | 7 +++++--
 4 files changed, 9 insertions(+), 3 deletions(-)
 rename changelog/{release-6.3.5.1 => release-6-3-5-1}/2021-01-25-expire-sales-channel-contexts.md (100%)

diff --git a/changelog/release-6.3.5.1/2021-01-25-expire-sales-channel-contexts.md b/changelog/release-6-3-5-1/2021-01-25-expire-sales-channel-contexts.md
similarity index 100%
rename from changelog/release-6.3.5.1/2021-01-25-expire-sales-channel-contexts.md
rename to changelog/release-6-3-5-1/2021-01-25-expire-sales-channel-contexts.md
diff --git a/src/Core/Framework/DataAbstractionLayer/EntityDefinition.php b/src/Core/Framework/DataAbstractionLayer/EntityDefinition.php
index 74ef560e1ce..5b051a86352 100644
--- a/src/Core/Framework/DataAbstractionLayer/EntityDefinition.php
+++ b/src/Core/Framework/DataAbstractionLayer/EntityDefinition.php
@@ -126,7 +126,7 @@ final public function getFields(): CompiledFieldCollection
 
             /** @var Field $field */
             foreach ($new as $field) {
-                $field->addFlags(new ApiAware(), new Extension());
+                $field->addFlags(new Extension());
 
                 if ($field instanceof AssociationField) {
                     $fields->add($field);
diff --git a/src/Core/Framework/DataAbstractionLayer/Field/Field.php b/src/Core/Framework/DataAbstractionLayer/Field/Field.php
index 936da111155..4444b497e11 100644
--- a/src/Core/Framework/DataAbstractionLayer/Field/Field.php
+++ b/src/Core/Framework/DataAbstractionLayer/Field/Field.php
@@ -71,6 +71,9 @@ public function setFlags(Flag ...$flags): self
         foreach ($flags as $flag) {
             $this->flags[\get_class($flag)] = $flag;
         }
+        if (!$this->is(ApiAware::class)) {
+            $this->addFlags(new ApiAware(AdminApiSource::class));
+        }
 
         return $this;
     }
diff --git a/src/Core/Framework/Test/DataAbstractionLayer/Field/TestDefinition/AssociationExtension.php b/src/Core/Framework/Test/DataAbstractionLayer/Field/TestDefinition/AssociationExtension.php
index e6757e36ce3..66ede189f7f 100644
--- a/src/Core/Framework/Test/DataAbstractionLayer/Field/TestDefinition/AssociationExtension.php
+++ b/src/Core/Framework/Test/DataAbstractionLayer/Field/TestDefinition/AssociationExtension.php
@@ -3,6 +3,7 @@
 namespace Shopware\Core\Framework\Test\DataAbstractionLayer\Field\TestDefinition;
 
 use Shopware\Core\Framework\DataAbstractionLayer\EntityExtension;
+use Shopware\Core\Framework\DataAbstractionLayer\Field\Flag\ApiAware;
 use Shopware\Core\Framework\DataAbstractionLayer\Field\OneToManyAssociationField;
 use Shopware\Core\Framework\DataAbstractionLayer\Field\OneToOneAssociationField;
 use Shopware\Core\Framework\DataAbstractionLayer\FieldCollection;
@@ -12,11 +13,13 @@ class AssociationExtension extends EntityExtension
     public function extendFields(FieldCollection $collection): void
     {
         $collection->add(
-            new OneToManyAssociationField('toMany', ExtendedDefinition::class, 'extendable_id')
+            (new OneToManyAssociationField('toMany', ExtendedDefinition::class, 'extendable_id'))
+                ->addFlags(new ApiAware())
         );
 
         $collection->add(
-            new OneToOneAssociationField('toOne', 'id', 'extendable_id', ExtendedDefinition::class, false)
+            (new OneToOneAssociationField('toOne', 'id', 'extendable_id', ExtendedDefinition::class, false))
+                ->addFlags(new ApiAware())
         );
     }
 
