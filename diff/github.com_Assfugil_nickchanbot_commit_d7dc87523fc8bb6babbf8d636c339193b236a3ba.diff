From 37735a3ab9d063a81ba62e03cab27c72450b0c74 Mon Sep 17 00:00:00 2001
From: Assfugil <42699250+Assfugil@users.noreply.github.com>
Date: Wed, 25 Mar 2020 23:01:22 +0800
Subject: [PATCH 1/3] Patch  vulnerability

---
 commands/npm.js | 12 ++++--------
 1 file changed, 4 insertions(+), 8 deletions(-)

diff --git a/commands/npm.js b/commands/npm.js
index df70faa..0af486d 100644
--- a/commands/npm.js
+++ b/commands/npm.js
@@ -1,6 +1,8 @@
 require('dotenv').config()
 const { exec } = require("child_process");
 const { RichEmbed, Message } = require("discord.js");
+const { encode } = require("querystring")
+const fetch = require("node-fetch")
 module.exports = {
   name: "npm",
   args: true,
@@ -21,11 +23,8 @@ module.exports = {
         )}...`,
       { disableEveryone: true }
     );
-    exec(
-      `npm search ${args.join(" ").replace(/\n/g, " ")} -json -l`,
-      async (er, so, se) => {
-        if (so) {
-          const res = JSON.parse(so).map(
+    const response = await fetch("https://www.npmjs.com/search/suggestions?q=" + encode(args.join(" "))).then(r => r.json())
+       const res = response.map(
             (x, index) => `${index + 1}. ${x.name}`
           );
           message.channel
@@ -87,9 +86,6 @@ module.exports = {
                 });
             });
         }
-        if (se) await message.channel.send(se, { code: "xl", split: true });
         message.channel.stopTyping();
-      }
-    );
   }
 };

From 52f0e8f847c508db8ee54112b5e56006502d63e4 Mon Sep 17 00:00:00 2001
From: Assfugil <42699250+Assfugil@users.noreply.github.com>
Date: Wed, 25 Mar 2020 23:03:33 +0800
Subject: [PATCH 2/3] Update npm.js

---
 commands/npm.js | 7 +++----
 1 file changed, 3 insertions(+), 4 deletions(-)

diff --git a/commands/npm.js b/commands/npm.js
index 0af486d..be69d95 100644
--- a/commands/npm.js
+++ b/commands/npm.js
@@ -41,9 +41,9 @@ module.exports = {
                 )
                 .on("collect", msg => {
                   const choice = parseInt(msg.content) - 1;
-                  if (!JSON.parse(so)[choice])
+                  if (!response[choice])
                     return message.reply("out of range.");
-                  const result = JSON.parse(so)[choice];
+                  const result = response[choice];
                   const embed = new RichEmbed()
                     .setColor("#ff0000")
                     .setTitle(result.name)
@@ -85,7 +85,6 @@ module.exports = {
                   message.channel.send(embed);
                 });
             });
+            message.channel.stopTyping();
         }
-        message.channel.stopTyping();
   }
-};

From f8e040a3c2a1d84b0c0d87dc1ee0b190c53d187f Mon Sep 17 00:00:00 2001
From: Assfugil <42699250+Assfugil@users.noreply.github.com>
Date: Wed, 25 Mar 2020 23:10:28 +0800
Subject: [PATCH 3/3] fixes

---
 commands/npm.js | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/commands/npm.js b/commands/npm.js
index be69d95..23eb9cc 100644
--- a/commands/npm.js
+++ b/commands/npm.js
@@ -1,7 +1,7 @@
 require('dotenv').config()
 const { exec } = require("child_process");
 const { RichEmbed, Message } = require("discord.js");
-const { encode } = require("querystring")
+const { escape } = require("querystring")
 const fetch = require("node-fetch")
 module.exports = {
   name: "npm",
@@ -23,7 +23,7 @@ module.exports = {
         )}...`,
       { disableEveryone: true }
     );
-    const response = await fetch("https://www.npmjs.com/search/suggestions?q=" + encode(args.join(" "))).then(r => r.json())
+    const response = await fetch("https://www.npmjs.com/search/suggestions?q=" + escape(args.join(" "))).then(r => r.json())
        const res = response.map(
             (x, index) => `${index + 1}. ${x.name}`
           );
