From aa3e54f594385ce7e1e319b0c84999e51192578b Mon Sep 17 00:00:00 2001
From: Denis Ovsienko <denis@ovsienko.info>
Date: Fri, 1 Sep 2017 17:55:39 +0100
Subject: [PATCH] (for 4.9.3) CVE-2018-14468/FRF.16: Add a missing length
 check.

The specification says in a well-formed Magic Number information element
the data is exactly 4 bytes long. In mfr_print() check this before trying
to read those 4 bytes.

This fixes a buffer over-read discovered by Bhargava Shastry,
SecT/TU Berlin.

Add a test using the capture file supplied by the reporter(s).
---
 print-fr.c                     |   5 +++++
 tests/TESTLIST                 |   1 +
 tests/frf16_magic_ie-oobr.out  |   2 ++
 tests/frf16_magic_ie-oobr.pcap | Bin 0 -> 124 bytes
 4 files changed, 8 insertions(+)
 create mode 100644 tests/frf16_magic_ie-oobr.out
 create mode 100644 tests/frf16_magic_ie-oobr.pcap

diff --git a/print-fr.c b/print-fr.c
index 7181eb486..53f37f683 100644
--- a/print-fr.c
+++ b/print-fr.c
@@ -493,6 +493,11 @@ mfr_print(netdissect_options *ndo,
             switch (ie_type) {
 
             case MFR_CTRL_IE_MAGIC_NUM:
+                /* FRF.16.1 Section 3.4.3 Magic Number Information Element */
+                if (ie_len != 4) {
+                    ND_PRINT((ndo, "(invalid length)"));
+                    break;
+                }
                 ND_PRINT((ndo, "0x%08x", EXTRACT_32BITS(tptr)));
                 break;
 
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 42b50c240..7c1b84e58 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -572,6 +572,7 @@ olsr-oobr-2		olsr-oobr-2.pcap		olsr-oobr-2.out	-v
 ikev1_id_ipv6_addr_subnet-oobr	ikev1_id_ipv6_addr_subnet-oobr.pcap	ikev1_id_ipv6_addr_subnet-oobr.out	-v
 isakmp-various-oobr	isakmp-various-oobr.pcap	isakmp-various-oobr.out	-v
 aoe-oobr-1		aoe-oobr-1.pcap			aoe-oobr-1.out	-v -c1
+frf16_magic_ie-oobr	frf16_magic_ie-oobr.pcap	frf16_magic_ie-oobr.out	-v -c1
 
 # bad packets from Katie Holly
 mlppp-oobr		mlppp-oobr.pcap			mlppp-oobr.out
diff --git a/tests/frf16_magic_ie-oobr.out b/tests/frf16_magic_ie-oobr.out
new file mode 100644
index 000000000..dc12ee540
--- /dev/null
+++ b/tests/frf16_magic_ie-oobr.out
@@ -0,0 +1,2 @@
+FRF.16 Control, Flags [Begin, End, Control], Unknown Message (0x00), length 3714318497
+	IE Magic Number (3), length 3: (invalid length)[|mfr]
diff --git a/tests/frf16_magic_ie-oobr.pcap b/tests/frf16_magic_ie-oobr.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..85202fbe0e0e818c3d426e68bee7c693fca99e5d
GIT binary patch
literal 124
zcmca|c+)~A1{MYhrY{U2zy`$IfS7mN?b{3t0t_xd_Ckh~yZ;#&n3;jXbq5X}STI`$
t$OQut1_l=a29PWx2S`&yFf&jS%)lU^8i;|cFav*kP6HZo1879YN&pQnA7}so

literal 0
HcmV?d00001

