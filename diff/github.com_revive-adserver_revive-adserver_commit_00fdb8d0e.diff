From 00fdb8d0e946a32dec5a06e261ca9444139790da Mon Sep 17 00:00:00 2001
From: Matteo Beccati <matteo@beccati.com>
Date: Tue, 19 Jan 2021 14:49:39 +0100
Subject: [PATCH] Fix h1 report 986365

---
 RELEASE_NOTES.txt        | 3 +++
 www/delivery_dev/afr.php | 2 +-
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/RELEASE_NOTES.txt b/RELEASE_NOTES.txt
index 90889a89ce..d38e0ccd64 100644
--- a/RELEASE_NOTES.txt
+++ b/RELEASE_NOTES.txt
@@ -34,6 +34,9 @@ What's New in Revive Adserver 5.1.0
    when displaying the website URL in the affiliate-preview.php tag
    generation page.
 
+ * Fixed a reflected XSS vulnerability in afr.php that could still be achieved
+   on legacy browsers, bypassing a previous fix.
+
 
  New Features
  ------------
diff --git a/www/delivery_dev/afr.php b/www/delivery_dev/afr.php
index aa4221dbc4..1379463750 100644
--- a/www/delivery_dev/afr.php
+++ b/www/delivery_dev/afr.php
@@ -77,7 +77,7 @@
 
     $refresh = (int)$refresh;
     // JS needs to be escaped twice: the setTimeout argument is evaluated at runtime
-    $jsDest = addcslashes(addcslashes($dest, "\0..\37\"\\"), "'\\");
+    $jsDest = addcslashes(addcslashes($dest, "\0..\37/\"\\"), "'\\");
     $htmlDest = htmlspecialchars($dest, ENT_QUOTES);
 
     // Try to use JS location.replace since browsers deal with this and history much better than meta-refresh
