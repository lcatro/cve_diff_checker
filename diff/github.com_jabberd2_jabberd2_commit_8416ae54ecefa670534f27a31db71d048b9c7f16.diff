From 8416ae54ecefa670534f27a31db71d048b9c7f16 Mon Sep 17 00:00:00 2001
From: Tomasz Sterna <tomek@xiaoka.com>
Date: Sat, 1 Jul 2017 17:23:52 +0200
Subject: [PATCH] Fixed offered SASL mechanism check

---
 c2s/main.c | 2 ++
 sx/sasl.c  | 2 +-
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/c2s/main.c b/c2s/main.c
index 1efa3650..7972c547 100644
--- a/c2s/main.c
+++ b/c2s/main.c
@@ -562,6 +562,8 @@ static int _c2s_sx_sasl_callback(int cb, void *arg, void **res, sx_t s, void *cb
             mechbuf[sizeof(mechbuf)-1]='\0';
             for(i = 0; mechbuf[i]; i++) mechbuf[i] = tolower(mechbuf[i]);
 
+            log_debug(ZONE, "sx sasl callback: check mech (mech=%s)", mechbuf);
+
             /* get host for request */
             host = xhash_get(c2s->hosts, s->req_to);
             if(host == NULL) {
diff --git a/sx/sasl.c b/sx/sasl.c
index 96d4408e..d52f6afa 100644
--- a/sx/sasl.c
+++ b/sx/sasl.c
@@ -332,7 +332,7 @@ static void _sx_sasl_client_process(sx_t s, sx_plugin_t p, Gsasl_session *sd, co
     if(mech != NULL) {
         _sx_debug(ZONE, "auth request from client (mechanism=%s)", mech);
 
-        if(!gsasl_server_support_p(ctx->gsasl_ctx, mech)) {
+        if(!gsasl_server_support_p(ctx->gsasl_ctx, mech) || (ctx->cb)(sx_sasl_cb_CHECK_MECH, (void*)mech, NULL, s, ctx->cbarg) != sx_sasl_ret_OK) {
              _sx_debug(ZONE, "client requested mechanism (%s) that we didn't offer", mech);
              _sx_nad_write(s, _sx_sasl_failure(s, _sasl_err_INVALID_MECHANISM, NULL), 0);
              return;
