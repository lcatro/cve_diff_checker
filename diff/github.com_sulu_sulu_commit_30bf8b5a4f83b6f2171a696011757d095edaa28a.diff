From 30bf8b5a4f83b6f2171a696011757d095edaa28a Mon Sep 17 00:00:00 2001
From: Alexander Schranz <alexander@sulu.io>
Date: Wed, 15 Dec 2021 14:49:33 +0100
Subject: [PATCH] Merge pull request from GHSA-84px-q68r-2fc9

---
 .../Controller/ProfileController.php          | 18 +++++++++++++-
 .../Controller/ProfileControllerTest.php      | 24 +++++++++++++++++++
 2 files changed, 41 insertions(+), 1 deletion(-)

diff --git a/src/Sulu/Bundle/SecurityBundle/Controller/ProfileController.php b/src/Sulu/Bundle/SecurityBundle/Controller/ProfileController.php
index 3aadf72df6..098bb81873 100644
--- a/src/Sulu/Bundle/SecurityBundle/Controller/ProfileController.php
+++ b/src/Sulu/Bundle/SecurityBundle/Controller/ProfileController.php
@@ -118,7 +118,7 @@ public function putAction(Request $request)
     {
         $this->checkArguments($request);
         $user = $this->tokenStorage->getToken()->getUser();
-        $this->userManager->save($request->request->all(), $request->get('locale'), $user->getId(), true);
+        $this->userManager->save($this->getData($request), $request->get('locale'), $user->getId(), true);
 
         $user->setFirstName($request->get('firstName'));
         $user->setLastName($request->get('lastName'));
@@ -231,4 +231,20 @@ private function checkArguments(Request $request)
             throw new MissingArgumentException($this->userClass, 'locale');
         }
     }
+
+    /**
+     * @return array<string, mixed>
+     */
+    protected function getData(Request $request): array
+    {
+        $data = [];
+
+        foreach ($request->request->all() as $key => $value) {
+            if (\in_array($key, ['firstName', 'lastName', 'username', 'email', 'password', 'locale'], true)) {
+                $data[$key] = $value;
+            }
+        }
+
+        return $data;
+    }
 }
diff --git a/src/Sulu/Bundle/SecurityBundle/Tests/Functional/Controller/ProfileControllerTest.php b/src/Sulu/Bundle/SecurityBundle/Tests/Functional/Controller/ProfileControllerTest.php
index fd6dff0e49..57f5d79952 100644
--- a/src/Sulu/Bundle/SecurityBundle/Tests/Functional/Controller/ProfileControllerTest.php
+++ b/src/Sulu/Bundle/SecurityBundle/Tests/Functional/Controller/ProfileControllerTest.php
@@ -87,6 +87,30 @@ public function testPut()
         $this->assertEquals('de', $response->locale);
     }
 
+    public function testPutInvalidField()
+    {
+        $this->client->jsonRequest(
+            'PUT',
+            '/api/profile',
+            [
+                'firstName' => 'Hans',
+                'lastName' => 'Mustermann',
+                'username' => 'hansi',
+                'email' => 'hans.mustermann@muster.at',
+                'password' => 'testpassword',
+                'locale' => 'de',
+            ]
+        );
+
+        $response = \json_decode($this->client->getResponse()->getContent());
+        $this->assertHttpStatusCode(200, $this->client->getResponse());
+        $this->assertEquals('Hans', $response->firstName);
+        $this->assertEquals('Mustermann', $response->lastName);
+        $this->assertEquals('hansi', $response->username);
+        $this->assertEquals('hans.mustermann@muster.at', $response->email);
+        $this->assertEquals('de', $response->locale);
+    }
+
     public function testPutEmailNotUnique()
     {
         $existingContact = new Contact();
