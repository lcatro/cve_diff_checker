From b1af3bde1f68bec1c703ad66a3e390f15ed8ebe1 Mon Sep 17 00:00:00 2001
From: Nicholas Ferreira <3837916+Nickguitar@users.noreply.github.com>
Date: Wed, 10 Nov 2021 06:10:49 -0300
Subject: [PATCH] Fixed critical upload vulnerability (#552)

Co-authored-by: Nicholas Ferreira <nickguitar.dll@hotmail.com>
---
 lib/FileUtility.php | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/lib/FileUtility.php b/lib/FileUtility.php
index 7bfe9766..8546fd3c 100755
--- a/lib/FileUtility.php
+++ b/lib/FileUtility.php
@@ -184,11 +184,17 @@ public static function makeSafeFilename($filename)
 
         /* Is the file extension safe? */
         $fileExtension = self::getFileExtension($filename);
-        if (in_array($fileExtension, $GLOBALS['badFileExtensions']))
+        
+        /* Use a whitelist instead of a blacklist to prevent possible bypasses */
+        if (!preg_match("/(?i)\.(pdf|docx?|rtf|odt?g?|txt|wpd|jpe?g|png|csv|xlsx?|ppt|msg|heic|tiff?|html?|bmp|wps|xps)$/i", $fileExtension))
+        {
+            $filename .= ".txt";
+        }
+/*        if (in_array($fileExtension, $GLOBALS['badFileExtensions']))
         {
             $filename .= '.txt';
         }
-
+*/
         return $filename;
     }
 
@@ -563,7 +569,7 @@ public static function getUploadFileFromPost($siteID, $subDirectory, $id)
             if (!eval(Hooks::get('FILE_UTILITY_SPACE_CHECK'))) return;
 
             $uploadPath = FileUtility::getUploadPath($siteID, $subDirectory);
-            $newFileName = $_FILES[$id]['name'];
+            $newFileName = FileUtility::makeSafeFilename($_FILES[$id]['name']);
 
             // Could just while(file_exists) it, but I'm paranoid of infinate loops
             // Shouldn't have 1000 files of the same name anyway
