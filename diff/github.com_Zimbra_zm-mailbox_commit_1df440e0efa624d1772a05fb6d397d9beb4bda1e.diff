From 1df440e0efa624d1772a05fb6d397d9beb4bda1e Mon Sep 17 00:00:00 2001
From: sneha-patil-synacor <sneha.patil@synacor.com>
Date: Wed, 12 Feb 2020 16:08:01 +0530
Subject: [PATCH] ZBUG-1094:Broken GAL search filtering

---
 .../zimbra/cs/service/account/AutoCompleteGal.java   | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/store/src/java/com/zimbra/cs/service/account/AutoCompleteGal.java b/store/src/java/com/zimbra/cs/service/account/AutoCompleteGal.java
index f46b56ea8fc..fae902b01c1 100644
--- a/store/src/java/com/zimbra/cs/service/account/AutoCompleteGal.java
+++ b/store/src/java/com/zimbra/cs/service/account/AutoCompleteGal.java
@@ -1,7 +1,7 @@
 /*
  * ***** BEGIN LICENSE BLOCK *****
  * Zimbra Collaboration Suite Server
- * Copyright (C) 2006, 2007, 2008, 2009, 2010, 2011, 2013, 2014, 2016 Synacor, Inc.
+ * Copyright (C) 2006, 2007, 2008, 2009, 2010, 2011, 2013, 2014, 2016, 2020 Synacor, Inc.
  *
  * This program is free software: you can redistribute it and/or modify it under
  * the terms of the GNU General Public License as published by the Free Software Foundation,
@@ -57,8 +57,14 @@ public Element handle(Element request, Map<String, Object> context) throws Servi
         params.setLimit(account.getContactAutoCompleteMaxResults());
         params.setNeedCanExpand(needCanExpand);
         params.setResponseName(AccountConstants.AUTO_COMPLETE_GAL_RESPONSE);
-        if (galAcctId != null)
-            params.setGalSyncAccount(Provisioning.getInstance().getAccountById(galAcctId));
+        if (galAcctId != null) {
+            Account galAccount = Provisioning.getInstance().getAccountById(galAcctId);
+            if (galAccount != null && (!account.getDomainId().equals(galAccount.getDomainId()))) {
+                throw ServiceException
+                    .PERM_DENIED("can not access galsync account of different domain");
+            }
+            params.setGalSyncAccount(galAccount);
+        }
         GalSearchControl gal = new GalSearchControl(params);
         gal.autocomplete();
         return params.getResultCallback().getResponse();
