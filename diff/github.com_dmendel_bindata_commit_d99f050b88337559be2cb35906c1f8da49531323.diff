From d99f050b88337559be2cb35906c1f8da49531323 Mon Sep 17 00:00:00 2001
From: Dion Mendel <bindata@dm9.info>
Date: Tue, 18 May 2021 11:39:35 +0800
Subject: [PATCH] Improved creation time of Bits and Integers

---
 ChangeLog.rdoc      |  4 ++++
 lib/bindata/bits.rb | 10 +++++-----
 lib/bindata/int.rb  | 12 +++++++-----
 3 files changed, 16 insertions(+), 10 deletions(-)

diff --git a/ChangeLog.rdoc b/ChangeLog.rdoc
index dbc08d2..d7a7458 100644
--- a/ChangeLog.rdoc
+++ b/ChangeLog.rdoc
@@ -1,5 +1,9 @@
 = BinData Changelog
 
+== Version 2.4.10 (2021-05-18)
+
+* Improve speed of dynamic object creation.  Reported by Charlie Ablett.
+
 == Version 2.4.9 (2021-04-22)
 
 * Change example from Fixnum to Integer.  Thanks to Tim Chambers.
diff --git a/lib/bindata/bits.rb b/lib/bindata/bits.rb
index b04c4fb..1a69d5f 100644
--- a/lib/bindata/bits.rb
+++ b/lib/bindata/bits.rb
@@ -115,14 +115,14 @@ def create_fixed_clamp_code(nbits, signed)
         end
 
         if signed == :signed
-          max = (1 << (nbits - 1)) - 1
-          min = -(max + 1)
+          max = "max = (1 << (#{nbits} - 1)) - 1"
+          min = "min = -(max + 1)"
         else
-          min = 0
-          max = (1 << nbits) - 1
+          min = "min = 0"
+          max = "max = (1 << #{nbits}) - 1"
         end
 
-        clamp = "(val < #{min}) ? #{min} : (val > #{max}) ? #{max} : val"
+        clamp = "(#{max}; #{min}; val = (val < min) ? min : (val > max) ? max : val)"
 
         if nbits == 1
           # allow single bits to be used as booleans
diff --git a/lib/bindata/int.rb b/lib/bindata/int.rb
index 0fc0c20..e9c087b 100644
--- a/lib/bindata/int.rb
+++ b/lib/bindata/int.rb
@@ -59,14 +59,16 @@ def read_and_return_value(io)
 
       def create_clamp_code(nbits, signed)
         if signed == :signed
-          max = (1 << (nbits - 1)) - 1
-          min = -(max + 1)
+          max = "max = (1 << (#{nbits} - 1)) - 1"
+          min = "min = -(max + 1)"
         else
-          max = (1 << nbits) - 1
-          min = 0
+          max = "max = (1 << #{nbits}) - 1"
+          min = "min = 0"
         end
 
-        "val = (val < #{min}) ? #{min} : (val > #{max}) ? #{max} : val"
+        clamp = "(#{max}; #{min}; val = (val < min) ? min : (val > max) ? max : val)"
+
+        "val = #{clamp}"
       end
 
       def create_read_code(nbits, endian, signed)
