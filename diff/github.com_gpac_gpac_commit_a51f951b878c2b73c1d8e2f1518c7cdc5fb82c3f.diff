From a51f951b878c2b73c1d8e2f1518c7cdc5fb82c3f Mon Sep 17 00:00:00 2001
From: jeanlf <jeanlf@gpac.io>
Date: Mon, 10 May 2021 11:14:03 +0200
Subject: [PATCH] fixed #1782 (fuzz)

---
 applications/mp4box/main.c    | 8 ++++++++
 src/isomedia/box_code_adobe.c | 7 +++----
 2 files changed, 11 insertions(+), 4 deletions(-)

diff --git a/applications/mp4box/main.c b/applications/mp4box/main.c
index e0215f77e..db6c06779 100644
--- a/applications/mp4box/main.c
+++ b/applications/mp4box/main.c
@@ -5439,6 +5439,14 @@ static u32 mp4box_cleanup(u32 ret_code) {
 	}
 	if (logfile) gf_fclose(logfile);
 	gf_sys_close();
+
+#ifdef GPAC_MEMORY_TRACKING
+	if (mem_track && (gf_memory_size() || gf_file_handles_count() )) {
+		gf_log_set_tool_level(GF_LOG_MEMORY, GF_LOG_INFO);
+		gf_memory_print();
+	}
+#endif
+
 	return ret_code;
 }
 
diff --git a/src/isomedia/box_code_adobe.c b/src/isomedia/box_code_adobe.c
index fe4619191..bb80f3ce8 100644
--- a/src/isomedia/box_code_adobe.c
+++ b/src/isomedia/box_code_adobe.c
@@ -408,6 +408,7 @@ GF_Err afra_box_read(GF_Box *s, GF_BitStream *bs)
 	for (i=0; i<ptr->entry_count; i++) {
 		GF_AfraEntry *ae = gf_malloc(sizeof(GF_AfraEntry));
 		if (!ae) return GF_OUT_OF_MEM;
+		gf_list_insert(ptr->local_access_entries, ae, i);
 
 		ISOM_DECREASE_SIZE(ptr, 8)
 		ae->time = gf_bs_read_u64(bs);
@@ -418,8 +419,6 @@ GF_Err afra_box_read(GF_Box *s, GF_BitStream *bs)
 			ISOM_DECREASE_SIZE(ptr, 4)
 			ae->offset = gf_bs_read_u32(bs);
 		}
-
-		gf_list_insert(ptr->local_access_entries, ae, i);
 	}
 
 	if (ptr->global_entries) {
@@ -428,6 +427,8 @@ GF_Err afra_box_read(GF_Box *s, GF_BitStream *bs)
 		for (i=0; i<ptr->global_entry_count; i++) {
 			GF_GlobalAfraEntry *ae = gf_malloc(sizeof(GF_GlobalAfraEntry));
 			if (!ae) return GF_OUT_OF_MEM;
+			gf_list_insert(ptr->global_access_entries, ae, i);
+
 			ISOM_DECREASE_SIZE(ptr, 8)
 			ae->time = gf_bs_read_u64(bs);
 			if (ptr->long_ids) {
@@ -448,8 +449,6 @@ GF_Err afra_box_read(GF_Box *s, GF_BitStream *bs)
 				ae->afra_offset = gf_bs_read_u32(bs);
 				ae->offset_from_afra = gf_bs_read_u32(bs);
 			}
-
-			gf_list_insert(ptr->global_access_entries, ae, i);
 		}
 	}
 
