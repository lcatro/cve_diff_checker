From 9196fd795e87dab069b4260a3590a0ea886e770f Mon Sep 17 00:00:00 2001
From: robin <robin@ubuntu>
Date: Sat, 21 Nov 2020 21:37:06 +0800
Subject: [PATCH] Fix XXE injection attack by disabling XML DTD handling

---
 .../io/onedev/server/migration/XmlBuildSpecMigrator.java  | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/server-core/src/main/java/io/onedev/server/migration/XmlBuildSpecMigrator.java b/server-core/src/main/java/io/onedev/server/migration/XmlBuildSpecMigrator.java
index 5fecc3ed5c..9d59206e0e 100644
--- a/server-core/src/main/java/io/onedev/server/migration/XmlBuildSpecMigrator.java
+++ b/server-core/src/main/java/io/onedev/server/migration/XmlBuildSpecMigrator.java
@@ -10,6 +10,7 @@
 import org.dom4j.DocumentException;
 import org.dom4j.Element;
 import org.dom4j.io.SAXReader;
+import org.xml.sax.SAXException;
 import org.yaml.snakeyaml.DumperOptions;
 import org.yaml.snakeyaml.DumperOptions.FlowStyle;
 import org.yaml.snakeyaml.emitter.Emitter;
@@ -662,8 +663,11 @@ private static Node migrateJobDependency(Element jobDependencyElement) {
 	public static String migrate(String xml) {
 		Document xmlDoc;
 		try {
-			xmlDoc = new SAXReader().read(new StringReader(xml));
-		} catch (DocumentException e) {
+			SAXReader reader = new SAXReader();
+			// Prevent XXE attack as the xml might be provided by malicious users
+			reader.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
+			xmlDoc = reader.read(new StringReader(xml));
+		} catch (DocumentException | SAXException e) {
 			throw new RuntimeException(e);
 		}
 		
