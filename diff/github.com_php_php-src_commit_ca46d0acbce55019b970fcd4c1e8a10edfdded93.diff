From ca46d0acbce55019b970fcd4c1e8a10edfdded93 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Fri, 30 Dec 2016 15:34:46 -0800
Subject: [PATCH] Fix int overflows in phar (bug #73764)

---
 ext/phar/phar.c              |   4 ++--
 ext/phar/tests/bug73764.phar | Bin 0 -> 138 bytes
 ext/phar/tests/bug73764.phpt |  16 ++++++++++++++++
 3 files changed, 18 insertions(+), 2 deletions(-)
 create mode 100644 ext/phar/tests/bug73764.phar
 create mode 100644 ext/phar/tests/bug73764.phpt

diff --git a/ext/phar/phar.c b/ext/phar/phar.c
index 14b80e175ed4..532b4c3169ac 100644
--- a/ext/phar/phar.c
+++ b/ext/phar/phar.c
@@ -1055,7 +1055,7 @@ static int phar_parse_pharfile(php_stream *fp, char *fname, int fname_len, char
 	entry.is_persistent = mydata->is_persistent;
 
 	for (manifest_index = 0; manifest_index < manifest_count; ++manifest_index) {
-		if (buffer + 4 > endbuffer) {
+		if (buffer + 24 > endbuffer) {
 			MAPPHAR_FAIL("internal corruption of phar \"%s\" (truncated manifest entry)")
 		}
 
@@ -1069,7 +1069,7 @@ static int phar_parse_pharfile(php_stream *fp, char *fname, int fname_len, char
 			entry.manifest_pos = manifest_index;
 		}
 
-		if (entry.filename_len + 20 > endbuffer - buffer) {
+		if (entry.filename_len > endbuffer - buffer - 20) {
 			MAPPHAR_FAIL("internal corruption of phar \"%s\" (truncated manifest entry)");
 		}
 
diff --git a/ext/phar/tests/bug73764.phar b/ext/phar/tests/bug73764.phar
new file mode 100644
index 0000000000000000000000000000000000000000..89a5ff65426d1b64a7a114c2acf499d57adf0bf9
GIT binary patch
literal 138
zcma!#_i*$HiFfw*4e<1F4bsrGR<O6@<;rJZU|<B||NkL0kO>5D{{R1<T9KGrkdvxc
zkWnB96jBZki2%{gYogD9lz@PZJy4P>H8~?+K`A3OCnsN_JijO>B_>aa%ifMFopGvt
X!v6%-oR_-~ZG09I3bMxC$=3-0z#k^&

literal 0
HcmV?d00001

diff --git a/ext/phar/tests/bug73764.phpt b/ext/phar/tests/bug73764.phpt
new file mode 100644
index 000000000000..cab314a7317c
--- /dev/null
+++ b/ext/phar/tests/bug73764.phpt
@@ -0,0 +1,16 @@
+--TEST--
+Phar: PHP bug #73764: Crash while loading hostile phar archive
+--SKIPIF--
+<?php if (!extension_loaded("phar")) die("skip"); ?>
+--FILE--
+<?php
+chdir(__DIR__);
+try {
+$p = Phar::LoadPhar('bug73764.phar', 'alias.phar');
+echo "OK\n";
+} catch(PharException $e) {
+	echo $e->getMessage();
+}
+?>
+--EXPECTF--
+internal corruption of phar "%sbug73764.phar" (truncated manifest entry)
\ No newline at end of file
