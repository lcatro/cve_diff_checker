From b14670030349a2747a00ace665568ab5f51ac47b Mon Sep 17 00:00:00 2001
From: William Wernert <william.wernert@gmail.com>
Date: Tue, 17 Nov 2020 15:36:25 -0500
Subject: [PATCH] [feat] Remove so-setup permission from sudoers file after iso
 setup

Closes #1701
---
 salt/common/tools/sbin/soup | 7 +++++++
 setup/so-functions          | 4 ++++
 2 files changed, 11 insertions(+)

diff --git a/salt/common/tools/sbin/soup b/salt/common/tools/sbin/soup
index 0453ea29d..db806a443 100755
--- a/salt/common/tools/sbin/soup
+++ b/salt/common/tools/sbin/soup
@@ -191,6 +191,7 @@ pillar_changes() {
     [[ "$INSTALLEDVERSION" =~ rc.1 ]] && rc1_to_rc2
     [[ "$INSTALLEDVERSION" =~ rc.2 ]] && rc2_to_rc3
     [[ "$INSTALLEDVERSION" =~ rc.3 ]] && rc3_to_2.3.0
+	[[ "$INSTALLEDVERSION" =~ 2.3.2 ]] && up_2.3.2_to_2.3.10
 
 }
 
@@ -292,6 +293,12 @@ unmount_update() {
   umount /tmp/soagupdate
 }
 
+up_2.3.2_to_2.3.10() {
+	if grep -q "so-setup" /etc/sudoers; then
+		echo "[ INFO ] There is an entry for so-setup in the sudoers file, this can be safely deleted using \"visudo\"."
+	fi
+}
+
 update_centos_repo() {
   # Update the files in the repo
   echo "Syncing new updates to /nsm/repo"
diff --git a/setup/so-functions b/setup/so-functions
index bd2c05179..c21f8407a 100755
--- a/setup/so-functions
+++ b/setup/so-functions
@@ -1019,6 +1019,10 @@ install_cleanup() {
 	# If Mysql is running stop it
 	/usr/sbin/so-mysql-stop
 
+	if [[ $install_type == 'iso' ]]; then
+		info "Removing so-setup permission entry from sudoers file"
+		sed -i '/so-setup/d' /etc/sudoers
+	fi
 }
 
 import_registry_docker() {
