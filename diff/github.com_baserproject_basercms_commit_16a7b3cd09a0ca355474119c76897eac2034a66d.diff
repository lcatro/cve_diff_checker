From 757fcc58d184d7170c7d4b2bf28ab477c518e397 Mon Sep 17 00:00:00 2001
From: gondoh <gondoh@catchup.co.jp>
Date: Tue, 18 Aug 2020 18:40:23 +0900
Subject: [PATCH] fix security/advisories/GHSA-4r3m-j6x5-48m3
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

ファイルアップロードプラグインにおいて拡張子判別を追加
テーマ編集の表示においてエスケープ処理を追加
---
 .../theme/admin-third/ThemeFiles/admin/form_folder.php      | 2 +-
 app/webroot/theme/admin-third/ThemeFiles/admin/index.php    | 2 +-
 lib/Baser/Plugin/Uploader/Config/setting.php                | 6 +++++-
 lib/Baser/Plugin/Uploader/Model/UploaderFile.php            | 2 +-
 lib/Baser/View/ThemeFiles/admin/form_folder.php             | 2 +-
 lib/Baser/View/ThemeFiles/admin/index.php                   | 2 +-
 6 files changed, 10 insertions(+), 6 deletions(-)

diff --git a/app/webroot/theme/admin-third/ThemeFiles/admin/form_folder.php b/app/webroot/theme/admin-third/ThemeFiles/admin/form_folder.php
index 6d9e3ae171..2b4cddebaf 100755
--- a/app/webroot/theme/admin-third/ThemeFiles/admin/form_folder.php
+++ b/app/webroot/theme/admin-third/ThemeFiles/admin/form_folder.php
@@ -25,7 +25,7 @@
 
 <!-- current -->
 <div class="em-box bca-current-box">
-	<?php echo __d('baser', '現在の位置')?>：<?php echo $currentPath ?>
+	<?php echo __d('baser', '現在の位置')?>：<?php echo h($currentPath) ?>
 </div>
 
 <?php if ($this->request->action == 'admin_add_folder'): ?>
diff --git a/app/webroot/theme/admin-third/ThemeFiles/admin/index.php b/app/webroot/theme/admin-third/ThemeFiles/admin/index.php
index e7684ed4bc..03627b1d93 100755
--- a/app/webroot/theme/admin-third/ThemeFiles/admin/index.php
+++ b/app/webroot/theme/admin-third/ThemeFiles/admin/index.php
@@ -45,7 +45,7 @@
 <div id="MessageBox" style="display:none"><div id="flashMessage" class="notice-message"></div></div>
 
 <!-- current -->
-<div class="em-box bca-current-box"><?php echo __d('baser', '現在の位置') ?>：<?php echo $currentPath ?>
+<div class="em-box bca-current-box"><?php echo __d('baser', '現在の位置') ?>：<?php echo h($currentPath) ?>
 	<?php if (!$writable): ?>
 		　<span style="color:#FF3300">[<?php echo __d('baser', '書込不可') ?>]</span>
 	<?php endif ?>
diff --git a/lib/Baser/Plugin/Uploader/Config/setting.php b/lib/Baser/Plugin/Uploader/Config/setting.php
index bab63fff91..e241a4572a 100644
--- a/lib/Baser/Plugin/Uploader/Config/setting.php
+++ b/lib/Baser/Plugin/Uploader/Config/setting.php
@@ -46,6 +46,10 @@
 	]
 ];
 $config['Uploader'] = [
+		// システム管理者によるアップロードでいかなる拡張子も許可する
+		'allowedAdmin' => false,
 		// システム管理者グループ以外のユーザーがアップロード可能なファイル（拡張子をカンマ区切りで指定する）
-		'allowedExt' => 'gif,jpg,png,pdf,zip,doc,docx,xls,xlsx,ppt,pptx'
+		'allowedExt' => 'gif,jpg,jpeg,png,ico,pdf,zip,doc,docx,xls,xlsx,ppt,pptx,txt',
+		// 'allowedExt' => 'mp4,mp3,mpg,mpeg,avi,wmv' // メディア例
+		// 'allowedExt' => 'fon,ttf,ttc' // フォント例
 ];
diff --git a/lib/Baser/Plugin/Uploader/Model/UploaderFile.php b/lib/Baser/Plugin/Uploader/Model/UploaderFile.php
index 6430a3c4e5..7d63deb4f2 100755
--- a/lib/Baser/Plugin/Uploader/Model/UploaderFile.php
+++ b/lib/Baser/Plugin/Uploader/Model/UploaderFile.php
@@ -73,7 +73,7 @@ public function __construct($id = false, $table = null, $ds = null) {
 				]
 			]
 		];
-		if(!BcUtil::isAdminUser()) {
+		if(!BcUtil::isAdminUser() || !Configure::read('Uploader.allowedAdmin')) {
 			$this->validate['name'] = [
 				'fileExt' => [
 					'rule' => ['fileExt', Configure::read('Uploader.allowedExt')],
diff --git a/lib/Baser/View/ThemeFiles/admin/form_folder.php b/lib/Baser/View/ThemeFiles/admin/form_folder.php
index 65411ea3b8..2086e8b25c 100755
--- a/lib/Baser/View/ThemeFiles/admin/form_folder.php
+++ b/lib/Baser/View/ThemeFiles/admin/form_folder.php
@@ -24,7 +24,7 @@
 
 
 <div class="em-box align-left">
-<?php echo __d('baser', '現在の位置')?>：<?php echo $currentPath ?>
+<?php echo __d('baser', '現在の位置')?>：<?php echo h($currentPath) ?>
 </div>
 
 <?php if ($this->request->action == 'admin_add_folder'): ?>
diff --git a/lib/Baser/View/ThemeFiles/admin/index.php b/lib/Baser/View/ThemeFiles/admin/index.php
index 0089f7bbf6..88ea8c8194 100755
--- a/lib/Baser/View/ThemeFiles/admin/index.php
+++ b/lib/Baser/View/ThemeFiles/admin/index.php
@@ -44,7 +44,7 @@
 <div id="MessageBox" style="display:none"><div id="flashMessage" class="notice-message"></div></div>
 
 <!-- current -->
-<div class="em-box align-left"><?php echo __d('baser', '現在の位置')?>：<?php echo $currentPath ?>
+<div class="em-box align-left"><?php echo __d('baser', '現在の位置')?>：<?php echo h($currentPath) ?>
 	<?php if (!$writable): ?>
 		　<span style="color:#FF3300">[<?php echo __d('baser', '書込不可')?>]</span>
 	<?php endif ?>
