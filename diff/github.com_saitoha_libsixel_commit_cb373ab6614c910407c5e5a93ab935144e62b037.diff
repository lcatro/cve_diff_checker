From cb373ab6614c910407c5e5a93ab935144e62b037 Mon Sep 17 00:00:00 2001
From: Hayaki Saito <saitoha@me.com>
Date: Sun, 15 Dec 2019 21:56:23 +0900
Subject: [PATCH] Avoid illegal memory access problem with 1 color paletted
 png(#73), Thanks to HongxuChen.

---
 src/dither.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/src/dither.c b/src/dither.c
index 72251d7..9c74eb3 100644
--- a/src/dither.c
+++ b/src/dither.c
@@ -284,9 +284,13 @@ sixel_dither_new(
         quality_mode = SIXEL_QUALITY_HIGHCOLOR;
     } else {
         if (ncolors > SIXEL_PALETTE_MAX) {
+            status = SIXEL_BAD_INPUT;
             ncolors = 256;
-        } else if (ncolors < 2) {
-            ncolors = 2;
+        } else if (ncolors < 1) {
+            status = SIXEL_BAD_INPUT;
+            sixel_helper_set_additional_message(
+                "sixel_dither_new: palette colors must be more than 0");
+            goto end;
         }
         quality_mode = SIXEL_QUALITY_LOW;
     }
