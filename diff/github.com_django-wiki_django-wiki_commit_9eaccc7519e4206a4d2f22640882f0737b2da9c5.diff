From 9eaccc7519e4206a4d2f22640882f0737b2da9c5 Mon Sep 17 00:00:00 2001
From: Benjamin Bach <benjamin@overtag.dk>
Date: Sun, 14 Nov 2021 21:53:33 +0100
Subject: [PATCH] Security fix (XSS) - Build HTML elements for notifications
 safely

---
 docs/release_notes.rst                               |  9 +++++++++
 .../static/wiki/plugins/notifications/js/ui.js       | 12 ++++++++++--
 2 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/docs/release_notes.rst b/docs/release_notes.rst
index abeaf2848..cb4018a8b 100644
--- a/docs/release_notes.rst
+++ b/docs/release_notes.rst
@@ -13,6 +13,15 @@ Release plan
 * **0.7.x** Removes Django 2.1 support, adds Django 3.1, 3.2
 
 
+0.7.9
+-----
+
+Security fixes
+~~~~~~~~~~~~~~
+
+* XSS vulnerability: Unescaped HTML in title propagated to notification (WhiteSource Vulnerability Research Team)
+
+
 0.7.8
 -----
 
diff --git a/src/wiki/plugins/notifications/static/wiki/plugins/notifications/js/ui.js b/src/wiki/plugins/notifications/static/wiki/plugins/notifications/js/ui.js
index dfc3c96dc..54df789e7 100644
--- a/src/wiki/plugins/notifications/static/wiki/plugins/notifications/js/ui.js
+++ b/src/wiki/plugins/notifications/static/wiki/plugins/notifications/js/ui.js
@@ -19,11 +19,19 @@ function notify_update() {
         n = data.objects[i];
         notify_latest_id = n.pk>notify_latest_id ? n.pk:notify_latest_id;
         notify_oldest_id = (n.pk<notify_oldest_id || notify_oldest_id==0) ? n.pk:notify_oldest_id;
+        var element_outer_div = $("<div />");
+        var element_a = $("<a />", {href: URL_NOTIFY_GOTO + n.pk + "/"});
+        var element_message_div;
+        var element_since_div;
         if (n.occurrences > 1) {
-          element = $('<div><a href="'+URL_NOTIFY_GOTO+n.pk+'/"><div>'+n.message+'</div><div class="since">'+n.occurrences_msg+' - ' + n.since + '</div></a></div>')
+          element_message_div = $("<div />", {text: n.message});
+          element_since_div = $("<div />", {text: n.occurrences_msg+' - ' + n.since, class: "since"});
         } else {
-          element = $('<div><a href="'+URL_NOTIFY_GOTO+n.pk+'/"><div>'+n.message+'</div><div class="since">'+n.since+'</div></a></div>');
+          element_message_div = $("<div />", {text: n.message});
+          element_since_div = $("<div />", {text: n.since, class: "since"});
         }
+        element_a.append(element_message_div).append(element_since_div);
+        element = element_outer_div.append(element_a);
         element.addClass('dropdown-item notification-item');
         element.insertAfter('.notification-before-list');
       }
