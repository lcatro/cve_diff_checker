From 661f723d39e03ca6eb05d7376a43ca33db478354 Mon Sep 17 00:00:00 2001
From: Cyrill Gorcunov <gorcunov@gmail.com>
Date: Sun, 28 Oct 2018 20:39:34 +0300
Subject: [PATCH] preproc: Fix out of bound access on malformed input

A fuzzer revealed a problem in preproc code.

https://bugzilla.nasm.us/show_bug.cgi?id=3392521

Reported-by: ganshuitao <ganshuitao@gmail.com>
Signed-off-by: Cyrill Gorcunov <gorcunov@gmail.com>
---
 asm/preproc.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/asm/preproc.c b/asm/preproc.c
index 0174c9ab..9034135c 100644
--- a/asm/preproc.c
+++ b/asm/preproc.c
@@ -4002,7 +4002,7 @@ static Token *expand_mmac_params(Token * tline)
     thead = NULL;
 
     while (tline) {
-        if (tline->type == TOK_PREPROC_ID &&
+        if (tline->type == TOK_PREPROC_ID && tline->text && tline->text[0] &&
             (((tline->text[1] == '+' || tline->text[1] == '-') && tline->text[2])   ||
               (tline->text[1] >= '0' && tline->text[1] <= '9')                      ||
                tline->text[1] == '%')) {
-- 
2.11.4.GIT

