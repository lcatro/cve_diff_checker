From 3358f060fc182551822576b2c0a8850faab5d543 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Thu, 9 Feb 2017 21:53:23 +0100
Subject: [PATCH] Fixed memory leak when creating nested exceptions in
 Magick++.

---
 ChangeLog                  |  4 ++++
 Magick++/lib/Exception.cpp | 14 ++++++++++----
 2 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 019b68c845..79d93e7f7b 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,7 @@
+2017-02-09  6.9.7-8 Dirk Lemstra <dirk@lem.....org>
+  * Fixed memory leak when creating nested exceptions in Magick++ (reference
+    https://www.imagemagick.org/discourse-server/viewtopic.php?f=23&p=142634)
+
 2017-02-06  6.9.7-8 Cristy  <quetzlzacatenango@image...>
   * Eliminate bogus assertion (reference
     https://github.com/ImageMagick/ImageMagick/issues/372).
diff --git a/Magick++/lib/Exception.cpp b/Magick++/lib/Exception.cpp
index 92ca629707..8ef34bc0a0 100644
--- a/Magick++/lib/Exception.cpp
+++ b/Magick++/lib/Exception.cpp
@@ -852,12 +852,18 @@ MagickPPExport void Magick::throwException(ExceptionInfo *exception_,
             exception_->description) != 0))
           {
             if (nestedException == (Exception *) NULL)
-              nestedException=createException(p);
+              {
+                nestedException=createException(p);
+                q=nestedException;
+              }
             else
               {
-                q=createException(p);
-                nestedException->nested(q);
-                nestedException=q;
+                Exception
+                  *r;
+
+                r=createException(p);
+                q->nested(r);
+                q=r;
               }
           }
       }
