From 7e00a578d6ba748f6d3bdc255a40a4a0a594e6f9 Mon Sep 17 00:00:00 2001
From: yossipapi <yossi.papiashvili@kaltura.com>
Date: Mon, 4 Sep 2017 13:40:04 +0300
Subject: [PATCH] No Plat: enforce strict validation on input fields

---
 admin_console/web/tools/AkamaiBroadcaster.php | 50 -------------------
 admin_console/web/tools/SimpleJWPlayer.php    | 23 ---------
 admin_console/web/tools/XmlJWPlayer.php       | 23 ---------
 admin_console/web/tools/bigRedButton.php      | 14 +++---
 .../web/tools/bigRedButtonPtsPoc.php          | 16 +++---
 admin_console/web/tools/safeGetInput.php      | 14 ++++++
 alpha/web/lib/bigRedButtonPtsPocHlsjs.php     | 16 +++---
 7 files changed, 40 insertions(+), 116 deletions(-)
 delete mode 100644 admin_console/web/tools/AkamaiBroadcaster.php
 delete mode 100644 admin_console/web/tools/SimpleJWPlayer.php
 delete mode 100644 admin_console/web/tools/XmlJWPlayer.php
 create mode 100644 admin_console/web/tools/safeGetInput.php

diff --git a/admin_console/web/tools/AkamaiBroadcaster.php b/admin_console/web/tools/AkamaiBroadcaster.php
deleted file mode 100644
index d9b56819e73..00000000000
--- a/admin_console/web/tools/AkamaiBroadcaster.php
+++ /dev/null
@@ -1,50 +0,0 @@
-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
-<head>
-<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
-<title>AkamaiBroadcaster_v1.1</title>
-<script language="javascript">AC_FL_RunContent = 0;</script>
-<script src="../js/AC_RunActiveContent.js" language="javascript"></script>
-</head>
-<body bgcolor="#ffffff">
-<!--url's used in the movie-->
-<!--text used in the movie-->
-<!-- saved from url=(0013)about:internet -->
-<script language="javascript">
-
-	
-	var flashVars = 'cpcode=<?php echo strip_tags($_GET['streamUsername']); ?>';
-	flashVars += '&passwd=<?php echo strip_tags($_GET['streamPassword']); ?>';
-	flashVars += '&streamname=<?php echo strip_tags($_GET['entryId']); ?>@<?php echo strip_tags($_GET['streamRemoteId']); ?>';
-	flashVars += '&primaryep=p.ep<?php echo strip_tags($_GET['streamRemoteId']); ?>.i.akamaientrypoint.net';
-	flashVars += '&backupep=b.ep<?php echo strip_tags($_GET['streamRemoteBackupId']); ?>.i.akamaientrypoint.net';
-	
-
-	if (AC_FL_RunContent == 0) {
-		alert("This page requires AC_RunActiveContent.js. In Flash, run \"Apply Active Content Update\" in the Commands menu to copy AC_RunActiveContent.js to the HTML output folder.");
-	} else {
-		AC_FL_RunContent(
-			'codebase', 'http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0',
-			'width', '760',
-			'height', '744',
-			'src', 'AkamaiBroadcaster_v1.1',
-			'quality', 'best',
-			'pluginspage', 'http://www.macromedia.com/go/getflashplayer',
-			'align', 'middle',
-			'play', 'true',
-			'loop', 'false',
-			'scale', 'showall',
-			'wmode', 'window',
-			'devicefont', 'false',
-			'id', 'AkamaiBroadcaster_v1.1',
-			'bgcolor', '#ffffff',
-			'name', 'AkamaiBroadcaster_v1.1',
-			'menu', 'true',
-			'allowScriptAccess','sameDomain',
-			'movie', 'AkamaiBroadcaster_v1.1',
-			'salign', '',
-			'flashvars', flashVars
-			); //end AC code
-	}
-</script>
-</body>
-</html>
diff --git a/admin_console/web/tools/SimpleJWPlayer.php b/admin_console/web/tools/SimpleJWPlayer.php
deleted file mode 100644
index 1d5a411106a..00000000000
--- a/admin_console/web/tools/SimpleJWPlayer.php
+++ /dev/null
@@ -1,23 +0,0 @@
-<html>
-  <body>
-    <div id="jw_wrap_1267721422280">
-      <object width="400" height="319" id="jw_player_1267721422280"
-      name="jw_player_1267721422280">
-        <param name="movie"
-        value="non-commercial.swf" />
-        <param name="wmode" value="transparent" />
-        <param name="allowScriptAccess" value="always" />
-        <param name="flashvars" value="file=<?php echo strip_tags($_GET['entryId']); ?>_1@<?php echo strip_tags($_GET['streamRemoteId']); ?>&subscribe=true&streamer=rtmp://cp<?php echo strip_tags($_GET['streamUsername']); ?>.live.edgefcs.net/live/&type=fcsubscribe" />
-        <embed id="jw_player__1267721422280"
-        name="jw_player__1267721422280"
-        src="non-commercial.swf"
-        width="400" height="319" allowfullscreen="true"
-        wmode="transparent" allowscriptaccess="always"
-        flashvars="file=<?php echo strip_tags($_GET['entryId']); ?>_1@<?php echo strip_tags($_GET['streamRemoteId']); ?>&subscribe=true&streamer=rtmp://cp<?php echo strip_tags($_GET['streamUsername']); ?>.live.edgefcs.net/live/&type=fcsubscribe" />
-        <noembed>
-          <a href="http://www.kaltura.org/">Open Source Video</a>
-        </noembed>
-      </object>
-    </div>
-  </body>
-</html>
diff --git a/admin_console/web/tools/XmlJWPlayer.php b/admin_console/web/tools/XmlJWPlayer.php
deleted file mode 100644
index 95f3f635448..00000000000
--- a/admin_console/web/tools/XmlJWPlayer.php
+++ /dev/null
@@ -1,23 +0,0 @@
-<html>
-  <body>
-    <div id="jw_wrap_1267721422280">
-      <object width="400" height="319" id="jw_player_1267721422280"
-      name="jw_player_1267721422280">
-        <param name="movie"
-        value="non-commercial.swf" />
-        <param name="wmode" value="transparent" />
-        <param name="allowScriptAccess" value="always" />
-        <param name="flashvars" value="config=/index.php/extwidget/streamclipper?entryId=<?php echo strip_tags($_GET['entryId']); ?>" />
-        <embed id="jw_player__1267721422280"
-        name="jw_player__1267721422280"
-        src="non-commercial.swf"
-        width="400" height="319" allowfullscreen="true"
-        wmode="transparent" allowscriptaccess="always" 
-        flashvars="config=/index.php/extwidget/streamclipper?entryId=<?php echo strip_tags($_GET['entryId']); ?>" />
-        <noembed>
-          <a href="http://www.kaltura.org/">Open Source Video</a>
-        </noembed>
-      </object>
-    </div>
-  </body>
-</html>
diff --git a/admin_console/web/tools/bigRedButton.php b/admin_console/web/tools/bigRedButton.php
index dc7daefa518..253fa13ef46 100644
--- a/admin_console/web/tools/bigRedButton.php
+++ b/admin_console/web/tools/bigRedButton.php
@@ -1,13 +1,15 @@
 <?php 
+
+require_once (dirname(__FILE__) . '/safeGetInput.php');
+
 if(!isset($_GET['partnerId']))
 	die('partnerId must be supplied in query string');
 	
 if(!isset($_GET['playerVersion']))
 	die('html5 lib version must be supplied in query string');
 
-$partnerId = strip_tags($_GET['partnerId']);
-
-$html5Version = strip_tags($_GET['playerVersion']);
+$partnerId = safeGetInput('partnerId', '/[^0-9]/');
+$html5Version = safeGetInput('playerVersion', '/[^v0-9.]/');
 ?>
 <!DOCTYPE html>
 <!--[if lt IE 7]>      <html class="lt-ie10 lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
@@ -305,15 +307,15 @@ function updateSystemTime()
 		</tr>
 		<tr>
 			<td>Admin Secret:</td>
-			<td><input type="text" id="txtSecret" value="<?php echo isset($_GET['secret']) ? strip_tags($_GET['secret']) : ''; ?>" />
+			<td><input type="text" id="txtSecret" value="<?php echo isset($_GET['secret']) ? safeGetInput('secret', '/[^A-Za-z0-9]/') : ''; ?>" />
 		</td>
 		<tr>
 			<td>Entry Id:</td>
-			<td><input type="text" id="txtEntryId" value="<?php echo isset($_GET['entryId']) ? strip_tags($_GET['entryId']) : ''; ?>" />
+			<td><input type="text" id="txtEntryId" value="<?php echo isset($_GET['entryId']) ? safeGetInput('entryId', '/[^a-z0-9_]/') : ''; ?>" />
 		</td>
 		<tr>
         	<td>uiConf Id:</td>
-            <td><input type="text" id="txtUiConfId" value="<?php echo isset($_GET['uiConfId']) ? strip_tags($_GET['uiConfId']) : ''; ?>" />
+            <td><input type="text" id="txtUiConfId" value="<?php echo isset($_GET['uiConfId']) ? safeGetInput('uiConfId', '/[^0-9]/') : ''; ?>" />
 		</td>
 		<tr>
 			<td colspan="2">
diff --git a/admin_console/web/tools/bigRedButtonPtsPoc.php b/admin_console/web/tools/bigRedButtonPtsPoc.php
index fd34d3d398c..d7dff70bfc7 100644
--- a/admin_console/web/tools/bigRedButtonPtsPoc.php
+++ b/admin_console/web/tools/bigRedButtonPtsPoc.php
@@ -1,13 +1,15 @@
-<?php 
+<?php
+require_once (dirname(__FILE__) . '/safeGetInput.php');
+
 if(!isset($_GET['partnerId']))
 	die('partnerId must be supplied in query string');
 	
 if(!isset($_GET['playerVersion']))
 	die('html5 lib version must be supplied in query string');
 
-$partnerId = strip_tags($_GET['partnerId']);
+$partnerId = safeGetInput('partnerId', '/[^0-9]/');
+$html5Version = safeGetInput('playerVersion', '/[^v0-9.]/');
 
-$html5Version = strip_tags($_GET['playerVersion']);
 ?>
 <!DOCTYPE html>
 <!--[if lt IE 7]>      <html class="lt-ie10 lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
@@ -210,19 +212,19 @@ function sendAd(){
 	  	<table>
 		<tr style="display: none; ">
 			<td>Admin Secret:</td>
-			<td><input type="text" id="txtSecret" value="<?php echo isset($_GET['secret']) ? strip_tags($_GET['secret']) : ''; ?>" />
+			<td><input type="text" id="txtSecret" value="<?php echo isset($_GET['secret']) ? safeGetInput('secret', '/[^A-Za-z0-9]/') : ''; ?>" />
 		</td>
 		<tr style="display: none; ">
 			<td>Entry Id:</td>
-			<td><input type="text" id="txtEntryId" value="<?php echo isset($_GET['entryId']) ? strip_tags($_GET['entryId']) : ''; ?>" />
+			<td><input type="text" id="txtEntryId" value="<?php echo isset($_GET['entryId']) ? safeGetInput('entryId', '/[^a-z0-9_]/') : ''; ?>" />
 		</td>
 		<tr style="display: none; ">
         	<td>Admin uiConf Id:</td>
-            <td><input type="text" id="txtAdminUiConfId" value="<?php echo isset($_GET['adminUiConfId']) ? strip_tags($_GET['adminUiConfId']) : ''; ?>" />
+            <td><input type="text" id="txtAdminUiConfId" value="<?php echo isset($_GET['adminUiConfId']) ? safeGetInput('adminUiConfId', '/[^0-9]/') : ''; ?>" />
 		</td>
 		<tr style="display: none; ">
         	<td>User uiConf Id:</td>
-            <td><input type="text" id="txtUiConfId" value="<?php echo isset($_GET['uiConfId']) ? strip_tags($_GET['uiConfId']) : ''; ?>" />
+            <td><input type="text" id="txtUiConfId" value="<?php echo isset($_GET['uiConfId']) ? safeGetInput('uiConfId', '/[^0-9]/') : ''; ?>" />
 		</td>
 		<tr style="display: none; ">
 			<td colspan="2">
diff --git a/admin_console/web/tools/safeGetInput.php b/admin_console/web/tools/safeGetInput.php
new file mode 100644
index 00000000000..313b9df8b22
--- /dev/null
+++ b/admin_console/web/tools/safeGetInput.php
@@ -0,0 +1,14 @@
+<?php
+
+function safeGetInput($filedName, $pattern)
+{
+	$fieldValue = $_GET[$filedName];
+	if (preg_match($pattern, $fieldValue))
+	{
+		return '';
+	}
+	
+	return $fieldValue;
+}
+
+?>
diff --git a/alpha/web/lib/bigRedButtonPtsPocHlsjs.php b/alpha/web/lib/bigRedButtonPtsPocHlsjs.php
index 102fd4c8b1b..b799b37fe86 100644
--- a/alpha/web/lib/bigRedButtonPtsPocHlsjs.php
+++ b/alpha/web/lib/bigRedButtonPtsPocHlsjs.php
@@ -1,13 +1,15 @@
-<?php 
+<?php
+require_once (dirname(__FILE__) . '/../../../admin_console/web/tools/safeGetInput.php');
+
 if(!isset($_GET['partnerId']))
 	die('partnerId must be supplied in query string');
 	
 if(!isset($_GET['playerVersion']))
 	die('html5 lib version must be supplied in query string');
 
-$partnerId = $_GET['partnerId'];
+$partnerId = safeGetInput('partnerId', '/[^0-9]/');
+$html5Version = safeGetInput('playerVersion', '/[^v0-9.]/');
 
-$html5Version = $_GET['playerVersion'];
 ?>
 <!DOCTYPE html>
 <!--[if lt IE 7]>      <html class="lt-ie10 lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
@@ -212,19 +214,19 @@ function sendAd(){
 	  	<table>
 		<tr style="display: none; ">
 			<td>Admin Secret:</td>
-			<td><input type="text" id="txtSecret" value="<?php echo isset($_GET['secret']) ? $_GET['secret'] : ''; ?>" />
+			<td><input type="text" id="txtSecret" value="<?php echo isset($_GET['secret']) ? safeGetInput('secret', '/[^A-Za-z0-9]/') : ''; ?>" />
 		</td>
 		<tr style="display: none; ">
 			<td>Entry Id:</td>
-			<td><input type="text" id="txtEntryId" value="<?php echo isset($_GET['entryId']) ? $_GET['entryId'] : ''; ?>" />
+			<td><input type="text" id="txtEntryId" value="<?php echo isset($_GET['entryId']) ? safeGetInput('entryId', '/[^a-z0-9_]/') : ''; ?>" />
 		</td>
 		<tr style="display: none; ">
         	<td>Admin uiConf Id:</td>
-            <td><input type="text" id="txtAdminUiConfId" value="<?php echo isset($_GET['adminUiConfId']) ? $_GET['adminUiConfId'] : ''; ?>" />
+            <td><input type="text" id="txtAdminUiConfId" value="<?php echo isset($_GET['adminUiConfId']) ? safeGetInput('adminUiConfId', '/[^0-9]/') : ''; ?>" />
 		</td>
 		<tr style="display: none; ">
         	<td>User uiConf Id:</td>
-            <td><input type="text" id="txtUiConfId" value="<?php echo isset($_GET['uiConfId']) ? $_GET['uiConfId'] : ''; ?>" />
+            <td><input type="text" id="txtUiConfId" value="<?php echo isset($_GET['uiConfId']) ? safeGetInput('uiConfId', '/[^0-9]/') : ''; ?>" />
 		</td>
 		<tr style="display: none; ">
 			<td colspan="2">
