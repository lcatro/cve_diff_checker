From 12f66f69f7bf1ec1266ddbee90a7616cbf33696b Mon Sep 17 00:00:00 2001
From: Denis Ovsienko <denis@ovsienko.info>
Date: Tue, 12 Sep 2017 10:59:16 +0100
Subject: [PATCH] (for 4.9.3) CVE-2018-14470/Babel: fix an existing length
 check

In babel_print_v2() the non-verbose branch for an Update TLV compared
the TLV Length against 1 instead of 10 (probably a typo), put it right.

This fixes a buffer over-read discovered by Henri Salo from Nixu
Corporation.

Add a test using the capture file supplied by the reporter(s).
---
 print-babel.c                |   2 +-
 tests/TESTLIST               |   1 +
 tests/babel_update_oobr.out  |  66 +++++++++++++++++++++++++++++++++++
 tests/babel_update_oobr.pcap | Bin 0 -> 9888 bytes
 4 files changed, 68 insertions(+), 1 deletion(-)
 create mode 100644 tests/babel_update_oobr.out
 create mode 100644 tests/babel_update_oobr.pcap

diff --git a/print-babel.c b/print-babel.c
index f8741d7bf..1a31f2a3c 100644
--- a/print-babel.c
+++ b/print-babel.c
@@ -480,7 +480,7 @@ babel_print_v2(netdissect_options *ndo,
         case MESSAGE_UPDATE: {
             if (!ndo->ndo_vflag) {
                 ND_PRINT((ndo, " update"));
-                if(len < 1)
+                if(len < 10)
                     ND_PRINT((ndo, "/truncated"));
                 else
                     ND_PRINT((ndo, "%s%s%s",
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 7c1b84e58..e841424c8 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -583,6 +583,7 @@ icmp6_nodeinfo_oobr	icmp6_nodeinfo_oobr.pcap	icmp6_nodeinfo_oobr.out
 
 # bad packets from Henri Salo
 rx_ubik-oobr		rx_ubik-oobr.pcap		rx_ubik-oobr.out -c1
+babel_update_oobr	babel_update_oobr.pcap	babel_update_oobr.out	-c 52
 
 # RTP tests
 # fuzzed pcap
diff --git a/tests/babel_update_oobr.out b/tests/babel_update_oobr.out
new file mode 100644
index 000000000..1d60fee09
--- /dev/null
+++ b/tests/babel_update_oobr.out
@@ -0,0 +1,66 @@
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O^O^O^O^O^DM-2M-!M-1M-1M-1M-1M-1M-1M-1M-1M-,.M-0^Vn [|kerberos]
+IP 10.0.0.1 > 0.234.154.214: ip-proto-17
+IP 10.0.0.1.88 > 0.234.154.179.24191:  v4 be KDC_REQUEST: ^O^O^O^O^O^DM-2 .*^C@>M-z}M-uM-tM-+M-_M-{S^PM-=OM-^Y [|kerberos]
+58:5e:0a:02:f4:0a > 02:8e:00:50:6a:e1, ethertype Unknown (0xb104), length 3892667167: 
+	0x0000:  020f 0f0f 0f0f 0f0f 0f0f 04b2 a1b1 b1b1  ................
+	0x0010:  b1b1 b1b1 b158 5e0a 02f4 0ab1 0402 0f0f  .....X^.........
+	0x0020:  ff80 0f0f 0f0f 0f00 80a1 00b2 b2b2 b20d  ................
+	0x0030:  0d3a 3400 0001 00                        .:4....
+IP 6.3.218.255.6379 > 0.1.31.99.639: Flags [S.UW], seq 2751463404:2751463426, ack 1006637056, win 45746, urg 25778, length 22: RESP [|RESP]
+IP 6.3.208.255.6379 > 0.1.31.99.639: Flags [S.UW], seq 2751463404:2751463426, ack 1006640128, win 45746, urg 25778, length 22: RESP "M-2M-2M-2M-2M-2M-7dM-2M-2M-2M-2M-2" [|RESP]
+IP 208.21.10.1.654 > 31.99.100.232.80:  aodv rrep 34  prefix 4 hops 11
+	dst 237.34.38.84 dseq 32203525 src 232.11.2.0 67108864 ms
+	ext 0 0
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O^O^O^O^O^DM-WM-WM-WM-WM-WM-WM-W.@ 680min  [|kerberos]
+IP 10.0.253.1.88 > 0.234.154.214.24073:  v4 be KDC_REQUEST: .M-^?M-^?^AM-^@M-^?M-^@M-V@M-WM-WM-sM-WM-WM-WM-WM-W 880min ^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O7M-^@M-^?.d^O^O^O^O^O^O^O^O^O^O^O^O@^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24073:  v4 be KDC_REQUEST: .M-^?M-^?^AM-^@M-^?M-^@M-V@M-WM-WM-sM-WM-WM-WM-WM-W 880min ^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O7M-^@M-^?.d^O^O^O^O^O^O^O^O^O^O^O^O@^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O.^DM-2M-!^BM-W^CM-!^B@^D 0min ^P.^VM-^H [|kerberos]
+IP 10.0.242.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O'^O^O@@.@^Qjp^J@ 1070min .X^^J^B [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O^U.@^O^D^O^O^O^O^O^O^O^O^O^O^O^O [|kerberos]
+IP 10.0.222.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O^DM-2 .M-g^C@>M-y}M-uM-tM-+M-` 680min  [|kerberos]
+01:01:ed:83:e3:ff > 02:8e:00:50:6d:e1, ethertype Unknown (0x0700), length 3892672031: 
+	0x0000:  4508 8834 d940 4000 4011 4a70 0a00 0001  E..4.@@.@.Jp....
+	0x0010:  00ea 9ad6 0058 5e0a 02f4 0ab1 0402 0f0f  .....X^.........
+	0x0020:  0f0f 0f0f 0f0f 0f04 b2a1 b1b1 b1b1 b1b1  ................
+	0x0030:  b1b1 b100 b016 6e                        ......n
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O^U.@ ^D^R^O^O^O^O^O^O^O^O^O^O^O [|kerberos]
+IP 10.0.255.127.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O^DM-2 .M-g^C@>M-z}M-uM-tM-^\M-`^VM-^?^?M-=OM-^Y [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O.^B^O^O^O^O^DM-2M-!M-1M-1M-1M-1M-1M-1M-1M-1M-1M-^@M-0^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O7M-^@M-^?M-^@^D^O^O^O^O^O^P.M-^?M-^?^O^O^O@^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O.^DM-#M-^?M-^?d^O^O^O^O^O^O^O^O^O^O^O^O@^VM-^H [|kerberos]
+IP 0.0.1.0 > 234.154.214.0: ip-proto-106
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O7M-^@M-^?M-^@^D^O^O^O^O^O^P.M-^?M-^?^O^O^O@^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O.^DM-^@M-^?M-^?M-^?^CM-!^B@^D 0min ^P.^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O^O^O^O^O^DM-WM-WM-WM-WM-WM-WM-W.@ 680min  [|kerberos]
+IP 10.0.253.1.8280 > 0.234.154.214.24073: UDP, bad length 60652 > 32792
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O7M-^@M-^?.d^O^O^O^O^O^O^O^O^O^O^O^O@^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O.^DM-2M-!^BM-W^CM-!^B@^D 0min ^P.^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O'^O^O@@.@^Qjp^J@ 1070min .X^^J^B [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 le APPL_REQUEST_MUTUAL: (unknown)
+01:00:01:00:00:00 > 02:8e:00:50:6a:e1, ethertype Unknown (0x08e8), length 3892667167: 
+	0x0000:  4408 8034 d92b 4000 4011 3b70 0a00 0001  D..4.+@.@.;p....
+	0x0010:  00ea 9ad6 0058 5e0a 02f4 0ab1 0402 ffff  .....X^.........
+	0x0020:  ff7f 80ff 80d6 00c3 0880 34d9 4040 0040  ..........4.@@.@
+	0x0030:  114a 700a 0016 88                        .Jp....
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: .M-oM-^?M-^?@M-^?M-^@M-V M-WM-WM-WM-WM-WM-WM-WM-W 0min ^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.210.24073:  v4 be KDC_REQUEST: .M-^?M-^?^AM-^@M-^?M-^@M-V@M-WM-WM-sM-WM-WM-WM-WM-W 880min ^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O7M-^@M-^?.d^O^O^O^O^O^O^O^O^O^O^O^O@^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O.^DM-2M-!^BM-WM-^?M-!^B^O^O^P@M-^?M-^?^O^O^O [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O.^DM-#M-^?M-^?d^O^O^O^O^O^O^O^O^O^O^O^O@^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O.^DM-2M-!^BM-W^CM-!^B@^D 0min ^P.^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074: 
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O.^DM-^@M-^?M-^?M-^?^CM-!^B@^D 0min ^P.^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074: 
+IP 10.0.253.1.88 > 0.234.154.214.24073:  v4 be KDC_REQUEST: .M-^?M-^?^AM-^@M-^?M-^@M-V@M-WM-WM-sM-WM-WM-WM-WM-W 880min ^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O7M-^@M-^?.d^O^O^O^O^O^O^O^O^O^O^O^O@^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O.^DM-2M-!^BM-W^CM-!^B@^D 0min ^P.^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O'^O^O@@.@^Qjp^J@ 1070min .X^^J^B [|kerberos]
+IP 64.0.0.1.88 > 0.234.154.214.24074:  v4 le APPL_REQUEST_MUTUAL: (unknown)
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: M-^?M-^?M-^?^?M-^@M-^?M-^@M-V.M-C^HM-^@4M-Y@@@@^QJp^J [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: .M-oM-^?M-^?@M-^?M-^@M-V 75min ^O^O^O^O^O^O^O^O.^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O.^DM-2M-!^BM-W^CM-!^B@^D 0min ^P.^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O^O7M-^@M-^?M-^@^D^O^O^O^O^O^P.M-^?M-^?^O^O^O@^VM-^H [|kerberos]
+IP 10.0.0.1.88 > 0.234.154.214.24074:  v4 be KDC_REQUEST: ^O^O^O^O.^DM-^@M-^?M-^?M-^?^CM-!^B@^D 0min ^P.^VM-^H [|kerberos]
+IP 208.21.42.58.6697 > 110.228.104.254.30952: babel 2 (2056) update/truncated update/truncated update/truncated [|babel]
diff --git a/tests/babel_update_oobr.pcap b/tests/babel_update_oobr.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..2406c043ed93707c6bd2416636fc0739eab8d42e
GIT binary patch
literal 9888
zcmeHNU1%It6h1RMO*dQ8-A$8Ne`=<JN>dP{L7__72Ln<Hrr3vy(3h@Ig4RGme5pI2
z5B0_OiarD%73r=I`r=a&d|dp=Rzc08(8V;UHR9U8>pADn+_^KevpbEuYz%W@f0AXt
zIXUM$-}#w*bE&p$f&~W9dGzsle5Utys{jtZ9>vG>Ydc!zJFxIdbH4#^0c2r5dwvd}
z1f}AUr5t_X*LPRo#L1kwk*iu}-aA%px$2&e;NsMo@eLc{egIg-7Z>}K#9nL`jrBJr
zwlnu#=|#j|3}QRrVNU|&t#R)v_zF|!_ei@LID%~uwncUmcEIjW(C&)x?Y3$*%w*v3
z^>cr1eE8Fi=L?@dccBEA&pvpTp@ndyPn6wV|7`6;;jqErEJF>?*w`U-A-ei58(t#l
zGCpj^CZF#SbR2^Y+6{2nejniG$nKGm%=ZF}=~H{x%*qEsTzwh}@B$%zTBhe3e%ZkX
z>=PA$0>_fErN4V&*F)I%1+cwqjE#Xw#xJ1pWVerfZ)dxU?UVJ%99mswCLQ~tgaGAT
z>kmA1+*m_b?jjC)N5vAaK_|#Tj-}+FF%^tuM-DdRK^y_dlW`%g<C~8e*~LZ!(1{Dj
znuKjIw$77V9=}JgGEYDV!x7F3G#Y<0IAJ>%nS=Q&wu|gyzl!`m2MddcO@Uz!J`v)e
zwA<(Rla7G0MsMObMw4O*qvUztZp=#%%|8OU6W}*tC$f7l!SZ2$ceDGAK+gBD`|i!#
zt?3D%mY9tUYZbII$n2P$S6Zd>1QbuMd9hU359jmzX;f{#WUbPCqH^9aZfaUZ{*Hdz
z)j`&(P%OJ^75gi!RX;}TMoiMGE2vffkXEfG^vTa+C+l}d4*EJsCTsd#mHLftC;bll
zWS;r0>vz;ANPbPf?K{`+NM2$}sJgS;!}fea`u*POl&JL5Z=WZ6&SMZ1wp-JH3!Cnf
zxSS`RxH*5z<4J;?cP!>f0rdsnX#CEG{Y`q(Bj<CLiX~WBCn9=+LX8EYr=Ccfgy`+p
z`F`bP2Y=`DsDp#^iGvPs_2lb2)svXI<LJFlzv_;iP`_<S5`6Bd-*J6a!n$Jt_iVlE
zj?!3UbD#7(%9D8g?yOa^7I)VwleB7-vvITf-Fk+4&4Z+aPX+zWc}dyFJ;bFzOX~Hp
zMz}wr{#*7Z+#^HfC?)3cqR{~xeiH&4k`>#fU;{Z3>V2-^&#I5@*88x(ze?Ie*oZ1m
z90%V{po4wweIgtb%c$d9OJl<`NvMw<Oz!NHbK3t+W2=8_^JTv@wtxI~hR*N*-XjlA
zV@vw3KxypsW;IsM^F!5G+(c-H=Cp);)lhQY?N5f5^E|<NI}Y+x4g?Kz?vA5uKZ`q#
zVtchdIdkaDFQ;$cbKv#X?KvT4%xvdl(6477dt`PemL13TYZ}!{ZKs6m6~dk<wlnof
z^Rt{`V2^J6PBm5j>f0ReA>@2HJ+Yta<3SJ`WHG{u5q#yE)@i;}u{?l(ioNFU!rC-9
z1TKQt4J|uDvs5b+w!7f@B*tzXvW&Ynch43xr)52#tn*GO8Mfw=4Eltk1u&b~CxKl-
z`+hm6$*iGS3h~O-3$b?ZkTdrQJ(h)+B~LDA>Jv>rmP=kNb)O(SpLC}*jGdD0dOyKT
zlJ1n!of5KzHI{Qe-6?s=qkOVmc1o&V25N)0uj<dPH`>Qyt2VUWM@BQYhlsnEF_4|o
z)|+?Iof3^k{!uy4eXPNsx%UKyI`5=ACCr_4r=;$u1vNI^DILLm>{h#9Y@)1ada}*-
z_9YTd?_OQHQ|j_RIfL0F4|}I1Yo_X}LjT9Hr1hFxEicLP?VFc@-d^Qp-rx0dPov*+
I?-ZYZ0pw{_(EtDd

literal 0
HcmV?d00001

