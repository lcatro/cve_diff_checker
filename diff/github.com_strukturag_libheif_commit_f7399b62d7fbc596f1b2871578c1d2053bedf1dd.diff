From f7399b62d7fbc596f1b2871578c1d2053bedf1dd Mon Sep 17 00:00:00 2001
From: Joachim Bauch <bauch@struktur.de>
Date: Fri, 2 Aug 2019 14:54:39 +0200
Subject: [PATCH] Handle case where referenced "iref" box doesn't exist (fixes
 #138).

---
 fuzzing/corpus/github_138.heic | Bin 0 -> 4914 bytes
 libheif/heif_context.cc        |   6 ++++++
 2 files changed, 6 insertions(+)
 create mode 100644 fuzzing/corpus/github_138.heic

diff --git a/fuzzing/corpus/github_138.heic b/fuzzing/corpus/github_138.heic
new file mode 100644
index 0000000000000000000000000000000000000000..75fdc979d2e3c86713ff6b51a834ea42d020ab61
GIT binary patch
literal 4914
zcmeH|eM}Q)7{H%vuk95Iw532npx08Nd<d=RWTrwbx`A;Ena<(1WHg1!C88H>HZ>-K
zEfJlWI80=T$xxSVW=n+sX56%PE@j!4nJgKbSvGZU)44zJgAJqP_P$R!EHV?!K7xyv
z^!L8M_oMgR`#$d-0GI>8En;hn;0JQG2?1BUo}Saz67=!pBF(ne=JoBgPA^gL2jjH~
z(uwvdEq@_oOsXgZ+ko_e3xHiB2pa;_@D3SRNd%ejsPQ3Q5J-%jf3%xZmSZ;MyhD!c
zKiwm8_*)d@&fwztb?rhkx%mT}_x*Crv!w(`dP5M~MF8z8LG*6~P&j8An>5pb|HpBX
zG^-x}-wY@5NohUNNxsz1WP20m%w+sSIc8c$Olz2Rk2NjAX$^lT<SBo4zZ4}eP}99P
zxlfxG$B|Bb;)DlzXC=;?P4y`&HJbwar(+?T2N3!JV96<x5GNYfKF?zltT+WQxQKj@
zj^Ax_Q~?;00fvr?zIGpuQxYly0f6i80Hmx1NIy&Fys#-yIUoBOofkm$y(HZz1km&X
zjQ2>=?Zc8Zegr`I9YACQeP^}4?5|~%<g*6@IL$o*cgDxY0Fsscz(AIV(J_)lZ)T+<
zNJR;5(S8URX4K2zOy%8<{v<9f)B4Nu3u(LEQFV&CXR+5}+7i~~r0~ITwc`e7UXbIt
z!fiXaMjv{&_R__HaGuvvlo95C)!)i9U+HT&>2MgfavG)W*>0V=z;yuz&n)Z9G<$kG
ztBR94Ue~gbpQ4t6BYBlcS)ZsB6-(iK^NK+x#0K1aW>t5u;$zMz7OAWa#-)5;?qKbu
zp#N>3cdWmE`DH#=w`&dWY%+v<Vv0S+rbeIQY4-eEC5k$Gy7B<GefU`KHOuhNW5={&
zeTZ|1J*weP$M#;mvF*9=2lmt9e6MBn>ZLnRj@~+18hz2&6iu_H4PB0{jCNgH>Us67
zrz+d{zNhJQ_Fhi)n#~>=h_VN@r|VX;QeB~@Tz}`aJ;Bc%FPTi-N361QU&$G@&d@i~
z(Rk6eGFivhM-H00JoW63ruGXn_)`sASH8MX-y_`{a?P{|$G6_9F^uorxO?OP+vf}o
z)m~rh`pS7|TSJ5Grao1@>^;5N`Gh~p_`7#G%bcA>3h|i?#%|Pheipv>&oZ8hbaWhr
zj>9A?w9A-?uYJg~%1-jaBy18}Fn56QkaC3l^rEm?plwQy;{cdyL2QesEx-a`l%dWY
zpg<~-EK-G3BQ;14sYNCslaV@P3NjU$hSVbsNFy>GX+mZoGm%+HGcp^QgPeoRMdl&%
zkrpJ6v?6WD0;C-|7g>lbLOPJe$P#2JvJ5#7S&pngx+chWsbRiqXScR1iLR#5><f~^
ztbs`KS+b@cVf{uw10Zz(R03nA3r#eKu6PU-RH@H#qSLb*_dn2C*>g{#t7OmXLRX`c
zf5~5ou95pK>9iIj`$;bH|CV!9K`T3d2sq+2V(hoJk}?M5wH0?;1-fq1e<!tJNRhqZ
z3+zvo-M*jHzJ)Z|=eA+LUiQKT=!QwZjc$~^C`xKy0!B^ab?n1_liXk2h@K&PiG|d@
zhRjJH#r`bWOFu+6%U%{j&z61O3iKS=%V}gWm^10$py$e7@g{nn>@M;$C*$)ceI7cE
z3fI$h6P>3@pJ)CFQpU)8dBQ7qpxb13)ssOnD3E<2UAY+0GmG;V4wLd6#Lq4n`q&`x
z7?95exri^?j9w&rRSmjB_Qz?a#GrW6<NH@K;nH@xe=#VX@c458l*!}WG*bU>^eORv
z?kl8>LAmTp2GD8NV1M;1=rpU*YpT&*G*)1KlxQ=_z=_Wv`5=0UuOlafUJRrkjnMK>
D{j(@@

literal 0
HcmV?d00001

diff --git a/libheif/heif_context.cc b/libheif/heif_context.cc
index b5dabd63..decbe836 100644
--- a/libheif/heif_context.cc
+++ b/libheif/heif_context.cc
@@ -813,6 +813,12 @@ Error HeifContext::get_id_of_non_virtual_child_image(heif_item_id id, heif_item_
       image_type=="iden" ||
       image_type=="iovl") {
     auto iref_box = m_heif_file->get_iref_box();
+    if (!iref_box) {
+      return Error(heif_error_Invalid_input,
+                   heif_suberror_No_item_data,
+                   "Derived image does not reference any other image items");
+    }
+
     std::vector<heif_item_id> image_references = iref_box->get_references(id, fourcc("dimg"));
 
     // TODO: check whether this really can be recursive (e.g. overlay of grid images)
