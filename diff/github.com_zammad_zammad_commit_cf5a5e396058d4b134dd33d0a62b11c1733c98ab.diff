From cf5a5e396058d4b134dd33d0a62b11c1733c98ab Mon Sep 17 00:00:00 2001
From: Rolf Schmidt <rolf.schmidt@znuny.com>
Date: Thu, 29 Oct 2020 15:43:14 +0100
Subject: [PATCH] Maintenance: Improved article view for agent customer.

---
 app/policies/ticket/article_policy.rb       | 4 ++--
 app/policies/ticket_policy.rb               | 4 ++++
 spec/factories/role.rb                      | 4 ++++
 spec/policies/ticket/article_policy_spec.rb | 9 +++++++++
 4 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/app/policies/ticket/article_policy.rb b/app/policies/ticket/article_policy.rb
index 31309643b2..e01c85a361 100644
--- a/app/policies/ticket/article_policy.rb
+++ b/app/policies/ticket/article_policy.rb
@@ -55,9 +55,9 @@ def deletable_timeframe
   end
 
   def access?(query)
-    return false if record.internal == true && !user.permissions?('ticket.agent')
-
     ticket = Ticket.lookup(id: record.ticket_id)
+    return false if record.internal == true && !TicketPolicy.new(user, ticket).agent_read_access?
+
     Pundit.authorize(user, ticket, query)
   end
 end
diff --git a/app/policies/ticket_policy.rb b/app/policies/ticket_policy.rb
index 87ab085fdf..fd56de931e 100644
--- a/app/policies/ticket_policy.rb
+++ b/app/policies/ticket_policy.rb
@@ -41,6 +41,10 @@ def follow_up?
     raise Exceptions::UnprocessableEntity, 'Cannot follow-up on a closed ticket. Please create a new ticket.'
   end
 
+  def agent_read_access?
+    agent_access?('read')
+  end
+
   private
 
   def access?(access)
diff --git a/spec/factories/role.rb b/spec/factories/role.rb
index 6b28425624..55e6ae2653 100644
--- a/spec/factories/role.rb
+++ b/spec/factories/role.rb
@@ -8,6 +8,10 @@
       permissions { Permission.where(name: 'ticket.agent') }
     end
 
+    trait :customer do
+      permissions { Permission.where(name: 'ticket.customer') }
+    end
+
     trait :admin do
       permissions { Permission.where(name: 'admin') }
     end
diff --git a/spec/policies/ticket/article_policy_spec.rb b/spec/policies/ticket/article_policy_spec.rb
index e469dec362..6b8d1be544 100644
--- a/spec/policies/ticket/article_policy_spec.rb
+++ b/spec/policies/ticket/article_policy_spec.rb
@@ -29,6 +29,15 @@
       it { is_expected.to permit_actions(%i[show]) }
     end
 
+    context 'when agent and customer but no agent group access' do
+      let(:user) do
+        customer_role = create(:role, :customer)
+        create(:agent_and_customer, roles: [customer_role])
+      end
+
+      it { is_expected.not_to permit_actions(%i[show]) }
+    end
+
     context 'when customer' do
       let(:user) { ticket_customer }
 
