From 6f55964803054a5acb5feda92c7c7f1d91ab5366 Mon Sep 17 00:00:00 2001
From: ales-infotel <alban.lesellier@infotel.com>
Date: Wed, 24 Nov 2021 11:50:03 +0100
Subject: [PATCH] fix Remote Command Execution vulnerability

---
 ajax/addressing.php      | 5 ++++-
 ajax/ping.php            | 2 +-
 front/reserveip.form.php | 4 +++-
 3 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/ajax/addressing.php b/ajax/addressing.php
index a9a449d..c05b2d3 100644
--- a/ajax/addressing.php
+++ b/ajax/addressing.php
@@ -59,6 +59,9 @@
 } else {
    Html::popHeader(__s('IP reservation', 'addressing'), $_SERVER['PHP_SELF']);
    $PluginAddressingReserveip = new PluginAddressingReserveip();
-   $PluginAddressingReserveip->showReservationForm($_GET["ip"], $_GET['id_addressing'], $_GET['rand']);
+   if(filter_var($_GET["ip"], FILTER_VALIDATE_IP)) {
+      $PluginAddressingReserveip->showReservationForm($_GET["ip"], $_GET['id_addressing'], $_GET['rand']);
+   }
+
    Html::popFooter();
 }
diff --git a/ajax/ping.php b/ajax/ping.php
index 0493b8f..6d308b7 100644
--- a/ajax/ping.php
+++ b/ajax/ping.php
@@ -40,7 +40,7 @@
 
 Session::checkLoginUser();
 
-if (!isset($_POST['ip'])) {
+if (!isset($_POST['ip']) || !filter_var($_POST["ip"], FILTER_VALIDATE_IP)) {
    exit();
 }
 $ip = $_POST['ip'];
diff --git a/front/reserveip.form.php b/front/reserveip.form.php
index 1c171b9..0317bae 100644
--- a/front/reserveip.form.php
+++ b/front/reserveip.form.php
@@ -37,6 +37,8 @@
    Html::back();
 } else {
    Html::header(PluginAddressingReserveip::getTypeName(), '', "tools", "pluginaddressingmenu");
-   $reserveip->showReservationForm($_REQUEST["ip"], $_REQUEST["id_addressing"], $_REQUEST['rand']);
+   if(filter_var($_REQUEST["ip"], FILTER_VALIDATE_IP)) {
+      $reserveip->showReservationForm($_REQUEST["ip"], $_REQUEST["id_addressing"], $_REQUEST['rand']);
+   }
    Html::footer();
 }
