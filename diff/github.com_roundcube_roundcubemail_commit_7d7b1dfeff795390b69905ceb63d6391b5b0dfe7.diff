From 7d7b1dfeff795390b69905ceb63d6391b5b0dfe7 Mon Sep 17 00:00:00 2001
From: Aleksander Machniak <alec@alec.pl>
Date: Tue, 31 Aug 2021 19:25:13 +0200
Subject: [PATCH] Fix XSS issue in handling attachment filename extension in
 mimetype mismatch warning (#8193)

---
 CHANGELOG                  |  2 ++
 program/steps/mail/get.inc | 27 ++++++++++++++++-----------
 2 files changed, 18 insertions(+), 11 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index a2a6cfa0c4..abd4baa96e 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -1,6 +1,8 @@
 CHANGELOG Roundcube Webmail
 ===========================
 
+- Fix XSS issue in handling attachment filename extension in mimetype mismatch warning (#8193)
+
 RELEASE 1.3.16
 --------------
 - Security: Fix cross-site scripting (XSS) via HTML or Plain text messages with malicious content [CVE-2020-35730]
diff --git a/program/steps/mail/get.inc b/program/steps/mail/get.inc
index 526ec0d758..1952d91f58 100644
--- a/program/steps/mail/get.inc
+++ b/program/steps/mail/get.inc
@@ -184,21 +184,26 @@ if (empty($_GET['_thumb']) && $attachment->is_valid()) {
             else {  // html warning with a button to load the file anyway
                 $OUTPUT = new rcmail_html_page();
                 $OUTPUT->write(html::tag('html', null, html::tag('body', 'embed',
-                    html::div(array('class' => 'rcmail-inline-message rcmail-inline-warning'),
-                        $RCMAIL->gettext(array(
-                            'name' => 'attachmentvalidationerror',
-                            'vars' => array(
-                                'expected' => $mimetype . ($file_extension ? " (.$file_extension)" : ''),
-                                'detected' => $real_mimetype . ($extensions[0] ? " (.$extensions[0])" : ''),
+                    html::div(
+                        array('class' => 'rcmail-inline-message rcmail-inline-warning'),
+                        $RCMAIL->gettext(
+                            array(
+                                'name' => 'attachmentvalidationerror',
+                                'vars' => array(
+                                    'expected' => $mimetype . (!empty($file_extension) ? rcube::Q(" (.{$file_extension})") : ''),
+                                    'detected' => $real_mimetype . (!empty($extensions[0]) ? " (.{$extensions[0]})" : ''),
+                                )
                             )
-                        ))
-                        . html::p(array('class' => 'rcmail-inline-buttons'),
-                            html::tag('button', array(
+                        )
+                    )
+                    . html::p(array('class' => 'rcmail-inline-buttons'),
+                        html::tag('button', array(
                                 'onclick' => "location.href='" . $RCMAIL->url(array_merge($_GET, array('_nocheck' => 1))) . "'"
                             ),
-                            $RCMAIL->gettext('showanyway'))
+                            $RCMAIL->gettext('showanyway')
                         )
-                    ))));
+                    )
+                )));
             }
 
             exit;
