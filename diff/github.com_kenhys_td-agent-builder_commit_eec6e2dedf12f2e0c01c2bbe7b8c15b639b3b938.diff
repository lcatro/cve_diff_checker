From eec6e2dedf12f2e0c01c2bbe7b8c15b639b3b938 Mon Sep 17 00:00:00 2001
From: Kentaro Hayashi <hayashi@clear-code.com>
Date: Fri, 18 Dec 2020 14:48:20 +0900
Subject: [PATCH] windows: mitigate possible escalation of privileges

Closes: #3201

Reported by @zubrahzz
---
 td-agent/msi/source.wxs | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/td-agent/msi/source.wxs b/td-agent/msi/source.wxs
index d08bbc24..03d25057 100644
--- a/td-agent/msi/source.wxs
+++ b/td-agent/msi/source.wxs
@@ -23,8 +23,13 @@
     <!-- We always do Major upgrades -->
     <MajorUpgrade DowngradeErrorMessage="!(loc.DowngradeErrorMessage)" />
 
+    <SetDirectory Id="OPTLOCATION" Value="opt" />
+
     <Directory Id="TARGETDIR" Name="SourceDir">
       <Directory Id="WINDOWSVOLUME">
+        <CreateFolder Directory="OPTLOCATION">
+          <Permission User="Administrator" Execute="yes" ChangePermission="yes"/>
+        </CreateFolder>
         <Directory Id="OPTLOCATION" Name="opt">
           <Directory Id="PROJECTLOCATION" Name="td-agent">
           </Directory>
