From 0c060153fb97c0288a1917efdb17cc426934dacb Mon Sep 17 00:00:00 2001
From: Robin Shen <robin@onedev.io>
Date: Fri, 20 Nov 2020 10:08:14 +0800
Subject: [PATCH] Fix the issue that uploaded file can be stored anywhere
 OneDev has write permissions over

---
 .../main/java/io/onedev/server/util/FilenameUtils.java   | 9 +++++++++
 .../server/web/component/markdown/InsertUrlPanel.java    | 4 +++-
 .../server/web/component/markdown/MarkdownEditor.java    | 4 +++-
 .../server/web/page/project/blob/ProjectBlobPage.java    | 3 ++-
 4 files changed, 17 insertions(+), 3 deletions(-)
 create mode 100644 server-core/src/main/java/io/onedev/server/util/FilenameUtils.java

diff --git a/server-core/src/main/java/io/onedev/server/util/FilenameUtils.java b/server-core/src/main/java/io/onedev/server/util/FilenameUtils.java
new file mode 100644
index 0000000000..91d10b7842
--- /dev/null
+++ b/server-core/src/main/java/io/onedev/server/util/FilenameUtils.java
@@ -0,0 +1,9 @@
+package io.onedev.server.util;
+
+public class FilenameUtils extends org.apache.commons.io.FilenameUtils {
+
+	public static String sanitizeFilename(String fileName) {
+		return fileName.replace("..", "_").replace('/', '_').replace('\\', '_');
+	}
+
+}
\ No newline at end of file
diff --git a/server-core/src/main/java/io/onedev/server/web/component/markdown/InsertUrlPanel.java b/server-core/src/main/java/io/onedev/server/web/component/markdown/InsertUrlPanel.java
index 9a972075e8..d55c180952 100644
--- a/server-core/src/main/java/io/onedev/server/web/component/markdown/InsertUrlPanel.java
+++ b/server-core/src/main/java/io/onedev/server/web/component/markdown/InsertUrlPanel.java
@@ -53,6 +53,7 @@
 import io.onedev.server.git.BlobIdentFilter;
 import io.onedev.server.git.exception.GitException;
 import io.onedev.server.model.Project;
+import io.onedev.server.util.FilenameUtils;
 import io.onedev.server.util.UrlUtils;
 import io.onedev.server.web.ajaxlistener.ConfirmClickListener;
 import io.onedev.server.web.behavior.ReferenceInputBehavior;
@@ -402,7 +403,8 @@ protected void onSubmit() {
 					String attachmentName;
 					FileUpload upload = uploads.iterator().next();
 					try (InputStream is = upload.getInputStream()) {
-						attachmentName = attachmentSupport.saveAttachment(upload.getClientFileName(), is);
+						attachmentName = attachmentSupport.saveAttachment(
+								FilenameUtils.sanitizeFilename(upload.getClientFileName()), is);
 					} catch (IOException e) {
 						throw new RuntimeException(e);
 					}
diff --git a/server-core/src/main/java/io/onedev/server/web/component/markdown/MarkdownEditor.java b/server-core/src/main/java/io/onedev/server/web/component/markdown/MarkdownEditor.java
index 371e157b25..024ee69e29 100644
--- a/server-core/src/main/java/io/onedev/server/web/component/markdown/MarkdownEditor.java
+++ b/server-core/src/main/java/io/onedev/server/web/component/markdown/MarkdownEditor.java
@@ -60,6 +60,7 @@
 import io.onedev.server.model.Project;
 import io.onedev.server.model.PullRequest;
 import io.onedev.server.model.User;
+import io.onedev.server.util.FilenameUtils;
 import io.onedev.server.util.markdown.MarkdownManager;
 import io.onedev.server.util.validation.ProjectNameValidator;
 import io.onedev.server.web.avatar.AvatarManager;
@@ -477,7 +478,8 @@ protected void respond(AjaxRequestTarget target) {
 				HttpServletRequest request = (HttpServletRequest) RequestCycle.get().getRequest().getContainerRequest();
 				HttpServletResponse response = (HttpServletResponse) RequestCycle.get().getResponse().getContainerResponse();
 				try {
-					String fileName = URLDecoder.decode(request.getHeader("File-Name"), StandardCharsets.UTF_8.name());
+					String fileName = FilenameUtils.sanitizeFilename(
+							URLDecoder.decode(request.getHeader("File-Name"), StandardCharsets.UTF_8.name()));
 					String attachmentName = getAttachmentSupport().saveAttachment(fileName, request.getInputStream());
 					response.getWriter().print(URLEncoder.encode(attachmentName, StandardCharsets.UTF_8.name()));
 					response.setStatus(HttpServletResponse.SC_OK);
diff --git a/server-core/src/main/java/io/onedev/server/web/page/project/blob/ProjectBlobPage.java b/server-core/src/main/java/io/onedev/server/web/page/project/blob/ProjectBlobPage.java
index e0bb4a4db3..bb085149f6 100644
--- a/server-core/src/main/java/io/onedev/server/web/page/project/blob/ProjectBlobPage.java
+++ b/server-core/src/main/java/io/onedev/server/web/page/project/blob/ProjectBlobPage.java
@@ -85,6 +85,7 @@
 import io.onedev.server.search.code.query.BlobQuery;
 import io.onedev.server.search.code.query.TextQuery;
 import io.onedev.server.security.SecurityUtils;
+import io.onedev.server.util.FilenameUtils;
 import io.onedev.server.util.script.identity.JobIdentity;
 import io.onedev.server.util.script.identity.ScriptIdentity;
 import io.onedev.server.util.script.identity.ScriptIdentityAware;
@@ -1413,7 +1414,7 @@ public RefUpdated uploadFiles(Collection<FileUpload> uploads, String directory,
 		BlobIdent blobIdent = getBlobIdent();
 		
 		for (FileUpload upload: uploads) {
-			String blobPath = upload.getClientFileName();
+			String blobPath = FilenameUtils.sanitizeFilename(upload.getClientFileName());
 			if (parentPath != null)
 				blobPath = parentPath + "/" + blobPath;
 			
