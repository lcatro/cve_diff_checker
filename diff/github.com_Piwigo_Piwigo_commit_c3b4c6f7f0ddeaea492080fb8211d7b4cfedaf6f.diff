From c3b4c6f7f0ddeaea492080fb8211d7b4cfedaf6f Mon Sep 17 00:00:00 2001
From: plegall <plg@piwigo.org>
Date: Mon, 18 Dec 2017 15:16:13 +0100
Subject: [PATCH] (cp 77f02bf) fixes #822, add token on configuration page to
 prevent CSRF

---
 admin/configuration.php                                   | 2 ++
 admin/themes/default/template/configuration_comments.tpl  | 1 +
 admin/themes/default/template/configuration_default.tpl   | 1 +
 admin/themes/default/template/configuration_display.tpl   | 1 +
 admin/themes/default/template/configuration_main.tpl      | 1 +
 admin/themes/default/template/configuration_sizes.tpl     | 1 +
 admin/themes/default/template/configuration_watermark.tpl | 1 +
 7 files changed, 8 insertions(+)

diff --git a/admin/configuration.php b/admin/configuration.php
index 2b76aef5d1..9e8cc52687 100644
--- a/admin/configuration.php
+++ b/admin/configuration.php
@@ -150,6 +150,7 @@
 //------------------------------ verification and registration of modifications
 if (isset($_POST['submit']))
 {
+  check_pwg_token();
   $int_pattern = '/^\d+$/';
 
   switch ($page['section'])
@@ -320,6 +321,7 @@
 $template->assign(
   array(
     'U_HELP' => get_root_url().'admin/popuphelp.php?page=configuration',
+    'PWG_TOKEN' => get_pwg_token(),
     'F_ACTION'=>$action
     ));
 
diff --git a/admin/themes/default/template/configuration_comments.tpl b/admin/themes/default/template/configuration_comments.tpl
index d8974d9c6f..f77c094b23 100644
--- a/admin/themes/default/template/configuration_comments.tpl
+++ b/admin/themes/default/template/configuration_comments.tpl
@@ -158,4 +158,5 @@
   </button>
 </p>
 
+<input type="hidden" name="pwg_token" value="{$PWG_TOKEN}">
 </form>
\ No newline at end of file
diff --git a/admin/themes/default/template/configuration_default.tpl b/admin/themes/default/template/configuration_default.tpl
index 789d897346..14e112d9e6 100644
--- a/admin/themes/default/template/configuration_default.tpl
+++ b/admin/themes/default/template/configuration_default.tpl
@@ -58,4 +58,5 @@
 
 </div>
 
+<input type="hidden" name="pwg_token" value="{$PWG_TOKEN}">
 </form>
\ No newline at end of file
diff --git a/admin/themes/default/template/configuration_display.tpl b/admin/themes/default/template/configuration_display.tpl
index fb47b22d98..a898f7714c 100644
--- a/admin/themes/default/template/configuration_display.tpl
+++ b/admin/themes/default/template/configuration_display.tpl
@@ -309,4 +309,5 @@
   </button>
 </p>
 
+<input type="hidden" name="pwg_token" value="{$PWG_TOKEN}">
 </form>
\ No newline at end of file
diff --git a/admin/themes/default/template/configuration_main.tpl b/admin/themes/default/template/configuration_main.tpl
index 6fab36036e..3a3fdf7bcb 100644
--- a/admin/themes/default/template/configuration_main.tpl
+++ b/admin/themes/default/template/configuration_main.tpl
@@ -215,4 +215,5 @@ jQuery("input[name='mail_theme']").change(function() {
   </button>
 </p>
 
+<input type="hidden" name="pwg_token" value="{$PWG_TOKEN}">
 </form>
\ No newline at end of file
diff --git a/admin/themes/default/template/configuration_sizes.tpl b/admin/themes/default/template/configuration_sizes.tpl
index a9c65ba231..93ff48c170 100644
--- a/admin/themes/default/template/configuration_sizes.tpl
+++ b/admin/themes/default/template/configuration_sizes.tpl
@@ -231,4 +231,5 @@
   </button>
 </p>
 
+<input type="hidden" name="pwg_token" value="{$PWG_TOKEN}">
 </form>
\ No newline at end of file
diff --git a/admin/themes/default/template/configuration_watermark.tpl b/admin/themes/default/template/configuration_watermark.tpl
index c76efec36e..39898f6cd2 100644
--- a/admin/themes/default/template/configuration_watermark.tpl
+++ b/admin/themes/default/template/configuration_watermark.tpl
@@ -137,4 +137,5 @@
   </button>
 </p>
 
+<input type="hidden" name="pwg_token" value="{$PWG_TOKEN}">
 </form>
\ No newline at end of file
