From f85bc674b2a2256a364fe796351bc1971e106005 Mon Sep 17 00:00:00 2001
From: pancake <pancake@nopcode.org>
Date: Wed, 7 Jun 2017 23:50:59 +0200
Subject: [PATCH] Fix #7698 - UAF in r_config_set when loading a dex

---
 libr/config/config.c | 3 ++-
 libr/core/cbin.c     | 9 ++++++---
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/libr/config/config.c b/libr/config/config.c
index 4eaa7b876c6..c2b3662b294 100644
--- a/libr/config/config.c
+++ b/libr/config/config.c
@@ -388,8 +388,9 @@ R_API RConfigNode* r_config_set(RConfig *cfg, const char *name, const char *valu
 				if (node->value == value) {
 					goto beach;
 				}
-				free (node->value);
+				char *tmp = node->value;
 				node->value = strdup (value);
+				free (tmp);
 				if (IS_DIGIT (*value)) {
 					if (strchr (value, '/')) {
 						node->i_value = r_num_get (cfg->num, value);
diff --git a/libr/core/cbin.c b/libr/core/cbin.c
index 65e088aee22..add791c1c7a 100644
--- a/libr/core/cbin.c
+++ b/libr/core/cbin.c
@@ -96,7 +96,8 @@ R_API int r_core_bin_set_env(RCore *r, RBinFile *binfile) {
 	RBinInfo *info = binobj ? binobj->info: NULL;
 	if (info) {
 		int va = info->has_va;
-		const char * arch = info->arch;
+		char * arch = strdup(info->arch);
+		char * cpu = info->cpu? strdup(info->cpu): NULL;
 		ut16 bits = info->bits;
 		ut64 baseaddr = r_bin_get_baddr (r->bin);
 		/* Hack to make baddr work on some corner */
@@ -106,14 +107,16 @@ R_API int r_core_bin_set_env(RCore *r, RBinFile *binfile) {
 		r_config_set (r->config, "asm.arch", arch);
 		r_config_set_i (r->config, "asm.bits", bits);
 		r_config_set (r->config, "anal.arch", arch);
-		if (info->cpu && *info->cpu) {
-			r_config_set (r->config, "anal.cpu", info->cpu);
+		if (cpu && *cpu) {
+			r_config_set (r->config, "anal.cpu", cpu);
 		} else {
 			r_config_set (r->config, "anal.cpu", arch);
 		}
 		r_asm_use (r->assembler, arch);
 		r_core_bin_info (r, R_CORE_BIN_ACC_ALL, R_CORE_BIN_SET, va, NULL, NULL);
 		r_core_bin_set_cur (r, binfile);
+		free (cpu);
+		free (arch);
 		return true;
 	}
 	return false;
