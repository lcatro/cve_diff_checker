From 626dc56686f15f2dda13c48f78c2a666cb6d8506 Mon Sep 17 00:00:00 2001
From: Gianfranco Costamagna <costamagnagianfranco@yahoo.it>
Date: Thu, 9 Feb 2017 16:01:30 +0100
Subject: [PATCH] Exit gracefully in case of corrupted filters (Closes issue
 #782)

---
 utils/etterfilter/ef_compiler.c | 4 +++-
 utils/etterfilter/ef_main.c     | 9 +++++++--
 utils/etterfilter/ef_output.c   | 3 +++
 3 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/utils/etterfilter/ef_compiler.c b/utils/etterfilter/ef_compiler.c
index 4ca676c2a..dc26043fc 100644
--- a/utils/etterfilter/ef_compiler.c
+++ b/utils/etterfilter/ef_compiler.c
@@ -239,7 +239,9 @@ size_t compile_tree(struct filter_op **fop)
    struct filter_op *array = NULL;
    struct unfold_elm *ue;
 
-   BUG_IF(tree_root == NULL);
+   // invalid file
+   if (tree_root == NULL)
+      return 0;
   
    fprintf(stdout, " Unfolding the meta-tree ");
    fflush(stdout);
diff --git a/utils/etterfilter/ef_main.c b/utils/etterfilter/ef_main.c
index f17b83b21..2a2f0007c 100644
--- a/utils/etterfilter/ef_main.c
+++ b/utils/etterfilter/ef_main.c
@@ -41,6 +41,7 @@ struct ef_globals *ef_gbls;
 
 int main(int argc, char *argv[])
 {
+   int ret_value = 0;
    libettercap_init();
    ef_globals_alloc();
    select_text_interface();
@@ -88,8 +89,12 @@ int main(int argc, char *argv[])
       fprintf(stdout, "\n\nThe script contains errors...\n\n");
   
    /* write to file */
-   if (write_output() != E_SUCCESS)
-      FATAL_ERROR("Cannot write output file (%s)", EF_GBL_OPTIONS->output_file);
+   ret_value = write_output();
+   if (ret_value == -E_NOTHANDLED)
+      FATAL_ERROR("Cannot write output file (%s): the filter is not correctly handled.", EF_GBL_OPTIONS->output_file);
+   else if (ret_value == -E_INVALID)
+      FATAL_ERROR("Cannot write output file (%s): the filter format is not correct. ", EF_GBL_OPTIONS->output_file);
+
    ef_globals_free();
    return 0;
 }
diff --git a/utils/etterfilter/ef_output.c b/utils/etterfilter/ef_output.c
index 57e6b00a8..08c32fcb3 100644
--- a/utils/etterfilter/ef_output.c
+++ b/utils/etterfilter/ef_output.c
@@ -51,6 +51,9 @@ int write_output(void)
    if (fop == NULL)
       return -E_NOTHANDLED;
 
+   if (ninst == 0)
+      return -E_INVALID;
+
    /* create the file */
    fd = open(EF_GBL_OPTIONS->output_file, O_CREAT | O_RDWR | O_TRUNC | O_BINARY, 0644);
    ON_ERROR(fd, -1, "Can't create file %s", EF_GBL_OPTIONS->output_file);
