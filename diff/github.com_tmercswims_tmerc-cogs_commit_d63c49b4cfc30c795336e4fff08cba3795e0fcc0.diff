From d63c49b4cfc30c795336e4fff08cba3795e0fcc0 Mon Sep 17 00:00:00 2001
From: Thomas Mercurio <tmercswims@gmail.com>
Date: Tue, 10 Aug 2021 20:28:01 -0700
Subject: [PATCH] fix(Welcome): only allow use of safe model attributes

---
 welcome/safemodels.py | 52 +++++++++++++++++++++++++++++++++++++++++++
 welcome/welcome.py    | 10 ++++++++-
 2 files changed, 61 insertions(+), 1 deletion(-)
 create mode 100644 welcome/safemodels.py

diff --git a/welcome/safemodels.py b/welcome/safemodels.py
new file mode 100644
index 0000000..01b310a
--- /dev/null
+++ b/welcome/safemodels.py
@@ -0,0 +1,52 @@
+import discord
+
+
+class SafeMember:
+    def __init__(self, member: discord.Member) -> None:
+        self.name = str(member.name)
+        self.display_name = str(member.display_name)
+        self.nick = str(member.nick)
+        self.id = str(member.id)
+        self.mention = str(member.mention)
+        self.discriminator = str(member.discriminator)
+        self.color = str(member.color)
+        self.colour = str(member.colour)
+        self.created_at = str(member.created_at)
+        self.joined_at = str(member.joined_at)
+
+    def __str__(self):
+        return self.name
+
+    def __getattr__(self, name):
+        return self
+
+
+class SafeRole:
+    def __init__(self, role: discord.Role) -> None:
+        self.name = str(role.name)
+        self.id = str(role.id)
+        self.mention = str(role.mention)
+        self.color = str(role.color)
+        self.colour = str(role.colour)
+        self.position = str(role.position)
+        self.created_at = str(role.created_at)
+
+    def __str__(self):
+        return self.name
+
+    def __getattr__(self, name):
+        return self
+
+
+class SafeGuild:
+    def __init__(self, guild: discord.Guild) -> None:
+        self.name = str(guild.name)
+        self.id = str(guild.id)
+        self.description = str(guild.description)
+        self.created_at = str(guild.created_at)
+
+    def __str__(self):
+        return self.name
+
+    def __getattr__(self, name):
+        return self
diff --git a/welcome/welcome.py b/welcome/welcome.py
index 0c9057a..3e487e8 100644
--- a/welcome/welcome.py
+++ b/welcome/welcome.py
@@ -10,6 +10,7 @@
 
 from .enums import WhisperType
 from .errors import WhisperError
+from .safemodels import SafeGuild, SafeMember
 
 __author__ = "tmerc"
 
@@ -791,7 +792,14 @@ async def __send_notice(
 
         try:
             return await channel.send(
-                format_str.format(member=user, server=guild, bot=user, count=count or "", plural=plural, roles=role_str)
+                format_str.format(
+                    member=SafeMember(user),
+                    server=SafeGuild(guild),
+                    bot=SafeMember(user),
+                    count=count or "",
+                    plural=plural,
+                    roles=role_str,
+                )
             )
         except discord.Forbidden:
             log.error(
