From c1c4bb0cf9e076aafaf4ff3515556ef9faf906f3 Mon Sep 17 00:00:00 2001
From: jjergus <jjergus@fb.com>
Date: Mon, 29 Jun 2020 11:37:47 -0700
Subject: [PATCH] CVE-2020-1900

Pre-reserve object dynamic properties when unserializing
---
 hphp/runtime/base/object-data.cpp           | 5 +++++
 hphp/runtime/base/variable-unserializer.cpp | 1 +
 2 files changed, 6 insertions(+)

diff --git a/hphp/runtime/base/object-data.cpp b/hphp/runtime/base/object-data.cpp
index 34a1b8174cac..77ae2ad19d90 100644
--- a/hphp/runtime/base/object-data.cpp
+++ b/hphp/runtime/base/object-data.cpp
@@ -342,6 +342,11 @@ Array& ObjectData::reserveProperties(int numDynamic /* = 2 */) {
     return dynPropArray();
   }
 
+  auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);
+  if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {
+    check_non_safepoint_surprise();
+  }
+
   return setDynPropArray(
       Array::attach(MixedArray::MakeReserveMixed(numDynamic))
   );
diff --git a/hphp/runtime/base/variable-unserializer.cpp b/hphp/runtime/base/variable-unserializer.cpp
index c03843bc9fed..4789857137be 100644
--- a/hphp/runtime/base/variable-unserializer.cpp
+++ b/hphp/runtime/base/variable-unserializer.cpp
@@ -552,6 +552,7 @@ void VariableUnserializer::unserializeProp(ObjectData* obj,
     // Unserialize as a dynamic property. If this is the first, we need to
     // pre-allocate space in the array to ensure the elements don't move during
     // unserialization.
+    obj->reserveDynProps(nProp);
     t = obj->makeDynProp(realKey.get());
   } else {
     // We'll check if this doesn't violate the type-hint once we're done
