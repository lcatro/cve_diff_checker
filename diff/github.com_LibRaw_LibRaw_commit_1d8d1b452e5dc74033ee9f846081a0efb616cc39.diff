From 1d8d1b452e5dc74033ee9f846081a0efb616cc39 Mon Sep 17 00:00:00 2001
From: Alex Tutubalin <lexa@lexa.ru>
Date: Mon, 11 Jun 2018 13:05:32 +0300
Subject: [PATCH] reject broken/crafted NOKIARAW files

---
 dcraw/dcraw.c             | 5 ++++-
 internal/dcraw_common.cpp | 5 ++++-
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/dcraw/dcraw.c b/dcraw/dcraw.c
index 364869cf..c22f98a9 100644
--- a/dcraw/dcraw.c
+++ b/dcraw/dcraw.c
@@ -15738,7 +15738,10 @@ void CLASS identify()
 #endif
 	switch (tiff_bps = i*8 / (width * height)) {
 	case  8: load_raw = &CLASS eight_bit_load_raw;  break;
-	case 10: load_raw = &CLASS nokia_load_raw;
+	case 10: load_raw = &CLASS nokia_load_raw; break;
+#ifdef LIBRAW_LIBRARY_BUILD
+        case 0:  throw LIBRAW_EXCEPTION_IO_CORRUPT; break;
+#endif
 	}
 	raw_height = height + (top_margin = i / (width * tiff_bps/8) - height);
 	mask[0][3] = 1;
diff --git a/internal/dcraw_common.cpp b/internal/dcraw_common.cpp
index 041318c5..7cb6c15c 100644
--- a/internal/dcraw_common.cpp
+++ b/internal/dcraw_common.cpp
@@ -14399,7 +14399,10 @@ void CLASS identify()
 #endif
 	switch (tiff_bps = i*8 / (width * height)) {
 	case  8: load_raw = &CLASS eight_bit_load_raw;  break;
-	case 10: load_raw = &CLASS nokia_load_raw;
+	case 10: load_raw = &CLASS nokia_load_raw; break;
+#ifdef LIBRAW_LIBRARY_BUILD
+        case 0:  throw LIBRAW_EXCEPTION_IO_CORRUPT; break;
+#endif
 	}
 	raw_height = height + (top_margin = i / (width * tiff_bps/8) - height);
 	mask[0][3] = 1;
