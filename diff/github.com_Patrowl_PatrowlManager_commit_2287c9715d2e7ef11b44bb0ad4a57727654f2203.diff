From 2287c9715d2e7ef11b44bb0ad4a57727654f2203 Mon Sep 17 00:00:00 2001
From: MaKyOtOx <nicolas.mattiocco@patrowl.io>
Date: Tue, 14 Dec 2021 11:25:29 +0100
Subject: [PATCH] Fix Unrestricted Upload of File with Dangerous Type (from
 Huntr bug bounty report)

---
 app/urls.py       |  2 +-
 findings/forms.py | 19 ++++++++++++++++---
 2 files changed, 17 insertions(+), 4 deletions(-)

diff --git a/app/urls.py b/app/urls.py
index 2c7649c..1c3d068 100644
--- a/app/urls.py
+++ b/app/urls.py
@@ -28,7 +28,7 @@ def i18n_javascript(request):
 handler500 = 'app.views.custom_error'
 
 
-api_schema_view = get_swagger_view(title='PatrOwl Manager REST-API')
+api_schema_view = get_swagger_view(title='PatrowlManager REST-API')
 
 urlpatterns = [
     url(r'^apis-doc', api_schema_view),
diff --git a/findings/forms.py b/findings/forms.py
index 21f2d6f..315e2a0 100644
--- a/findings/forms.py
+++ b/findings/forms.py
@@ -1,5 +1,6 @@
 # -*- coding: utf-8 -*-
 
+import os
 from django import forms
 from .models import Finding, FINDING_SEVERITIES
 
@@ -9,6 +10,13 @@
 )
 
 
+def validate_file_extension(value):
+    ext = os.path.splitext(value.name)[1]
+    valid_extensions = ['.xml', '.nessus', '.json']
+    if ext not in valid_extensions:
+        raise ValidationError(u'File not supported!')
+
+
 class ImportFindingsForm(forms.Form):
     class Meta:
         fields = ['engine', 'min_level', 'file']
@@ -20,14 +28,19 @@ class Meta:
         attrs={'class': 'form-control form-control-sm'},
         choices=FINDING_SEVERITIES),
         label='Minimum severity')
-    file = forms.FileField()
+    file = forms.FileField(widget=forms.FileInput(
+        attrs={'accept': 'text/xml,application/json'}),
+        validators=[validate_file_extension]
+    )
 
 
 class FindingForm(forms.ModelForm):
     class Meta:
         model = Finding
-        fields = ['title', 'type', 'severity', 'status', 'description', 'tags',
-            'solution', 'risk_info', 'vuln_refs', 'links', 'comments', 'asset']
+        fields = [
+            'title', 'type', 'severity', 'status', 'description', 'tags',
+            'solution', 'risk_info', 'vuln_refs', 'links', 'comments', 'asset'
+        ]
         widgets = {
             'description': forms.Textarea(
                 attrs={'class': 'form-control form-control-sm'}),
