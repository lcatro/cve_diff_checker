From 6192491ab2631e7c1d317c221f18ea613e2c18a5 Mon Sep 17 00:00:00 2001
From: Peter Sirka <petersirka@gmail.com>
Date: Fri, 27 Nov 2020 17:36:16 +0100
Subject: [PATCH] Fixed "Command Injection" in `image.stream()` - thank to Sam
 Sanoop.

---
 image.js | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/image.js b/image.js
index 19631b27..b01a9998 100755
--- a/image.js
+++ b/image.js
@@ -38,6 +38,7 @@ const SPAWN_OPT = { shell: true };
 const D = require('os').platform().substring(0, 3).toLowerCase() === 'win' ? '"' : '\'';
 const CMD_CONVERT = { gm: 'gm', im: 'convert', magick: 'magick' };
 const CMD_CONVERT2 = { gm: 'gm convert', im: 'convert', magick: 'magick' };
+const SUPPORTEDIMAGES = { jpg: 1, png: 1, gif: 1, apng: 1, jpeg: 1, heif: 1, heic: 1, webp: 1, ico: 1 };
 
 var CACHE = {};
 var middlewares = {};
@@ -322,7 +323,7 @@ ImageProto.stream = function(type, writer) {
 
 	!self.builder.length && self.minify();
 
-	if (!type)
+	if (!type || !SUPPORTEDIMAGES[type])
 		type = self.outputType;
 
 	F.stats.performance.open++;
