From 80c404c4b79f3bcba3fc4585d4c62a62a04f3ed9 Mon Sep 17 00:00:00 2001
From: George Kadianakis <desnacked@riseup.net>
Date: Wed, 5 May 2021 10:50:29 +0300
Subject: [PATCH] Log warning when connecting to soon-to-be-deprecated v2
 onions.

---
 changes/ticket40373           |  3 +++
 src/core/or/connection_edge.c | 10 ++++++++++
 2 files changed, 13 insertions(+)
 create mode 100644 changes/ticket40373

diff --git a/changes/ticket40373 b/changes/ticket40373
new file mode 100644
index 0000000000..e2ea297bc2
--- /dev/null
+++ b/changes/ticket40373
@@ -0,0 +1,3 @@
+  o Minor features (onion services):
+    - Add warning message when connecting to soon-to-be-deprecated v2 onions.
+      Closes ticket 40373.
diff --git a/src/core/or/connection_edge.c b/src/core/or/connection_edge.c
index a33c64fe19..7f260ba185 100644
--- a/src/core/or/connection_edge.c
+++ b/src/core/or/connection_edge.c
@@ -2582,6 +2582,16 @@ connection_ap_handshake_rewrite_and_attach(entry_connection_t *conn,
     tor_assert(addresstype == ONION_V2_HOSTNAME ||
                addresstype == ONION_V3_HOSTNAME);
     tor_assert(!automap);
+
+    if (addresstype == ONION_V2_HOSTNAME) {
+      log_warn(LD_PROTOCOL,
+               "Warning! You've just connected to a v2 onion address. These "
+               "addresses are deprecated for security reasons, and are no "
+               "longer supported in Tor. Please encourage the site operator "
+               "to upgrade. For more information see "
+               "https://blog.torproject.org/v2-deprecation-timeline");
+    }
+
     return connection_ap_handle_onion(conn, socks, circ, addresstype);
   }
 
-- 
GitLab

