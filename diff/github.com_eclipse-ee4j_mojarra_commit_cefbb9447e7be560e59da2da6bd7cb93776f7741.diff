From cefbb9447e7be560e59da2da6bd7cb93776f7741 Mon Sep 17 00:00:00 2001
From: ruolli <ruolin.li@oracle.com>
Date: Thu, 5 Sep 2019 16:12:40 +0800
Subject: [PATCH] Multiple Path Traversal security issues

---
 .../faces/application/resource/ClasspathResourceHelper.java   | 2 +-
 .../com/sun/faces/application/resource/ResourceManager.java   | 4 +++-
 .../sun/faces/application/resource/WebappResourceHelper.java  | 2 +-
 3 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/impl/src/main/java/com/sun/faces/application/resource/ClasspathResourceHelper.java b/impl/src/main/java/com/sun/faces/application/resource/ClasspathResourceHelper.java
index 9a81ee1a7b..c745b93441 100644
--- a/impl/src/main/java/com/sun/faces/application/resource/ClasspathResourceHelper.java
+++ b/impl/src/main/java/com/sun/faces/application/resource/ClasspathResourceHelper.java
@@ -355,7 +355,7 @@ private URL findPathConsideringContracts(ClassLoader loader,
         } else if (root == null) {
             String contractName = ctx.getExternalContext().getRequestParameterMap()
                   .get("con");
-            if (null != contractName && 0 < contractName.length()) {
+            if (null != contractName && 0 < contractName.length() && !ResourceManager.nameContainsForbiddenSequence(contractName)) {
                 contracts = new ArrayList<>();
                 contracts.add(contractName);
             } else {
diff --git a/impl/src/main/java/com/sun/faces/application/resource/ResourceManager.java b/impl/src/main/java/com/sun/faces/application/resource/ResourceManager.java
index 53e0d6455a..a8344fb391 100644
--- a/impl/src/main/java/com/sun/faces/application/resource/ResourceManager.java
+++ b/impl/src/main/java/com/sun/faces/application/resource/ResourceManager.java
@@ -351,7 +351,7 @@ private String trimLeadingSlash(String s) {
         }
     }
     
-    private static boolean nameContainsForbiddenSequence(String name) {
+    static boolean nameContainsForbiddenSequence(String name) {
         boolean result = false;
         if (name != null) {
             name = name.toLowerCase();
@@ -567,6 +567,8 @@ private String getLocalePrefix(FacesContext context) {
         
         if(localePrefix != null && !nameContainsForbiddenSequence(localePrefix)){
             return localePrefix;
+        } else {
+            localePrefix = null; 
         }
         
         String appBundleName = context.getApplication().getMessageBundle();
diff --git a/impl/src/main/java/com/sun/faces/application/resource/WebappResourceHelper.java b/impl/src/main/java/com/sun/faces/application/resource/WebappResourceHelper.java
index 1c85807920..2b3e89f7e3 100644
--- a/impl/src/main/java/com/sun/faces/application/resource/WebappResourceHelper.java
+++ b/impl/src/main/java/com/sun/faces/application/resource/WebappResourceHelper.java
@@ -315,7 +315,7 @@ private String findPathConsideringContracts(LibraryInfo library,
         } else if (root == null) {
             String contractName = ctx.getExternalContext().getRequestParameterMap()
                   .get("con");
-            if (null != contractName && 0 < contractName.length()) {
+            if (null != contractName && 0 < contractName.length() && !ResourceManager.nameContainsForbiddenSequence(contractName)) {
                 contracts = new ArrayList<>();
                 contracts.add(contractName);
             } else {
