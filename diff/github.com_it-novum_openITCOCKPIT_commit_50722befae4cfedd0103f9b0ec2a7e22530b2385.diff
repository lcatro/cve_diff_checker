From 50722befae4cfedd0103f9b0ec2a7e22530b2385 Mon Sep 17 00:00:00 2001
From: nook24 <info@nook24.eu>
Date: Wed, 26 Feb 2020 11:57:02 +0100
Subject: [PATCH] Backport to V3: Add user permission to control access for
 testGrafanaConnection method

---
 app/Plugin/GrafanaModule/Config/acl_dependencies.php |  2 +-
 .../View/GrafanaConfiguration/index.ctp              | 12 +++++++-----
 2 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/app/Plugin/GrafanaModule/Config/acl_dependencies.php b/app/Plugin/GrafanaModule/Config/acl_dependencies.php
index 8ee152db57..0675504741 100644
--- a/app/Plugin/GrafanaModule/Config/acl_dependencies.php
+++ b/app/Plugin/GrafanaModule/Config/acl_dependencies.php
@@ -40,7 +40,7 @@
         ],
         'dependencies'   => [
             'GrafanaConfiguration'  => [
-                'index' => ['testGrafanaConnection', 'loadHostgroups'],
+                'index' => ['loadHostgroups'],
             ],
             'GrafanaUserdashboards' => [
                 'add'    => ['loadContainers'],
diff --git a/app/Plugin/GrafanaModule/View/GrafanaConfiguration/index.ctp b/app/Plugin/GrafanaModule/View/GrafanaConfiguration/index.ctp
index 88cb156187..6b42334552 100644
--- a/app/Plugin/GrafanaModule/View/GrafanaConfiguration/index.ctp
+++ b/app/Plugin/GrafanaModule/View/GrafanaConfiguration/index.ctp
@@ -188,11 +188,13 @@
                     <div class="col-xs-12 margin-top-10">
                         <div class="well formactions ">
                             <div class="pull-right">
-                                <button type="button"
-                                        class="btn text-center btn-primary"
-                                        ng-click="checkGrafanaConnection()">
-                                    <?php echo __('Check Grafana Connection'); ?>
-                                </button>
+                                <?php if ($this->Acl->hasPermission('testGrafanaConnection', 'GrafanaConfiguration', 'GrafanaModule')): ?>
+                                    <button type="button"
+                                            class="btn text-center btn-primary"
+                                            ng-click="checkGrafanaConnection()">
+                                        <?php echo __('Check Grafana Connection'); ?>
+                                    </button>
+                                <?php endif; ?>
                                 <input class="btn btn-primary" type="submit" value="Save">&nbsp;
                             </div>
                         </div>
