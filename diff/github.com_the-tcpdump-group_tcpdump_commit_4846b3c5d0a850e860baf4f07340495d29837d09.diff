From 4846b3c5d0a850e860baf4f07340495d29837d09 Mon Sep 17 00:00:00 2001
From: Denis Ovsienko <denis@ovsienko.info>
Date: Wed, 29 Aug 2018 00:38:40 +0100
Subject: [PATCH] (for 4.9.3) CVE-2018-16227/IEEE 802.11: add a missing bounds
 check

ieee802_11_print() tried to access the Mesh Flags subfield of the Mesh
Control field to find the size of the latter and increment the expected
802.11 header length before checking it is fully present in the input
buffer. Add an intermediate bounds check to make it safe.

This fixes a buffer over-read discovered by Ryan Ackroyd.

Add a test using the capture file supplied by the reporter(s).
---
 print-802_11.c                     |   4 ++++
 tests/TESTLIST                     |   3 +++
 tests/ieee802.11_meshhdr-oobr.out  |   1 +
 tests/ieee802.11_meshhdr-oobr.pcap | Bin 0 -> 867 bytes
 4 files changed, 8 insertions(+)
 create mode 100644 tests/ieee802.11_meshhdr-oobr.out
 create mode 100644 tests/ieee802.11_meshhdr-oobr.pcap

diff --git a/print-802_11.c b/print-802_11.c
index 7c65941ae..50a3e9f59 100644
--- a/print-802_11.c
+++ b/print-802_11.c
@@ -2058,6 +2058,10 @@ ieee802_11_print(netdissect_options *ndo,
 		hdrlen = roundup2(hdrlen, 4);
 	if (ndo->ndo_Hflag && FC_TYPE(fc) == T_DATA &&
 	    DATA_FRAME_IS_QOS(FC_SUBTYPE(fc))) {
+		if (caplen < hdrlen + 1) {
+			ND_PRINT((ndo, "%s", tstr));
+			return hdrlen;
+		}
 		meshdrlen = extract_mesh_header_length(p+hdrlen);
 		hdrlen += meshdrlen;
 	} else
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 9c0ac4b7e..0645739cb 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -602,6 +602,9 @@ ospf6_print_lshdr-oobr	ospf6_print_lshdr-oobr.pcapng	ospf6_print_lshdr-oobr.out
 rpl-dao-oobr		rpl-dao-oobr.pcapng		rpl-dao-oobr.out		-vv -c1
 hncp_prefix-oobr	hncp_prefix-oobr.pcapng		hncp_prefix-oobr.out		-vvv
 
+# bad packets from Ryan Ackroyd
+ieee802.11_meshhdr-oobr	ieee802.11_meshhdr-oobr.pcap	ieee802.11_meshhdr-oobr.out	-H -c1
+
 # RTP tests
 # fuzzed pcap
 rtp-seg-fault-1  rtp-seg-fault-1.pcap  rtp-seg-fault-1.out  -v -T rtp
diff --git a/tests/ieee802.11_meshhdr-oobr.out b/tests/ieee802.11_meshhdr-oobr.out
new file mode 100644
index 000000000..6b3ab3fb1
--- /dev/null
+++ b/tests/ieee802.11_meshhdr-oobr.out
@@ -0,0 +1 @@
+3472328296059908144us tsft 24.0 Mb/s 12334 MHz Turbo 48dBm noise [|802.11][|802.11]
diff --git a/tests/ieee802.11_meshhdr-oobr.pcap b/tests/ieee802.11_meshhdr-oobr.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..48445d7dcf1135bc5946368542a56acac2a33b81
GIT binary patch
literal 867
zcmcgrJBk895G_PgjYL^CF;PsGasv|+gE13DgaI>IyhrOPHl8c=6}*C&dVoDdZ+&{o
zZWPR%psQZ}x~g8!<?O2lGy&uH0RRpR_DaH~`1-J(i89pCFA;wV+A0tSwSr@-bQGIb
zBIBGY^(+j1_8ll7Gb8}!*x|gBB=7kA7L||ZzKQxjEld;#=ijPvTV?ZTh}I_EmLkjO
zqI0$s+*6a~h7)KM&C5<FXqno)XO!(Abz?HwHg`NA>fTqnmR1NYDU3gtl*rgKr3SY^
zT-7ylI@KEKRAA%Bj60om36jN??+Q0th)^9EKA}2EB=t_<t1<Jux1;po^X0l3dq`7l
Rs9FCiBgI9eK@k=#{{i$b#I*nb

literal 0
HcmV?d00001

