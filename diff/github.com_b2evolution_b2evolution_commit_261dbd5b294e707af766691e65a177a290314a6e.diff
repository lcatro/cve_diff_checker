From 261dbd5b294e707af766691e65a177a290314a6e Mon Sep 17 00:00:00 2001
From: "Erwin Rommel H. Satingin" <winskie@gmail.com>
Date: Sun, 15 Jan 2017 15:17:52 +0800
Subject: [PATCH] Updated file types table to only allow admins to upload files
 with SWF extension

---
 conf/_application.php             | 2 +-
 install/_functions_create.php     | 2 +-
 install/_functions_evoupgrade.php | 8 ++++++++
 3 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/conf/_application.php b/conf/_application.php
index 9e34c30c12..fc5f12fe77 100644
--- a/conf/_application.php
+++ b/conf/_application.php
@@ -36,7 +36,7 @@
  *
  * {@internal Before changing this in CVS, it should be discussed! }}
  */
-$new_db_version = 11810;
+$new_db_version = 11815;
 
 /**
  * Minimum PHP version required for b2evolution to function properly. It will contain each module own minimum PHP version as well.
diff --git a/install/_functions_create.php b/install/_functions_create.php
index 0e5b45ecbf..93038ac894 100644
--- a/install/_functions_create.php
+++ b/install/_functions_create.php
@@ -448,7 +448,7 @@ function create_default_data()
 			(17, 'mov', 'Quicktime video', 'video/quicktime', 'file_video', 'browser', 'registered'),
 			(18, 'm4v', 'MPEG video file', 'video/x-m4v', 'file_video', 'browser', 'registered'),
 			(19, 'flv', 'Flash video file', 'video/x-flv', 'file_video', 'browser', 'registered'),
-			(20, 'swf', 'Flash video file', 'application/x-shockwave-flash', 'file_video', 'browser', 'registered'),
+			(20, 'swf', 'Flash video file', 'application/x-shockwave-flash', 'file_video', 'browser', 'admin'),
 			(21, 'webm', 'WebM video file', 'video/webm', 'file_video', 'browser', 'registered'),
 			(22, 'ogv', 'Ogg video file', 'video/ogg', 'file_video', 'browser', 'registered'),
 			(23, 'm3u8', 'M3U8 video file', 'application/x-mpegurl', 'file_video', 'browser', 'registered'),
diff --git a/install/_functions_evoupgrade.php b/install/_functions_evoupgrade.php
index 3435fca6d4..18c0520198 100644
--- a/install/_functions_evoupgrade.php
+++ b/install/_functions_evoupgrade.php
@@ -7592,6 +7592,14 @@ function add_basic_widget_11670( $blog_ID, $container_name, $code, $type, $order
 		upg_task_end();
 	}
 
+	if( upg_task_start( 11815, 'Updating file types table...' ) )
+	{ // part of 6.7.10-stable
+		$DB->query( 'UPDATE T_filetypes
+				SET ftyp_allowed = "admin"
+			WHERE ftyp_extensions REGEXP "[[:<:]]swf[[:>:]]"' );
+		upg_task_end();
+	}
+
 	/*
 	 * ADD UPGRADES __ABOVE__ IN A NEW UPGRADE BLOCK.
 	 *
