From ca90b34c4a9333438cc4d69faeb43362bb991e5a Mon Sep 17 00:00:00 2001
From: Matt Travi <programmer@travi.org>
Date: Sat, 7 Nov 2020 00:19:32 -0600
Subject: [PATCH] fix: mask secrets when characters get uri encoded

---
 lib/hide-sensitive.js       | 7 ++++++-
 test/hide-sensitive.test.js | 8 ++++++++
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/lib/hide-sensitive.js b/lib/hide-sensitive.js
index 60984962c..d612068b2 100644
--- a/lib/hide-sensitive.js
+++ b/lib/hide-sensitive.js
@@ -11,7 +11,12 @@ module.exports = (env) => {
     return /token|password|credential|secret|private/i.test(envVar) && size(env[envVar].trim()) >= SECRET_MIN_SIZE;
   });
 
-  const regexp = new RegExp(toReplace.map((envVar) => escapeRegExp(env[envVar])).join('|'), 'g');
+  const regexp = new RegExp(
+    toReplace
+      .map((envVar) => `${escapeRegExp(env[envVar])}|${encodeURI(escapeRegExp(env[envVar]))}`)
+      .join('|'),
+    'g'
+  );
   return (output) =>
     output && isString(output) && toReplace.length > 0 ? output.toString().replace(regexp, SECRET_REPLACEMENT) : output;
 };
diff --git a/test/hide-sensitive.test.js b/test/hide-sensitive.test.js
index 2b319c436..4987d3163 100644
--- a/test/hide-sensitive.test.js
+++ b/test/hide-sensitive.test.js
@@ -24,6 +24,14 @@ test('Replace sensitive environment variable matching specific regex for "privat
   t.is(hideSensitive(env)(`https://host.com?token=${env.privateKey}`), `https://host.com?token=${SECRET_REPLACEMENT}`);
 });
 
+test('Replace url-encoded environment variable', (t) => {
+  const env = {privateKey: 'secret '};
+  t.is(
+    hideSensitive(env)(`https://host.com?token=${encodeURI(env.privateKey)}`),
+    `https://host.com?token=${SECRET_REPLACEMENT}`
+  );
+});
+
 test('Escape regexp special characters', (t) => {
   const env = {SOME_CREDENTIALS: 'p$^{.+}\\w[a-z]o.*rd'};
   t.is(
