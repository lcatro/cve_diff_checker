From c418e3345313dc896c1951d8c46ab0b9b12fcbd3 Mon Sep 17 00:00:00 2001
From: Martin Connell <martinc@topology.com>
Date: Wed, 14 Aug 2019 10:51:41 +0100
Subject: [PATCH] FIX - NullReferenceException caused by bad langtag #387

---
 src/i18n/Concrete/TextLocalizer.cs | 3 +++
 src/i18n/LocalizedApplication.cs   | 6 ++++--
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/src/i18n/Concrete/TextLocalizer.cs b/src/i18n/Concrete/TextLocalizer.cs
index 16b09e5..ca54577 100644
--- a/src/i18n/Concrete/TextLocalizer.cs
+++ b/src/i18n/Concrete/TextLocalizer.cs
@@ -126,6 +126,9 @@ private bool IsLanguageValid(string langtag)
         {
         // Note that there is no need to serialize access to System.Web.HttpRuntime.Cache when just reading from it.
         //
+            if (!langtag.IsSet()) {
+                return false; }
+
             // Default language is always valid.
             if (LocalizedApplication.Current.MessageKeyIsValueInDefaultLanguage
                 && LocalizedApplication.Current.DefaultLanguageTag.Equals(langtag)) {
diff --git a/src/i18n/LocalizedApplication.cs b/src/i18n/LocalizedApplication.cs
index f0034f3..d537807 100644
--- a/src/i18n/LocalizedApplication.cs
+++ b/src/i18n/LocalizedApplication.cs
@@ -118,10 +118,12 @@ public string DefaultLanguage
             }
             set
             {
-                DefaultLanguageTag = LanguageTag.GetCachedInstance(value);
+                LanguageTag defaultLanguageTag = LanguageTag.GetCachedInstance(value);
+                if (defaultLanguageTag != null) {
+                    DefaultLanguageTag = defaultLanguageTag; }
             }
         }
-        public LanguageTag DefaultLanguageTag { get; set; }
+        public LanguageTag DefaultLanguageTag { get; private set; }
 
         /// <summary>
         /// Specifies whether the key for a message may be assumed to be the value for
