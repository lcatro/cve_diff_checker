From d99bd8277d384f3417e917ce20bef5d061110343 Mon Sep 17 00:00:00 2001
From: Francisco Mancardi <francisco.mancardi@gmail.com>
Date: Wed, 5 Feb 2020 12:41:23 +0100
Subject: [PATCH] refactoring for security (www.ackcent.com)

---
 lib/functions/tree.class.php | 28 ++++++++++++++++++----------
 1 file changed, 18 insertions(+), 10 deletions(-)

diff --git a/lib/functions/tree.class.php b/lib/functions/tree.class.php
index f53a22fd16..7458bc8b68 100644
--- a/lib/functions/tree.class.php
+++ b/lib/functions/tree.class.php
@@ -537,18 +537,26 @@ function: change_parent
   */
   function change_parent($node_id, $parent_id) 
   {
-    $debugMsg='Class:' .__CLASS__ . ' - Method:' . __FUNCTION__ . ' :: ';
-    if( is_array($node_id) )
-    {
-      $id_list = implode(",",$node_id);
+    $debugMsg = 'Class:' .__CLASS__ . ' - Method:' 
+                         . __FUNCTION__ . ' :: ';
+
+    if (is_array($node_id)) {
+      $safeSet = array_map('intval',$node_id);
+      $id_list = implode(",",$safeSet);
       $where_clause = " WHERE id IN ($id_list) ";
+    } else {    
+      $safe = intval($node_id);
+      if ($safe <= 0) {
+        throw new Exception("BAD node_id", 1);
+      }
+      $where_clause=" WHERE id = $safe";
     }
-    else
-    {
-      $where_clause=" WHERE id = {$node_id}";
-    }
-    $sql = "/* $debugMsg */ UPDATE {$this->object_table} " .
-           " SET parent_id = " . $this->db->prepare_int($parent_id) . " {$where_clause}";
+
+    $safeP = $this->db->prepare_int($parent_id);
+    $sql = "/* $debugMsg */ 
+            UPDATE {$this->object_table}
+            SET parent_id = $safeP 
+            $where_clause ";
     
     $result = $this->db->exec_query($sql);
     
