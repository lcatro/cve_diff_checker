From a3c694de9f7e844b76f9d1b61296ebf6e8d89d74 Mon Sep 17 00:00:00 2001
From: Frank de Jonge <info@frankdejonge.nl>
Date: Thu, 24 Jun 2021 00:07:10 +0200
Subject: [PATCH] Reject funky whitspace paths.

---
 src/CorruptedPathDetected.php        | 13 +++++++++++++
 src/WhitespacePathNormalizer.php     | 13 ++++---------
 src/WhitespacePathNormalizerTest.php | 16 +++++++++++++++-
 3 files changed, 32 insertions(+), 10 deletions(-)
 create mode 100644 src/CorruptedPathDetected.php

diff --git a/src/CorruptedPathDetected.php b/src/CorruptedPathDetected.php
new file mode 100644
index 000000000..70631ccc7
--- /dev/null
+++ b/src/CorruptedPathDetected.php
@@ -0,0 +1,13 @@
+<?php
+
+namespace League\Flysystem;
+
+use RuntimeException;
+
+final class CorruptedPathDetected extends RuntimeException implements FilesystemException
+{
+    public static function forPath(string $path): CorruptedPathDetected
+    {
+        return new CorruptedPathDetected("Corrupted path detected: " . $path);
+    }
+}
diff --git a/src/WhitespacePathNormalizer.php b/src/WhitespacePathNormalizer.php
index 83e9d3e9a..135b22a48 100644
--- a/src/WhitespacePathNormalizer.php
+++ b/src/WhitespacePathNormalizer.php
@@ -9,21 +9,16 @@ class WhitespacePathNormalizer implements PathNormalizer
     public function normalizePath(string $path): string
     {
         $path = str_replace('\\', '/', $path);
-        $path = $this->removeFunkyWhiteSpace($path);
+        $this->rejectFunkyWhiteSpace($path);
 
         return $this->normalizeRelativePath($path);
     }
 
-    private function removeFunkyWhiteSpace(string $path): string
+    private function rejectFunkyWhiteSpace(string $path): void
     {
-        // Remove unprintable characters and invalid unicode characters.
-        // We do this check in a loop, since removing invalid unicode characters
-        // can lead to new characters being created.
-        while (preg_match('#\p{C}+|^\./#u', $path)) {
-            $path = (string) preg_replace('#\p{C}+|^\./#u', '', $path);
+        if (preg_match('#\p{C}+#u', $path)) {
+            throw CorruptedPathDetected::forPath($path);
         }
-
-        return $path;
     }
 
     private function normalizeRelativePath(string $path): string
diff --git a/src/WhitespacePathNormalizerTest.php b/src/WhitespacePathNormalizerTest.php
index 62c185abd..a0288f795 100644
--- a/src/WhitespacePathNormalizerTest.php
+++ b/src/WhitespacePathNormalizerTest.php
@@ -55,7 +55,6 @@ public function pathProvider(): array
             ['example/path/..txt', 'example/path/..txt'],
             ['\\example\\path.txt', 'example/path.txt'],
             ['\\example\\..\\path.txt', 'path.txt'],
-            ["some\0/path.txt", 'some/path.txt'],
         ];
     }
 
@@ -69,6 +68,21 @@ public function guarding_against_path_traversal(string $input): void
         $this->normalizer->normalizePath($input);
     }
 
+    /**
+     * @test
+     * @dataProvider dpFunkyWhitespacePaths
+     */
+    public function rejecting_funky_whitespace(string $path): void
+    {
+        self::expectException(CorruptedPathDetected::class);
+        $this->normalizer->normalizePath($path);
+    }
+
+    public function dpFunkyWhitespacePaths(): iterable
+    {
+        return [["some\0/path.txt"], ["s\x09i.php"]];
+    }
+
     /**
      * @return array<array<string>>
      */
