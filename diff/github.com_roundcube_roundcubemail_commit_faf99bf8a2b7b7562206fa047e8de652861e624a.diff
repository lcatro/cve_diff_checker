From faf99bf8a2b7b7562206fa047e8de652861e624a Mon Sep 17 00:00:00 2001
From: Aleksander Machniak <alec@alec.pl>
Date: Tue, 31 Aug 2021 19:25:13 +0200
Subject: [PATCH] Fix XSS issue in handling attachment filename extension in
 mimetype mismatch warning (#8193)

---
 CHANGELOG                  | 1 +
 program/steps/mail/get.inc | 4 ++--
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index 7c02e83c66..26b4a1420a 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -11,6 +11,7 @@ CHANGELOG Roundcube Webmail
 - Fix handling of custom sender addresses with names (#8106)
 - Fix shift + drag'n'drop menu not working in Elastic skin with Chrome browser (#8107)
 - Fix Firefox infinate loading display on mail screen (#8128)
+- Fix XSS issue in handling attachment filename extension in mimetype mismatch warning (#8193)
 
 RELEASE 1.4.11
 --------------
diff --git a/program/steps/mail/get.inc b/program/steps/mail/get.inc
index bca4132285..8e3647f363 100644
--- a/program/steps/mail/get.inc
+++ b/program/steps/mail/get.inc
@@ -187,8 +187,8 @@ if (empty($_GET['_thumb']) && $attachment->is_valid()) {
                         $RCMAIL->gettext(array(
                                 'name' => 'attachmentvalidationerror',
                                 'vars' => array(
-                                    'expected' => $mimetype . ($file_extension ? " (.$file_extension)" : ''),
-                                    'detected' => $real_mimetype . ($extensions[0] ? " (.$extensions[0])" : ''),
+                                    'expected' => $mimetype . (!empty($file_extension) ? rcube::Q(" (.{$file_extension})") : ''),
+                                    'detected' => $real_mimetype . (!empty($extensions[0]) ? " (.{$extensions[0]})" : ''),
                                 )
                             )
                         ),
