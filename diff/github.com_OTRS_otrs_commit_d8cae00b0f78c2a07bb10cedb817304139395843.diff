From d8cae00b0f78c2a07bb10cedb817304139395843 Mon Sep 17 00:00:00 2001
From: Martin Gruner <martin.gruner@otrs.com>
Date: Mon, 3 Sep 2018 13:25:05 +0200
Subject: [PATCH] Improved AdminSupportDataCollector.

---
 Kernel/Modules/AdminServiceCenter.pm             | 16 ++++++++++++++--
 .../AdminServiceCenterSupportDataCollector.tt    |  2 +-
 2 files changed, 15 insertions(+), 3 deletions(-)

diff --git a/Kernel/Modules/AdminServiceCenter.pm b/Kernel/Modules/AdminServiceCenter.pm
index a76d2869f72..149f8efb955 100644
--- a/Kernel/Modules/AdminServiceCenter.pm
+++ b/Kernel/Modules/AdminServiceCenter.pm
@@ -277,6 +277,8 @@ sub _SupportDataCollectorView {
 sub _GenerateSupportBundle {
     my ( $Self, %Param ) = @_;
 
+    $Self->{LayoutObject}->ChallengeTokenCheck();
+
     my $RandomID = $Self->{MainObject}->GenerateRandomString(
         Length     => 8,
         Dictionary => [ 0 .. 9, 'a' .. 'f' ],
@@ -343,12 +345,22 @@ sub _GenerateSupportBundle {
 sub _DownloadSupportBundle {
     my ( $Self, %Param ) = @_;
 
+    $Self->{LayoutObject}->ChallengeTokenCheck();
+
     my $Filename = $Self->{ParamObject}->GetParam( Param => 'Filename' ) || '';
     my $RandomID = $Self->{ParamObject}->GetParam( Param => 'RandomID' ) || '';
 
-    if ( !$Filename ) {
+    # Validate simple file name.
+    if ( !$Filename || $Filename !~ m{^[a-z0-9._-]+$}smxi ) {
+        return $Self->{LayoutObject}->ErrorScreen(
+            Message => "Need Filename or Filename invalid!",
+        );
+    }
+
+    # Validate simple RandomID.
+    if ( !$RandomID || $RandomID !~ m{^[a-f0-9]+$}smx ) {
         return $Self->{LayoutObject}->ErrorScreen(
-            Message => "Need Filename!",
+            Message => "Need RandomID or RandomID invalid!",
         );
     }
 
diff --git a/Kernel/Output/HTML/Standard/AdminServiceCenterSupportDataCollector.tt b/Kernel/Output/HTML/Standard/AdminServiceCenterSupportDataCollector.tt
index d756c7191b0..d5b08002942 100644
--- a/Kernel/Output/HTML/Standard/AdminServiceCenterSupportDataCollector.tt
+++ b/Kernel/Output/HTML/Standard/AdminServiceCenterSupportDataCollector.tt
@@ -195,7 +195,7 @@
                 }
 
                 $('#DownloadSupportBundle').bind('click', function (Event) {
-                    window.location.href = '[% Env("Baselink") %]Action=[% Env("Action") %];Subaction=DownloadSupportBundle;Filename=' + Response.Filename + ';RandomID=' + Response.RandomID;
+                    window.location.href = '[% Env("Baselink") %]Action=[% Env("Action") %];Subaction=DownloadSupportBundle;Filename=' + Response.Filename + ';RandomID=' + Response.RandomID + ';ChallengeToken=' + Core.Config.Get('ChallengeToken');
                     Core.UI.Dialog.CloseDialog($('#SupportBundleOptionsDialog'));
                 });
             }
