From 563d39c327606232e480602f7b36ea6cb31bc6f7 Mon Sep 17 00:00:00 2001
From: sidler <sidler@mulchprod.de>
Date: Mon, 5 Jan 2015 09:29:16 +0100
Subject: [PATCH] BUG: / SECURITY: Fixed a possible xss injection when handling
 non-existent action-names. fixes SROEADV-2015-01.

---
 module_system/admin/class_admin_controller.php     | 7 +++----
 module_system/system/class_abstract_controller.php | 8 ++++----
 2 files changed, 7 insertions(+), 8 deletions(-)

diff --git a/module_system/admin/class_admin_controller.php b/module_system/admin/class_admin_controller.php
index c0b12331b..5a6df6a5e 100644
--- a/module_system/admin/class_admin_controller.php
+++ b/module_system/admin/class_admin_controller.php
@@ -367,13 +367,12 @@ protected function getOutputLogin() {
      */
     public function action($strAction = "") {
 
-        if($strAction == "") {
-            $strAction = $this->getAction();
-        }
-        else {
+        if($strAction != "") {
             $this->setAction($strAction);
         }
 
+        $strAction = $this->getAction();
+
         //search for the matching method - build method name
         $strMethodName = "action" . uniStrtoupper($strAction[0]) . uniSubstr($strAction, 1);
 
diff --git a/module_system/system/class_abstract_controller.php b/module_system/system/class_abstract_controller.php
index 375003cdf..f56efc37e 100644
--- a/module_system/system/class_abstract_controller.php
+++ b/module_system/system/class_abstract_controller.php
@@ -120,10 +120,10 @@ public function __construct($strSystemid = "") {
 
 
         //And keep the action
-        $this->strAction = $this->getParam("action");
+        $this->setAction($this->getParam("action"));
         //in most cases, the list is the default action if no other action was passed
-        if($this->strAction == "") {
-            $this->strAction = "list";
+        if($this->getAction() == "") {
+            $this->setAction("list");
         }
 
         //try to load the current module-name and the moduleId by reflection
@@ -197,7 +197,7 @@ public final function getAction() {
      * @return void
      */
     public final function setAction($strAction) {
-        $this->strAction = $strAction;
+        $this->strAction = htmlspecialchars(trim($strAction), ENT_QUOTES, "UTF-8", false);
     }
 
 
