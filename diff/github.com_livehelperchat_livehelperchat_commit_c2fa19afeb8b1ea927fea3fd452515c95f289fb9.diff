From c2fa19afeb8b1ea927fea3fd452515c95f289fb9 Mon Sep 17 00:00:00 2001
From: Remigijus Kiminas <remdex@gmail.com>
Date: Mon, 17 Jan 2022 00:21:40 -0500
Subject: [PATCH] CSRF tokens

---
 lhc_web/design/defaulttheme/tpl/lhchat/cannedmsgedit.tpl.php | 2 ++
 lhc_web/design/defaulttheme/tpl/lhchat/newcannedmsg.tpl.php  | 4 +++-
 lhc_web/modules/lhchat/cannedmsgedit.php                     | 5 +++++
 lhc_web/modules/lhchat/newcannedmsg.php                      | 5 +++++
 lhc_web/modules/lhgroupchat/options.php                      | 5 +++++
 lhc_web/modules/lhnotifications/settings.php                 | 5 +++++
 6 files changed, 25 insertions(+), 1 deletion(-)

diff --git a/lhc_web/design/defaulttheme/tpl/lhchat/cannedmsgedit.tpl.php b/lhc_web/design/defaulttheme/tpl/lhchat/cannedmsgedit.tpl.php
index 666c5d336..3aa702981 100644
--- a/lhc_web/design/defaulttheme/tpl/lhchat/cannedmsgedit.tpl.php
+++ b/lhc_web/design/defaulttheme/tpl/lhchat/cannedmsgedit.tpl.php
@@ -12,6 +12,8 @@
 
 <form action="<?php echo erLhcoreClassDesign::baseurl('chat/cannedmsgedit')?>/<?php echo $canned_message->id?>" method="post" onsubmit="return confirmSave()">
 
+    <?php include(erLhcoreClassDesign::designtpl('lhkernel/csfr_token.tpl.php'));?>
+
     <?php include(erLhcoreClassDesign::designtpl('lhchat/cannedmsgform.tpl.php'));?>
     
     <div class="btn-group" role="group" aria-label="...">
diff --git a/lhc_web/design/defaulttheme/tpl/lhchat/newcannedmsg.tpl.php b/lhc_web/design/defaulttheme/tpl/lhchat/newcannedmsg.tpl.php
index 16ac793bb..169f07820 100644
--- a/lhc_web/design/defaulttheme/tpl/lhchat/newcannedmsg.tpl.php
+++ b/lhc_web/design/defaulttheme/tpl/lhchat/newcannedmsg.tpl.php
@@ -5,7 +5,9 @@
 <?php endif; ?>
 
 <form action="<?php echo erLhcoreClassDesign::baseurl('chat/newcannedmsg')?>" method="post">
-    
+
+    <?php include(erLhcoreClassDesign::designtpl('lhkernel/csfr_token.tpl.php'));?>
+
     <?php include(erLhcoreClassDesign::designtpl('lhchat/cannedmsgform.tpl.php'));?>
 	
 	<div class="btn-group" role="group" aria-label="...">
diff --git a/lhc_web/modules/lhchat/cannedmsgedit.php b/lhc_web/modules/lhchat/cannedmsgedit.php
index e3ae23ff7..7a9aeeb1c 100644
--- a/lhc_web/modules/lhchat/cannedmsgedit.php
+++ b/lhc_web/modules/lhchat/cannedmsgedit.php
@@ -29,6 +29,11 @@
 
 if (isset($_POST['Update_action']) || isset($_POST['Save_action'])  )
 {
+    if (!isset($_POST['csfr_token']) || !$currentUser->validateCSFRToken($_POST['csfr_token'])) {
+        erLhcoreClassModule::redirect('chat/cannedmsg');
+        exit;
+    }
+
    $previousState = $Msg->getState();
 
    $Errors = erLhcoreClassAdminChatValidatorHelper::validateCannedMessage($Msg, $userDepartments);
diff --git a/lhc_web/modules/lhchat/newcannedmsg.php b/lhc_web/modules/lhchat/newcannedmsg.php
index dedf8df36..adf5febae 100644
--- a/lhc_web/modules/lhchat/newcannedmsg.php
+++ b/lhc_web/modules/lhchat/newcannedmsg.php
@@ -17,6 +17,11 @@
 
 if (isset($_POST['Save_action']))
 {
+    if (!isset($_POST['csfr_token']) || !$currentUser->validateCSFRToken($_POST['csfr_token'])) {
+        erLhcoreClassModule::redirect('chat/cannedmsg');
+        exit;
+    }
+
     $Errors = erLhcoreClassAdminChatValidatorHelper::validateCannedMessage($CannedMessage, $userDepartments);
 
     erLhcoreClassChatEventDispatcher::getInstance()->dispatch('chat.before_newcannedmsg', array('departments' => $userDepartments, 'scope' => 'global', 'errors' => & $Errors, 'msg' => & $CannedMessage));
diff --git a/lhc_web/modules/lhgroupchat/options.php b/lhc_web/modules/lhgroupchat/options.php
index e5659869e..4db8cdcc7 100644
--- a/lhc_web/modules/lhgroupchat/options.php
+++ b/lhc_web/modules/lhgroupchat/options.php
@@ -8,6 +8,11 @@
 
 if ( isset($_POST['StoreOptions']) ) {
 
+    if (!isset($_POST['csfr_token']) || !$currentUser->validateCSFRToken($_POST['csfr_token'])) {
+        erLhcoreClassModule::redirect('groupchat/options');
+        exit;
+    }
+
     $definition = array(
         'supervisor' => new ezcInputFormDefinitionElement(
             ezcInputFormDefinitionElement::OPTIONAL, 'int'
diff --git a/lhc_web/modules/lhnotifications/settings.php b/lhc_web/modules/lhnotifications/settings.php
index 1c4831360..2f9ee2523 100644
--- a/lhc_web/modules/lhnotifications/settings.php
+++ b/lhc_web/modules/lhnotifications/settings.php
@@ -7,6 +7,11 @@
 
 if ( isset($_POST['StoreOptions']) ) {
 
+    if (!isset($_POST['csfr_token']) || !$currentUser->validateCSFRToken($_POST['csfr_token'])) {
+        erLhcoreClassModule::redirect('notifications/index');
+        exit;
+    }
+
     $definition = array(
         'enabled' => new ezcInputFormDefinitionElement(
             ezcInputFormDefinitionElement::OPTIONAL, 'boolean'
