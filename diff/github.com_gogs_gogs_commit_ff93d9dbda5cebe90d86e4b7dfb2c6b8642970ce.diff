From ff93d9dbda5cebe90d86e4b7dfb2c6b8642970ce Mon Sep 17 00:00:00 2001
From: Unknwon <u@gogs.io>
Date: Tue, 18 Dec 2018 01:38:08 -0500
Subject: [PATCH] pkg/tool: improve SanitizePath (#5558)

---
 gogs.go               | 2 +-
 pkg/tool/path.go      | 4 +++-
 pkg/tool/path_test.go | 1 +
 templates/.VERSION    | 2 +-
 4 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/gogs.go b/gogs.go
index 8826eb1ff1..2d8350f765 100644
--- a/gogs.go
+++ b/gogs.go
@@ -16,7 +16,7 @@ import (
 	"github.com/gogs/gogs/pkg/setting"
 )
 
-const APP_VER = "0.11.81.1217"
+const APP_VER = "0.11.82.1218"
 
 func init() {
 	setting.AppVer = APP_VER
diff --git a/pkg/tool/path.go b/pkg/tool/path.go
index 3c0d2d0278..528db86df7 100644
--- a/pkg/tool/path.go
+++ b/pkg/tool/path.go
@@ -17,5 +17,7 @@ func IsSameSiteURLPath(url string) bool {
 
 // SanitizePath sanitizes user-defined file paths to prevent remote code execution.
 func SanitizePath(path string) string {
-	return strings.TrimLeft(path, "./")
+	path = strings.TrimLeft(path, "/")
+	path = strings.Replace(path, "../", "", -1)
+	return path
 }
diff --git a/pkg/tool/path_test.go b/pkg/tool/path_test.go
index c9e1829415..9f3441b115 100644
--- a/pkg/tool/path_test.go
+++ b/pkg/tool/path_test.go
@@ -38,6 +38,7 @@ func Test_SanitizePath(t *testing.T) {
 			expect string
 		}{
 			{"../../../../../../../../../data/gogs/data/sessions/a/9/a9f0ab6c3ef63dd8", "data/gogs/data/sessions/a/9/a9f0ab6c3ef63dd8"},
+			{"data/gogs/../../../../../../../../../data/sessions/a/9/a9f0ab6c3ef63dd8", "data/gogs/data/sessions/a/9/a9f0ab6c3ef63dd8"},
 
 			{"data/sessions/a/9/a9f0ab6c3ef63dd8", "data/sessions/a/9/a9f0ab6c3ef63dd8"},
 		}
diff --git a/templates/.VERSION b/templates/.VERSION
index da31b367db..9f1b25ca70 100644
--- a/templates/.VERSION
+++ b/templates/.VERSION
@@ -1 +1 @@
-0.11.81.1217
+0.11.82.1218
