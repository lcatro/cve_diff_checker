From 1334647862b0c90b2e8cb2f668e66627d9517b17 Mon Sep 17 00:00:00 2001
From: Alex Tutubalin <lexa@lexa.ru>
Date: Mon, 11 Jun 2018 13:03:24 +0300
Subject: [PATCH] parse_qt: possible integer overflow

---
 dcraw/dcraw.c             | 2 ++
 internal/dcraw_common.cpp | 2 ++
 2 files changed, 4 insertions(+)

diff --git a/dcraw/dcraw.c b/dcraw/dcraw.c
index 511a6db5..364869cf 100644
--- a/dcraw/dcraw.c
+++ b/dcraw/dcraw.c
@@ -13593,6 +13593,8 @@ void CLASS parse_qt (int end)
   while (ftell(ifp)+7 < end) {
     save = ftell(ifp);
     if ((size = get4()) < 8) return;
+    if ((int)size < 0) return; // 2+GB is too much
+    if (save + size < save) return; // 32bit overflow
     fread (tag, 4, 1, ifp);
     if (!memcmp(tag,"moov",4) ||
 	!memcmp(tag,"udta",4) ||
diff --git a/internal/dcraw_common.cpp b/internal/dcraw_common.cpp
index a3dcbcea..041318c5 100644
--- a/internal/dcraw_common.cpp
+++ b/internal/dcraw_common.cpp
@@ -12395,6 +12395,8 @@ void CLASS parse_qt (int end)
   while (ftell(ifp)+7 < end) {
     save = ftell(ifp);
     if ((size = get4()) < 8) return;
+    if ((int)size < 0) return; // 2+GB is too much
+    if (save + size < save) return; // 32bit overflow
     fread (tag, 4, 1, ifp);
     if (!memcmp(tag,"moov",4) ||
 	!memcmp(tag,"udta",4) ||
