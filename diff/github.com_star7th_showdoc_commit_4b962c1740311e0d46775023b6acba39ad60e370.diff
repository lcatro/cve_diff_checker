From db53edb8323dd358dc955e71d8f1fad5dab4ab7b Mon Sep 17 00:00:00 2001
From: Michael Rowley <michaellrowley@protonmail.com>
Date: Tue, 3 Aug 2021 18:15:28 +0100
Subject: [PATCH] CVE-2021-3678

---
 .../Api/Controller/AdminSettingController.class.php           | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/server/Application/Api/Controller/AdminSettingController.class.php b/server/Application/Api/Controller/AdminSettingController.class.php
index fc9ade20..d21bd51f 100644
--- a/server/Application/Api/Controller/AdminSettingController.class.php
+++ b/server/Application/Api/Controller/AdminSettingController.class.php
@@ -166,7 +166,7 @@ public function getLoginSecretKey(){
         $this->checkAdmin();
         $login_secret_key = D("Options")->get("login_secret_key") ;
         if(!$login_secret_key){
-            $login_secret_key = md5("rgrsfsrfsrf".time().rand(1,9000000000000000).uniqid());
+            $login_secret_key = bin2hex( random_bytes( 16 ) );
             D("Options")->set("login_secret_key",$login_secret_key) ;
         }
         $this->sendResult(array("login_secret_key"=>$login_secret_key));
@@ -176,7 +176,7 @@ public function getLoginSecretKey(){
     public function resetLoginSecretKey(){
         $login_user = $this->checkLogin();
         $this->checkAdmin();
-        $login_secret_key = md5("rgrsfsrfsrf".time().rand(1,9000000000000000).uniqid());
+        $login_secret_key = bin2hex( random_bytes( 16 ) );
         D("Options")->set("login_secret_key",$login_secret_key) ;
         $this->sendResult(array("login_secret_key"=>$login_secret_key));
 
