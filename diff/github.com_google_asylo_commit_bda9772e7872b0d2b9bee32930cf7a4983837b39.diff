From bda9772e7872b0d2b9bee32930cf7a4983837b39 Mon Sep 17 00:00:00 2001
From: Chong Cai <chongc@google.com>
Date: Fri, 25 Sep 2020 12:27:44 -0700
Subject: [PATCH] Check input length in FromLinuxSockAddr

PiperOrigin-RevId: 333785506
Change-Id: I1d68fb8954665eebc1018d80ff995cbe9e7ed6a9
---
 .../type_conversions/manual_types_functions.cc        | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/asylo/platform/system_call/type_conversions/manual_types_functions.cc b/asylo/platform/system_call/type_conversions/manual_types_functions.cc
index 7c71b0258..cba54c184 100644
--- a/asylo/platform/system_call/type_conversions/manual_types_functions.cc
+++ b/asylo/platform/system_call/type_conversions/manual_types_functions.cc
@@ -429,6 +429,10 @@ bool FromkLinuxSockAddr(const struct klinux_sockaddr *input,
 
   int16_t klinux_family = input->klinux_sa_family;
   if (klinux_family == kLinux_AF_UNIX) {
+    if (input_len < sizeof(struct klinux_sockaddr_un)) {
+      return false;
+    }
+
     struct klinux_sockaddr_un *klinux_sockaddr_un_in =
         const_cast<struct klinux_sockaddr_un *>(
             reinterpret_cast<const struct klinux_sockaddr_un *>(input));
@@ -442,6 +446,9 @@ bool FromkLinuxSockAddr(const struct klinux_sockaddr *input,
                  sizeof(klinux_sockaddr_un_in->klinux_sun_path)));
     CopySockaddr(&sockaddr_un_out, sizeof(sockaddr_un_out), output, output_len);
   } else if (klinux_family == kLinux_AF_INET) {
+    if (input_len < sizeof(struct klinux_sockaddr_in)) {
+      return false;
+    }
     struct klinux_sockaddr_in *klinux_sockaddr_in_in =
         const_cast<struct klinux_sockaddr_in *>(
             reinterpret_cast<const struct klinux_sockaddr_in *>(input));
@@ -457,6 +464,10 @@ bool FromkLinuxSockAddr(const struct klinux_sockaddr *input,
                          klinux_sockaddr_in_in->klinux_sin_zero);
     CopySockaddr(&sockaddr_in_out, sizeof(sockaddr_in_out), output, output_len);
   } else if (klinux_family == kLinux_AF_INET6) {
+    if (input_len < sizeof(struct klinux_sockaddr_in6)) {
+      return false;
+    }
+
     struct klinux_sockaddr_in6 *klinux_sockaddr_in6_in =
         const_cast<struct klinux_sockaddr_in6 *>(
             reinterpret_cast<const struct klinux_sockaddr_in6 *>(input));
