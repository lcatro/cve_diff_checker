From c57997e76ec70862174a1b3b3aeb62a6f8570e85 Mon Sep 17 00:00:00 2001
From: pancake <pancake@nopcode.org>
Date: Tue, 4 Jul 2017 19:38:33 +0200
Subject: [PATCH] Fix r2_hbo_grub_memmove ext2 crash

---
 shlr/grub/kern/disk.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/shlr/grub/kern/disk.c b/shlr/grub/kern/disk.c
index a4d3f867c0b..f93116854c6 100644
--- a/shlr/grub/kern/disk.c
+++ b/shlr/grub/kern/disk.c
@@ -449,8 +449,14 @@ grub_disk_read (grub_disk_t disk, grub_disk_addr_t sector,
       if (data)
 	{
 	  /* Just copy it!  */
-	  if (buf)
+	  if (buf) {
+	    if (pos + real_offset + len >= size) {
+              // prevent read overflow
+              grub_errno = GRUB_ERR_BAD_FS;
+              return grub_errno;
+	    }
 	    grub_memcpy (buf, data + pos + real_offset, len);
+          }
 	  grub_disk_cache_unlock (disk->dev->id, disk->id, start_sector);
 	}
       else
