From 068b8aa37f24645c62235018fb8da340f60e2d18 Mon Sep 17 00:00:00 2001
From: atutor <info@atutor.ca>
Date: Sat, 28 Feb 2015 08:50:30 -0500
Subject: [PATCH] 5566 added chech on referer to ensure it is in the pages
 array, to prevent remote access via CSRF

---
 mods/_core/users/admins/create.php | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/mods/_core/users/admins/create.php b/mods/_core/users/admins/create.php
index 2c3193b69..e8fed96c6 100644
--- a/mods/_core/users/admins/create.php
+++ b/mods/_core/users/admins/create.php
@@ -15,6 +15,13 @@
 define('AT_INCLUDE_PATH', '../../../../include/');
 require(AT_INCLUDE_PATH.'vitals.inc.php');
 admin_authenticate(AT_ADMIN_PRIV_ADMIN);
+if($_SERVER['HTTP_REFERER'] != $_SERVER['PHP_SELF']){
+    $referer_script = preg_replace('#'.$_base_href.'#', '', $_SERVER['HTTP_REFERER']);
+    if(!in_array($_pages[$referer_script], $_pages)){
+    echo "not a valid referer";
+    exit;
+    }
+}
 
 if (isset($_POST['cancel'])) {
 	$msg->addFeedback('CANCELLED');
