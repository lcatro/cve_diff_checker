From 02ac84fc82234cac9d2ad9585ceb12b75124a675 Mon Sep 17 00:00:00 2001
From: Alan Hardman <alanaktion@gmail.com>
Date: Mon, 20 Apr 2020 08:18:53 -0600
Subject: [PATCH 1/3] Disallow file upload RCE via server configuration

---
 nginx-example.conf | 28 ++++++++++------------------
 1 file changed, 10 insertions(+), 18 deletions(-)

diff --git a/nginx-example.conf b/nginx-example.conf
index ca3ba049..df495d93 100644
--- a/nginx-example.conf
+++ b/nginx-example.conf
@@ -1,6 +1,6 @@
 server {
 	listen 80;
-	#listen 443 ssl;
+	#listen 443 ssl http2;
 
 	#ssl_certificate /etc/nginx/ssl/phproject.crt;
 	#ssl_certificate_key /etc/nginx/ssl/phproject.key;
@@ -15,23 +15,8 @@ server {
 		try_files $uri $uri/ /index.php?$args;
 	}
 
-	# Disable logging of ping requests
-	location /ping {
-		access_log off;
-		try_files $uri $uri/ /index.php?$args;
-		location ~ \.php$ {
-			fastcgi_split_path_info ^(.+\.php)(/.+)$;
-			fastcgi_pass 127.0.0.1:9000;
-			fastcgi_index index.php;
-			include fastcgi_params;
-		}
-	}
-
-	location ~ \.php$ {
-		fastcgi_split_path_info ^(.+\.php)(/.+)$;
-		fastcgi_pass 127.0.0.1:9000;
-		fastcgi_index index.php;
-		include fastcgi_params;
+	location ~ ^/uploads/ {
+		expires max;
 	}
 
 	location ~ ^/app/(controller|dict|helper|model|view) {
@@ -42,5 +27,12 @@ server {
 		deny all;
 	}
 
+	location ~ \.php$ {
+		fastcgi_split_path_info ^(.+\.php)(/.+)$;
+		fastcgi_pass 127.0.0.1:9000;
+		fastcgi_index index.php;
+		include fastcgi_params;
+	}
+
 	client_max_body_size 64M;
 }

From 21643fd016bd99fe31cf4863876d01cdf73e9779 Mon Sep 17 00:00:00 2001
From: Alan Hardman <alanaktion@gmail.com>
Date: Mon, 20 Apr 2020 08:32:00 -0600
Subject: [PATCH 2/3] Block direct access to uploaded files

Direct access is not required as we use the application to proxy any access already.
---
 nginx-example.conf | 8 +++-----
 uploads/.gitignore | 1 +
 uploads/.htaccess  | 1 +
 3 files changed, 5 insertions(+), 5 deletions(-)
 create mode 100644 uploads/.htaccess

diff --git a/nginx-example.conf b/nginx-example.conf
index df495d93..d7e34336 100644
--- a/nginx-example.conf
+++ b/nginx-example.conf
@@ -15,14 +15,12 @@ server {
 		try_files $uri $uri/ /index.php?$args;
 	}
 
-	location ~ ^/uploads/ {
-		expires max;
-	}
-
 	location ~ ^/app/(controller|dict|helper|model|view) {
 		deny all;
 	}
-
+	location ~ ^/uploads/ {
+		deny all;
+	}
 	location ~ /\.ht {
 		deny all;
 	}
diff --git a/uploads/.gitignore b/uploads/.gitignore
index 72e8ffc0..651aa3a8 100644
--- a/uploads/.gitignore
+++ b/uploads/.gitignore
@@ -1 +1,2 @@
 *
+!.htaccess
diff --git a/uploads/.htaccess b/uploads/.htaccess
new file mode 100644
index 00000000..3a428827
--- /dev/null
+++ b/uploads/.htaccess
@@ -0,0 +1 @@
+Deny from all

From e61283841d25b4fbc9abb2585e71d6152cdcbc04 Mon Sep 17 00:00:00 2001
From: Alan Hardman <alanaktion@gmail.com>
Date: Mon, 20 Apr 2020 09:53:28 -0600
Subject: [PATCH 3/3] Limit uploaded file types via configurable blacklist

This adds a new configuration option that matches uploaded file names to prevent them from being uploaded to issues.
---
 app/controller/issues.php | 8 ++++++++
 app/controller/user.php   | 2 +-
 db/20.04.20.sql           | 1 +
 db/database.sql           | 3 ++-
 4 files changed, 12 insertions(+), 2 deletions(-)
 create mode 100644 db/20.04.20.sql

diff --git a/app/controller/issues.php b/app/controller/issues.php
index bd129184..2aacc403 100644
--- a/app/controller/issues.php
+++ b/app/controller/issues.php
@@ -1187,6 +1187,14 @@ public function upload($f3)
         $orig_name = preg_replace("/[^A-Z0-9._-]/i", "_", $_FILES['attachment']['name']);
         $_FILES['attachment']['name'] = time() . "_" . $orig_name;
 
+        // Blacklist certain file types
+        if ($f3->get('security.file_blacklist')) {
+            if (preg_match($f3->get('security.file_blacklist'), $orig_name)) {
+                $f3->error(415);
+                return;
+            }
+        }
+
         $i = 0;
         $parts = pathinfo($_FILES['attachment']['name']);
         while (file_exists($f3->get("UPLOADS") . $_FILES['attachment']['name'])) {
diff --git a/app/controller/user.php b/app/controller/user.php
index 1b569c61..5c7741c3 100644
--- a/app/controller/user.php
+++ b/app/controller/user.php
@@ -261,7 +261,7 @@ public function avatar($f3)
         $finfo = finfo_open(FILEINFO_MIME_TYPE);
         $allowedTypes = ['image/jpeg', 'image/gif', 'image/png', 'image/bmp'];
         if (!in_array(finfo_file($finfo, $_FILES['avatar']['tmp_name']), $allowedTypes)) {
-            $f3->error(400);
+            $f3->error(415);
             return;
         }
         finfo_close($finfo);
diff --git a/db/20.04.20.sql b/db/20.04.20.sql
new file mode 100644
index 00000000..a259583c
--- /dev/null
+++ b/db/20.04.20.sql
@@ -0,0 +1 @@
+INSERT INTO `config` (`attribute`,`value`) VALUES ('security.file_blacklist', '/\.(ph(p([3457s]|\-s)?|t|tml)|aspx?|shtml|exe|dll)$/i');
diff --git a/db/database.sql b/db/database.sql
index a2a74c1c..598660f4 100644
--- a/db/database.sql
+++ b/db/database.sql
@@ -323,4 +323,5 @@ CREATE TABLE `config` (
 );
 
 INSERT INTO `config` (`attribute`,`value`) VALUES ('security.reset_ttl', '86400');
-INSERT INTO `config` (`attribute`, `value`) VALUES ('version', '18.02.19');
+INSERT INTO `config` (`attribute`,`value`) VALUES ('security.file_blacklist', '/\.(ph(p([3457s]|\-s)?|t|tml)|aspx?|shtml|exe|dll)$/i');
+INSERT INTO `config` (`attribute`, `value`) VALUES ('version', '20.04.20');
