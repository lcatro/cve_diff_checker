From 45a7a62797e64e8abbae35d4859097c26f1874b1 Mon Sep 17 00:00:00 2001
From: dleffler <dleffler@hughes.net>
Date: Tue, 25 Oct 2016 08:36:04 -0400
Subject: [PATCH] regression fix last vulnerability fix for sanitizing
 order/direction params

---
 framework/core/subsystems/expPaginator.php | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/framework/core/subsystems/expPaginator.php b/framework/core/subsystems/expPaginator.php
index 3db6b07c5b..2b504cf468 100755
--- a/framework/core/subsystems/expPaginator.php
+++ b/framework/core/subsystems/expPaginator.php
@@ -118,7 +118,8 @@ public function __construct($params=array()) {
 		$this->controller = empty($params['controller']) ? '' : $params['controller'];
 		$this->sql = empty($params['sql']) ? '' : $params['sql'];
         $this->count_sql = empty($params['count_sql']) ? '' : $params['count_sql'];
-        $this->order = empty($params['order']) ? 'id' : preg_replace('/[^a-z\_]/i','',$params['order']);
+//        $this->order = empty($params['order']) ? 'id' : preg_replace('/[^a-zAZ_]/','',$params['order']);
+        $this->order = empty($params['order']) ? 'id' : expString::escape($params['order']);
 		$this->dir = empty($params['dir']) || !in_array($params['dir'], array('ASC', 'DESC')) ? 'ASC' : $params['dir'];
 		$this->src = empty($params['src']) ? null : expString::escape($params['src']);
         $this->categorize = empty($params['categorize']) ? false : $params['categorize'];
@@ -180,7 +181,8 @@ public function __construct($params=array()) {
             $this->order = $orderby[0];
             $this->order_direction = $orderby[1];
         }
-        if(!preg_match('/[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*/', $this->order))
+        // filter out invalid order & direction
+        if(preg_match('/[^a-zA-Z_][^a-zA-Z0-9_]*/', $this->order))
             $this->order = 'id';
         if (!in_array($this->order_direction, array('ASC', 'DESC')))
             $this->order_direction = 'ASC';
