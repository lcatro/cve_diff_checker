From e14008ca029d644e2486873fa22629a1d62a7380 Mon Sep 17 00:00:00 2001
From: Karson <karsonzhang@163.com>
Date: Fri, 27 Dec 2019 12:09:20 +0800
Subject: [PATCH] =?UTF-8?q?=E4=BF=AE=E5=A4=8D=E9=82=AE=E7=AE=B1=E9=AA=8C?=
 =?UTF-8?q?=E8=AF=81=E7=A0=81=E9=94=99=E8=AF=AF=20=E4=BF=AE=E5=A4=8D?=
 =?UTF-8?q?=E6=8E=92=E5=BA=8F=E8=A1=A8=E5=90=8D=E5=AE=89=E5=85=A8=E6=A3=80?=
 =?UTF-8?q?=E6=B5=8B=20=E4=BF=AE=E5=A4=8DSelectpage=E7=BC=96=E8=BE=91?=
 =?UTF-8?q?=E6=97=B6=E5=88=86=E9=A1=B5=E5=A4=A7=E5=B0=8F=E9=94=99=E8=AF=AF?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 application/admin/controller/Ajax.php     | 13 ++++++++++---
 application/common/controller/Backend.php |  1 +
 application/index/controller/User.php     |  2 +-
 3 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/application/admin/controller/Ajax.php b/application/admin/controller/Ajax.php
index 3ec4a126..5b9ac592 100644
--- a/application/admin/controller/Ajax.php
+++ b/application/admin/controller/Ajax.php
@@ -9,6 +9,7 @@
 use think\Config;
 use think\Db;
 use think\Lang;
+use think\Validate;
 
 /**
  * Ajax异步请求接口
@@ -155,6 +156,9 @@ public function weigh()
         $field = $this->request->post("field");
         //操作的数据表
         $table = $this->request->post("table");
+        if (!Validate::is($table, "alphaDash")) {
+            $this->error();
+        }
         //主键
         $pk = $this->request->post("pk");
         //排序的方式
@@ -214,16 +218,19 @@ public function wipecache()
             case 'content':
                 rmdirs(CACHE_PATH, false);
                 Cache::clear();
-                if ($type == 'content')
+                if ($type == 'content') {
                     break;
+                }
             case 'template':
                 rmdirs(TEMP_PATH, false);
-                if ($type == 'template')
+                if ($type == 'template') {
                     break;
+                }
             case 'addons':
                 Service::refresh();
-                if ($type == 'addons')
+                if ($type == 'addons') {
                     break;
+                }
         }
 
         \think\Hook::listen("wipecache_after");
diff --git a/application/common/controller/Backend.php b/application/common/controller/Backend.php
index 8e3474b9..896e0ae8 100644
--- a/application/common/controller/Backend.php
+++ b/application/common/controller/Backend.php
@@ -451,6 +451,7 @@ protected function selectpage()
         //如果有primaryvalue,说明当前是初始化传值
         if ($primaryvalue !== null) {
             $where = [$primarykey => ['in', $primaryvalue]];
+            $pagesize = null;
         } else {
             $where = function ($query) use ($word, $andor, $field, $searchfield, $custom) {
                 $logic = $andor == 'AND' ? '&' : '|';
diff --git a/application/index/controller/User.php b/application/index/controller/User.php
index 46bc2c6b..2f1dc836 100644
--- a/application/index/controller/User.php
+++ b/application/index/controller/User.php
@@ -119,7 +119,7 @@ public function register()
                 if ($captchaType == 'mobile') {
                     $captchaResult = Sms::check($mobile, $captcha, 'register');
                 } elseif ($captchaType == 'email') {
-                    $captchaResult = Ems::check($mobile, $captcha, 'register');
+                    $captchaResult = Ems::check($email, $captcha, 'register');
                 } elseif ($captchaType == 'wechat') {
                     $captchaResult = WechatCaptcha::check($captcha, 'register');
                 } elseif ($captchaType == 'text') {
